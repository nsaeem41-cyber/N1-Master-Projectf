<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | ØµÙŠØ§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Ù„ÙˆØ­Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© ================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a; color: #e0e0e0;
            margin: 0; padding: 0; overflow-x: hidden;
            user-select: none;
        }

        .header {
            background: #111; padding: 20px 30px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 2px solid #d4af37; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .brand { font-size: 24px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold { color: #d4af37; }

        .btn-back {
            background: #222; color: #ddd; border: 1px solid #444;
            padding: 8px 20px; border-radius: 8px; cursor: pointer; text-decoration: none;
            font-weight: bold; transition: 0.3s;
        }
        .btn-back:hover { background: #333; color: white; }

        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }

        /* Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± */
        .health-dashboard {
            background: #151515; padding: 30px; border-radius: 15px;
            border: 1px solid #333; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .health-title { font-size: 20px; font-weight: bold; color: #d4af37; margin-bottom: 20px; }
        
        .progress-wrapper { width: 100%; background: #222; border-radius: 10px; height: 25px; margin-bottom: 10px; overflow: hidden; border: 1px solid #444; }
        .progress-bar { height: 100%; background: #2e7d32; width: 0%; transition: width 1s ease-in-out, background 0.5s; }
        
        .health-stats { display: flex; justify-content: space-between; font-size: 13px; color: #aaa; }

        /* Ø´Ø¨ÙƒØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙŠØ§Ù†Ø© */
        .tools-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
        }

        .tool-card {
            background: #151515; padding: 25px; border-radius: 15px;
            border: 1px solid #222; text-align: center; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .tool-card:hover { border-color: #d4af37; transform: translateY(-5px); }
        
        .tool-icon { font-size: 40px; margin-bottom: 15px; }
        .tool-title { font-size: 18px; font-weight: bold; color: white; margin-bottom: 10px; }
        .tool-desc { font-size: 13px; color: #888; margin-bottom: 25px; line-height: 1.5; }

        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-size: 15px; font-weight: bold; cursor: pointer; color: white;
            transition: 0.3s;
        }
        .btn-backup { background: #1a237e; }
        .btn-backup:hover { background: #283593; }
        
        .btn-archive { background: #e65100; }
        .btn-archive:hover { background: #ef6c00; }
        
        .btn-clean { background: #2e7d32; }
        .btn-clean:hover { background: #388e3c; }

        #loader-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .loader-text { color: #d4af37; font-size: 20px; font-weight: bold; margin-top: 20px; }
        
        .status-msg { margin-top: 15px; font-size: 13px; font-weight: bold; display: none; }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div style="font-size: 50px;">âš™ï¸</div>
        <div class="loader-text" id="loader-msg">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>
    </div>

    <div class="header">
        <div class="brand">N <span class="gold">One</span> Maintenance</div>
        <a href="admin.html" class="btn-back">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© â¬…ï¸</a>
    </div>

    <div class="container">
        
        <div class="health-dashboard">
            <div class="health-title">ğŸ“Š Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</div>
            <div class="progress-wrapper">
                <div class="progress-bar" id="server-load-bar"></div>
            </div>
            <div class="health-stats">
                <span id="load-text">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 0%</span>
                <span id="rows-count">Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© 0 / 10000</span>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#666;">
                Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ© Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± â˜ºï¸
            </div>
        </div>

        <div class="tools-grid">
            
            <div class="tool-card">
                <div class="tool-icon">ğŸ’¾</div>
                <div class="tool-title">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</div>
                <div class="tool-desc">ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø¢Ù…Ù†Ø© ÙˆÙ…ÙØ±ØºØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ…Ù„Ù JSON Ù…Ø´ÙØ±</div>
                <button class="btn-action btn-backup" onclick="backupData()">Ø³Ø­Ø¨ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ğŸš€</button>
                <div id="backup-msg" class="status-msg" style="color:#64b5f6;"></div>
            </div>

            <div class="tool-card">
                <div class="tool-icon">ğŸ“¦</div>
                <div class="tool-title">Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</div>
                <div class="tool-desc">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø¶ØºØ· ÙˆØªØ³Ø±ÙŠØ¹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                <button class="btn-action btn-archive" onclick="autoArchive()">Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØ§Ù„ØªÙØ±ÙŠØº ğŸš€</button>
                <div id="archive-msg" class="status-msg" style="color:#ffb74d;"></div>
            </div>

            <div class="tool-card">
                <div class="tool-icon">ğŸ§¹</div>
                <div class="tool-title">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙŠØªØ©</div>
                <div class="tool-desc">Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ÙˆØ§Ù„Ø´ÙˆØ§Ø¦Ø¨ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø©</div>
                <button class="btn-action btn-clean" onclick="cleanMemory()">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¢Ù† ğŸš€</button>
                <div id="clean-msg" class="status-msg" style="color:#81c784;"></div>
            </div>

        </div>
    </div>

    <script>
        // ğŸ’ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„ÙƒÙŠ ğŸ’
        const API_URL = "https://script.google.com/macros/s/AKfycbzKQKytFxtHRh1J6tG2GHJjJVl5I2Iz0eYomc963sqn-V8M4Vd3t3Hmm6daykMWUjHj/exec";
        
        let systemData = [];

        window.onload = async function() {
            // Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ§Ù„Ø²Ø± Ø§Ù„Ø®Ù„ÙÙŠ
            window.history.pushState(null, "", window.location.href);
            window.onpopstate = function() {
                window.history.pushState(null, "", window.location.href);
            };

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø¹Ù…Ù‚ Ù…Ù† Ø§Ù„ØªØ´ÙÙŠØ±
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || user.role !== 'admin' || !user.sessionToken || !user.sessionToken.includes('N1_SECURE')) {
                window.location.replace('index.html');
                return;
            }
            
            await fetchHealthStatus();
        };

        // Ø¯Ø§Ù„Ø© Ù‚Ø±Ø§Ø¡Ø© ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ±
        async function fetchHealthStatus() {
            showLoader("Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ù†Ø¨Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ± â³");
            try {
                const res = await fetch(API_URL + "?action=read");
                systemData = await res.json();
                
                const totalRows = systemData.length;
                const maxRows = 10000; // Ø§Ù„Ø­Ø¯ Ø§Ù„Ø¢Ù…Ù† Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡ Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡
                let percentage = (totalRows / maxRows) * 100;
                if(percentage > 100) percentage = 100;

                const bar = document.getElementById('server-load-bar');
                bar.style.width = percentage + '%';
                
                // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø¤Ø´Ø± Ø­Ø³Ø¨ Ø§Ù„Ø¶ØºØ·
                if(percentage < 50) bar.style.background = "#2e7d32"; 
                else if(percentage < 80) bar.style.background = "#f57f17"; 
                else bar.style.background = "#c62828"; 

                document.getElementById('load-text').innerText = `Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ${percentage.toFixed(1)}%`;
                document.getElementById('rows-count').innerText = `Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ${totalRows} / ${maxRows}`;
                
            } catch (e) {
                console.error(e);
            } finally {
                hideLoader();
            }
        }

        // 1. Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ
        function backupData() {
            if(systemData.length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø¨ â˜ºï¸");
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(systemData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "N_One_Backup_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            const msg = document.getElementById('backup-msg');
            msg.innerText = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ â˜ºï¸âœ…";
            msg.style.display = "block";
            setTimeout(() => msg.style.display = "none", 4000);
        }

        // 2. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ø°ÙƒÙŠØ© (ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø¹Ø¯ Ø­ÙØ¸Ù‡Ø§)
        async function autoArchive() {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø³ÙŠØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø³ÙŠØ±ÙØ± â˜ºï¸")) return;
            
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙ‚Ø· Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„ÙƒØ¨Ø§ØªÙ†
            const ordersToArchive = systemData.filter(item => item.type === 'order');
            
            if(ordersToArchive.length === 0) {
                alert("Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ø¸ÙŠÙ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø£Ø±Ø´ÙØ© â˜ºï¸");
                return;
            }

            // Ø£ÙˆÙ„Ø§ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹Ù‡Ø§
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(ordersToArchive, null, 2));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", "Archive_Orders_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(dlNode);
            dlNode.click();
            dlNode.remove();

            showLoader("Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© â³");

            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø­Ø°Ù Ù„Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø´ÙƒÙ„ Ù…ØªØªØ§Ù„ÙŠ ÙˆÙ…Ø¯Ø±ÙˆØ³
                for(let i = 0; i < ordersToArchive.length; i++) {
                    const orderId = ordersToArchive[i].id;
                    await fetch(API_URL + "?action=delete&user=" + orderId, { method: 'POST', mode: 'no-cors' });
                }
                
                const msg = document.getElementById('archive-msg');
                msg.innerText = "ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØªÙØ±ÙŠØº Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­ â˜ºï¸âœ…";
                msg.style.display = "block";
                setTimeout(() => msg.style.display = "none", 4000);
                
                await fetchHealthStatus(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª

            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙØ±ÙŠØº â˜ºï¸");
            } finally {
                hideLoader();
            }
        }

        // 3. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙŠØªØ©
        function cleanMemory() {
            // Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ Ø¹Ø¯Ø§ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø¯ÙŠØ±
            const current = localStorage.getItem('currentUser');
            localStorage.clear();
            sessionStorage.clear();
            if(current) localStorage.setItem('currentUser', current);

            const msg = document.getElementById('clean-msg');
            msg.innerText = "ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´ÙˆØ§Ø¦Ø¨ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙŠØªØ© â˜ºï¸âœ…";
            msg.style.display = "block";
            setTimeout(() => msg.style.display = "none", 4000);
        }

        function showLoader(text) {
            document.getElementById('loader-msg').innerText = text;
            document.getElementById('loader-overlay').style.display = 'flex';
        }

        function hideLoader() {
            document.getElementById('loader-overlay').style.display = 'none';
        }
    </script>

</body>
</html>
