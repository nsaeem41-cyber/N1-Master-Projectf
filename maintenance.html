<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | ØµÙŠØ§Ù†Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠØ©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a; color: #e0e0e0;
            margin: 0; padding: 0; overflow-x: hidden;
            user-select: none;
        }

        .header {
            background: #111; padding: 20px 30px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 2px solid #d4af37; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .brand { font-size: 24px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold { color: #d4af37; }

        .btn-back {
            background: #222; color: #ddd; border: 1px solid #444;
            padding: 8px 20px; border-radius: 8px; cursor: pointer; text-decoration: none;
            font-weight: bold; transition: 0.3s;
        }
        .btn-back:hover { background: #333; color: white; }

        .container { max-width: 1000px; margin: 40px auto; padding: 0 20px; }

        .health-dashboard {
            background: #151515; padding: 30px; border-radius: 15px;
            border: 1px solid #333; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .health-title { font-size: 20px; font-weight: bold; color: #d4af37; margin-bottom: 20px; }
        
        .progress-wrapper { width: 100%; background: #222; border-radius: 10px; height: 25px; margin-bottom: 10px; overflow: hidden; border: 1px solid #444; }
        .progress-bar { height: 100%; background: #2e7d32; width: 0%; transition: width 1s ease-in-out, background 0.5s; }
        
        .health-stats { display: flex; justify-content: space-between; font-size: 13px; color: #aaa; }

        .tools-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;
        }

        .tool-card {
            background: #151515; padding: 25px; border-radius: 15px;
            border: 1px solid #222; text-align: center; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .tool-card:hover { border-color: #d4af37; transform: translateY(-5px); }
        
        .tool-icon { font-size: 40px; margin-bottom: 15px; }
        .tool-title { font-size: 18px; font-weight: bold; color: white; margin-bottom: 10px; }
        .tool-desc { font-size: 13px; color: #888; margin-bottom: 25px; line-height: 1.5; }

        .btn-action {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-size: 15px; font-weight: bold; cursor: pointer; color: white;
            transition: 0.3s;
        }
        .btn-backup { background: #1a237e; }
        .btn-backup:hover { background: #283593; }
        
        .btn-archive { background: #e65100; }
        .btn-archive:hover { background: #ef6c00; }
        
        .btn-clean { background: #2e7d32; }
        .btn-clean:hover { background: #388e3c; }

        .btn-doctor { background: #0277bd; }
        .btn-doctor:hover { background: #01579b; }

        .btn-alert { background: #d32f2f; }
        .btn-alert:hover { background: #c62828; }

        .btn-analytics { background: #6a1b9a; }
        .btn-analytics:hover { background: #4a148c; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© */
        .btn-purge { background: #00838f; }
        .btn-purge:hover { background: #006064; }

        #loader-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .loader-text { color: #d4af37; font-size: 20px; font-weight: bold; margin-top: 20px; }
        
        .status-msg { margin-top: 15px; font-size: 13px; font-weight: bold; display: none; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) Ù„Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ø¥Ù†Ø°Ø§Ø±Ø§Øª */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 4000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #151515; padding: 30px; border-radius: 15px; border: 1px solid #d4af37;
            max-width: 500px; width: 90%; color: white; text-align: right; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-height: 80vh; overflow-y: auto;
        }
        .modal-header { font-size: 20px; font-weight: bold; color: #d4af37; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        .close-modal { cursor: pointer; color: #aaa; font-size: 20px; }
        .close-modal:hover { color: white; }
        .analytics-item { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #333; }
        .analytics-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        .analytics-value { font-size: 18px; font-weight: bold; color: #d4af37; }
        .alert-item { background: rgba(211, 47, 47, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid rgba(211, 47, 47, 0.5); }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div style="font-size: 50px;">âš™ï¸</div>
        <div class="loader-text" id="loader-msg">Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø³ÙŠØ±ÙØ±...</div>
    </div>

    <div id="analytics-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>ğŸ“ˆ Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
                <span class="close-modal" onclick="closeModal('analytics-modal')">âœ•</span>
            </div>
            <div id="analytics-results">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...</div>
        </div>
    </div>

    <div id="alerts-modal" class="modal-overlay">
        <div class="modal-content" style="border-color: #d32f2f;">
            <div class="modal-header" style="color: #d32f2f;">
                <span>ğŸš¨ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ±</span>
                <span class="close-modal" onclick="closeModal('alerts-modal')">âœ•</span>
            </div>
            <div id="alerts-results">Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...</div>
        </div>
    </div>

    <div class="header">
        <div class="brand">N <span class="gold">One</span> Maintenance</div>
        <a href="admin.html" class="btn-back">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© â¬…ï¸</a>
    </div>

    <div class="container">
        
        <div class="health-dashboard">
            <div class="health-title">ğŸ“Š Ù…Ø¤Ø´Ø± ØµØ­Ø© Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</div>
            <div class="progress-wrapper">
                <div class="progress-bar" id="server-load-bar"></div>
            </div>
            <div class="health-stats">
                <span id="load-text">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 0%</span>
                <span id="rows-count">Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© 0 / 10000</span>
            </div>
            <div style="margin-top:15px; font-size:12px; color:#666;">
                Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ© Ø·Ø§Ù„Ù…Ø§ Ø§Ù„Ù…Ø¤Ø´Ø± Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø®Ø¶Ø± â˜ºï¸
            </div>
        </div>

        <div class="tools-grid">
            
            <div class="tool-card">
                <div class="tool-icon">ğŸ‘¨â€âš•ï¸</div>
                <div class="tool-title">Ø·Ø¨ÙŠØ¨ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„ (Data Doctor)</div>
                <div class="tool-desc">Ø¥ØµÙ„Ø§Ø­ Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØµÙ„Ø¨Ø© ÙˆØªØ­Ø¯ÙŠØ« Ù…Ø³Ù…ÙŠØ§Øª Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ø·Ø±Ø¯ Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ù…Ø¯Ø© ÙˆØ¹Ø²Ù„Ù‡Ø§</div>
                <button class="btn-action btn-doctor" onclick="runDataDoctor()">Ø¨Ø¯Ø¡ Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­ ğŸš€</button>
                <div id="doctor-msg" class="status-msg" style="color:#29b6f6;"></div>
            </div>

            <div class="tool-card">
                <div class="tool-icon">ğŸš¨</div>
                <div class="tool-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ± (Smart Alert)</div>
                <div class="tool-desc">ÙØ­Øµ ÙÙˆØ±ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙÙŠ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§ÙƒØªØ´Ø§Ù Ø§Ù„ØªØ£Ø®ÙŠØ±Ø§Øª Ù„ØªØ¯Ø®Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¨ÙƒÙ„ Ø±Ù‚ÙŠ</div>
                <button class="btn-action btn-alert" onclick="runSmartAlerts()">ÙØ­Øµ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø¢Ù† ğŸš€</button>
            </div>

            <div class="tool-card">
                <div class="tool-icon">ğŸ“ˆ</div>
                <div class="tool-title">Ù…Ø­Ù„Ù„ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ (Performance Analytics)</div>
                <div class="tool-desc">ØªÙ‚Ø±ÙŠØ± ÙÙˆØ±ÙŠ Ø¹Ù† Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø§Ù„ÙƒØ¨Ø§ØªÙ† ÙˆØ£ÙƒØ«Ø± Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ù†Ø´Ø§Ø·Ø§Ù‹ Ù„Ø¯Ø¹Ù…Ù‡Ù… Ø¨Ø§Ù„Ø­ÙˆØ§ÙØ² Ø§Ù„Ù…Ø¬Ù†ÙˆÙ†Ø©</div>
                <button class="btn-action btn-analytics" onclick="runPerformanceAnalytics()">ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸš€</button>
            </div>

            <div class="tool-card">
                <div class="tool-icon">ğŸ’¾</div>
                <div class="tool-title">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</div>
                <div class="tool-desc">ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø¢Ù…Ù†Ø© ÙˆÙ…ÙØ±ØºØ© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© ÙˆØ§Ù„Ø´Ø±ÙƒØ§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª ÙƒÙ…Ù„Ù JSON Ù…Ø´ÙØ±</div>
                <button class="btn-action btn-backup" onclick="backupData()">Ø³Ø­Ø¨ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ğŸš€</button>
                <div id="backup-msg" class="status-msg" style="color:#64b5f6;"></div>
            </div>

            <div class="tool-card">
                <div class="tool-icon">ğŸ“¦</div>
                <div class="tool-title">Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø§Ù„Ø°ÙƒÙŠØ©</div>
                <div class="tool-desc">ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© ÙˆØ­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø¶ØºØ· ÙˆØªØ³Ø±ÙŠØ¹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                <button class="btn-action btn-archive" onclick="autoArchive()">Ø¨Ø¯Ø¡ Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØ§Ù„ØªÙØ±ÙŠØº ğŸš€</button>
                <div id="archive-msg" class="status-msg" style="color:#ffb74d;"></div>
            </div>

            <div class="tool-card">
                <div class="tool-icon">ğŸ§¹</div>
                <div class="tool-title">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙŠØªØ©</div>
                <div class="tool-desc">Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© ÙˆØ§Ù„Ø´ÙˆØ§Ø¦Ø¨ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø©</div>
                <button class="btn-action btn-clean" onclick="cleanMemory()">ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ø¢Ù† ğŸš€</button>
                <div id="clean-msg" class="status-msg" style="color:#81c784;"></div>
            </div>

            <div class="tool-card" style="border-top: 4px solid #00e5ff;">
                <div class="tool-icon">ğŸ’</div>
                <div class="tool-title">Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© (Smart Purge)</div>
                <div class="tool-desc">ÙÙ„ØªØ±Ø© Ø°ÙƒÙŠØ© Ù„Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ø¬Ø±Ø³ ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø£Ø³Ø·Ø± ÙˆØ¥Ø¨Ù‚Ø§Ø¡ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø³ØªØ¹Ø¯Ø§Ù‹ Ù„Ù„Ø¶ØºØ· Ø§Ù„Ø¹Ø§Ù„ÙŠ</div>
                <button class="btn-action btn-purge" onclick="runDiamondPurge()">ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© ğŸš€</button>
                <div id="purge-msg" class="status-msg" style="color:#00e5ff;"></div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, onValue, get, update, remove } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2dqEdbq5cN49leWIcjsTAq6l6KavN_sQ",
            authDomain: "n-one-global.firebaseapp.com",
            databaseURL: "https://n-one-global-default-rtdb.firebaseio.com",
            projectId: "n-one-global",
            storageBucket: "n-one-global.firebasestorage.app",
            messagingSenderId: "627262885530",
            appId: "1:627262885530:web:bc0ae0d748c61ed91b5923"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let systemData = {};
        let myMaster = null;

        window.onload = async function() {
            window.history.pushState(null, "", window.location.href);
            window.onpopstate = function() {
                window.history.pushState(null, "", window.location.href);
            };

            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || user.role !== 'admin') {
                window.location.replace('index.html');
                return;
            }
            myMaster = user.Client_User || user.user;
            
            await fetchHealthStatus();
            setupRealtimeFreezeListener();
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨ØµÙ…Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆÙƒÙ„ Ø³Ø§Ø¹Ø©
            runDiamondPurge(true);
            setInterval(() => runDiamondPurge(true), 3600000);
        };

        function setupRealtimeFreezeListener() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if(!user || !user.user) return;
            const myRef = ref(db, `users/${user.user}`);
            onValue(myRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.status === 'paused' || data.Client_Status === 'paused') {
                        alert("ØªÙ… ØªØ¬Ù…ÙŠØ¯ Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©");
                        localStorage.clear();
                        window.location.replace('index.html');
                    }
                }
            });
        }

        window.fetchHealthStatus = async function() {
            showLoader("Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ù†Ø¨Ø¶ Ø§Ù„Ø³ÙŠØ±ÙØ± â³");
            try {
                const snapshot = await get(ref(db));
                if (snapshot.exists()) {
                    systemData = snapshot.val();
                    
                    let totalRows = 0;
                    if(systemData.users) totalRows += Object.keys(systemData.users).length;
                    if(systemData.shops) totalRows += Object.keys(systemData.shops).length;
                    if(systemData.captains) totalRows += Object.keys(systemData.captains).length; // ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØ¨Ø§ØªÙ†
                    if(systemData.orders) totalRows += Object.keys(systemData.orders).length;
                    if(systemData.prices) totalRows += Object.keys(systemData.prices).length;
                    if(systemData.radar_history) totalRows += Object.keys(systemData.radar_history).length;
                    if(systemData.assigned_orders) totalRows += Object.keys(systemData.assigned_orders).length; // ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©

                    const maxRows = 10000; 
                    let percentage = (totalRows / maxRows) * 100;
                    if(percentage > 100) percentage = 100;

                    const bar = document.getElementById('server-load-bar');
                    bar.style.width = percentage + '%';
                    
                    if(percentage < 50) bar.style.background = "#2e7d32"; 
                    else if(percentage < 80) bar.style.background = "#f57f17"; 
                    else bar.style.background = "#c62828"; 

                    document.getElementById('load-text').innerText = `Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ${percentage.toFixed(1)}%`;
                    document.getElementById('rows-count').innerText = `Ø§Ù„Ø£Ø³Ø·Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© ${totalRows} / ${maxRows}`;
                }
            } catch (e) {
                console.error(e);
            } finally {
                hideLoader();
            }
        }

        window.runDataDoctor = async function() {
            if(!confirm("Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¨ÙØ­Øµ ÙˆØµÙŠØ§Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØµÙ„Ø¨Ø© Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± â˜ºï¸")) return;
            
            showLoader("Ø¬Ø§Ø±ÙŠ Ø¥Ø¬Ø±Ø§Ø¡ Ø¬Ø±Ø§Ø­Ø© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ â³");
            
            try {
                if(systemData.users) {
                    const updates = {};
                    Object.keys(systemData.users).forEach(key => {
                        const u = systemData.users[key];
                        const nameToSync = u.name || u.Client_Name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
                        let finalExpiry = u.expiry || u.Client_Expiry;
                        
                        if (finalExpiry === "2026-12-31" && u.plan_days) {
                            const newDate = new Date();
                            newDate.setDate(newDate.getDate() + parseInt(u.plan_days));
                            finalExpiry = newDate.toISOString().split('T')[0];
                        }
                        
                        updates[`users/${key}/Client_Name`] = nameToSync;
                        updates[`users/${key}/name`] = nameToSync;
                        updates[`users/${key}/expiry`] = finalExpiry;
                        updates[`users/${key}/Client_Expiry`] = finalExpiry;
                        
                        const statusToSync = u.status || u.Client_Status || 'active';
                        updates[`users/${key}/status`] = statusToSync;
                        updates[`users/${key}/Client_Status`] = statusToSync;
                        
                        if (statusToSync === 'paused') {
                            updates[`users/${key}/force_logout`] = true;
                        }
                    });
                    
                    await update(ref(db), updates);
                }

                const msg = document.getElementById('doctor-msg');
                msg.innerText = "ØªÙ…Øª Ø§Ù„ØµÙŠØ§Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£ØµØ¨Ø­Øª Ø¯Ù‚ÙŠÙ‚Ø© â˜ºï¸âœ…";
                msg.style.display = "block";
                setTimeout(() => msg.style.display = "none", 4000);
                
                await fetchHealthStatus(); 

            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØ­Øµ ÙˆØ§Ù„ØµÙŠØ§Ù†Ø© â˜ºï¸");
                console.error(error);
            } finally {
                hideLoader();
            }
        }

        // ================= Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…Ø¬Ù†ÙˆÙ†Ø©: Ø§Ù„Ø¥Ù†Ø°Ø§Ø± Ø§Ù„Ù…Ø¨ÙƒØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª ================= //

        window.runSmartAlerts = async function() {
            showLoader("Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø±Ø§Ø¯Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© â³");
            await fetchHealthStatus(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            
            const alertsContainer = document.getElementById('alerts-results');
            alertsContainer.innerHTML = '';
            let issuesFound = 0;

            const now = Date.now();
            const delayThreshold = 5 * 60 * 1000; // 5 Ø¯Ù‚Ø§Ø¦Ù‚

            if (systemData.orders) {
                Object.values(systemData.orders).forEach(ord => {
                    if (ord.Shop_Type === 'shop_order') {
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø·Ù„Ø¨ ÙŠØ®Øµ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (Ø£Ùˆ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©)
                        let isMyOrder = false;
                        if (myMaster === 'admin' || myMaster === 'naseem') {
                            isMyOrder = true;
                        } else {
                             // ÙØ­Øµ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ù…Ù†Ø´Ø£Ø©) ØªØ§Ø¨Ø¹ Ù„Ù„Ù…Ø§Ø³ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ
                             let shopBelongsToMe = false;
                             if(systemData.shops) {
                                 const shopArr = Object.values(systemData.shops);
                                 shopBelongsToMe = shopArr.some(s => (s.Shop_User === ord.Shop_User || s.user === ord.Shop_User) && (s.Client_Master === myMaster || s.company === myMaster));
                             }
                             if(systemData.users) {
                                 const userArr = Object.values(systemData.users);
                                 if(!shopBelongsToMe) shopBelongsToMe = userArr.some(s => (s.Client_User === ord.Shop_User || s.user === ord.Shop_User) && (s.Client_Master === myMaster || s.master === myMaster));
                             }
                             if(ord.Shop_User === myMaster || shopBelongsToMe) isMyOrder = true;
                        }

                        if (isMyOrder) {
                            const ordTime = new Date(ord.Shop_Date).getTime();
                            const diff = now - ordTime;
                            
                            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…Ø§ Ø²Ø§Ù„ Ù…Ø¹Ù„Ù‚ ÙˆÙ„Ù… ÙŠÙ‚Ø¨Ù„
                            let isAccepted = false;
                            if(systemData.assigned_orders) {
                                for(let capKey in systemData.assigned_orders) {
                                    for(let appOrdKey in systemData.assigned_orders[capKey]) {
                                        if(systemData.assigned_orders[capKey][appOrdKey].linkedRadarId === ord.Shop_Ord_ID) {
                                             if(systemData.assigned_orders[capKey][appOrdKey].status === 'accepted' || systemData.assigned_orders[capKey][appOrdKey].status === 'completed') {
                                                 isAccepted = true;
                                             }
                                        }
                                    }
                                }
                            }

                            if (!isAccepted && diff > delayThreshold) {
                                issuesFound++;
                                const minutesDelayed = Math.floor(diff / 60000);
                                alertsContainer.innerHTML += `
                                    <div class="alert-item">
                                        <div style="font-weight:bold; font-size:15px; margin-bottom:5px;">âš ï¸ ØªØ£Ø®ÙŠØ± ÙÙŠ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±</div>
                                        <div style="font-size:13px; color:#ccc;">Ø§Ù„Ù…Ù†Ø´Ø£Ø©: <span style="color:white;">${ord.Shop_Name}</span></div>
                                        <div style="font-size:13px; color:#ccc;">Ø§Ù„ÙˆØ¬Ù‡Ø©: <span style="color:white;">${ord.Shop_Pickup}</span></div>
                                        <div style="font-size:13px; color:#ccc;">ÙˆÙ‚Øª Ø§Ù„ØªØ£Ø®ÙŠØ±: <span style="color:#ffb74d; font-weight:bold;">${minutesDelayed} Ø¯Ù‚ÙŠÙ‚Ø©</span></div>
                                    </div>
                                `;
                            }
                        }
                    }
                });
            }

            if (issuesFound === 0) {
                alertsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#81c784; font-weight:bold;">Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙŠØ¹Ù…Ù„ Ø¨ÙƒÙØ§Ø¡Ø© ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ø·Ù„Ø¨Ø§Øª Ù…ØªØ£Ø®Ø±Ø© âœ…</div>';
            }

            hideLoader();
            document.getElementById('alerts-modal').style.display = 'flex';
        };

        window.runPerformanceAnalytics = async function() {
            showLoader("Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© â³");
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© Ù…Ù† localStorage Ù„ØªÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© Ù„Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ…ÙŠ
            let completedOrders = JSON.parse(localStorage.getItem('n1_completed_orders') || '[]');
            
            const today = new Date().toDateString();
            const todayOrders = completedOrders.filter(o => new Date(o.date).toDateString() === today && o.cap !== "Ù…Ø±ÙÙˆØ¶");
            
            const analyticsContainer = document.getElementById('analytics-results');
            analyticsContainer.innerHTML = '';

            if (todayOrders.length === 0) {
                analyticsContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#888;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„ØªØ­Ù„ÙŠÙ„ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… â˜ºï¸</div>';
                hideLoader();
                document.getElementById('analytics-modal').style.display = 'flex';
                return;
            }

            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØ¨Ø§ØªÙ†
            let captainsCount = {};
            // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ø¢Øª
            let shopsCount = {};

            todayOrders.forEach(ord => {
                // Ø§Ù„ÙƒØ¨Ø§ØªÙ†
                if(ord.cap) {
                    captainsCount[ord.cap] = (captainsCount[ord.cap] || 0) + 1;
                }
                // Ø§Ù„Ù…Ù†Ø´Ø¢Øª
                if(ord.rest) {
                    let restName = ord.rest.split(' - ')[0]; // Ø£Ø®Ø° Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© ÙÙ‚Ø· Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø¥Ù† ÙˆØ¬Ø¯
                    shopsCount[restName] = (shopsCount[restName] || 0) + 1;
                }
            });

            // Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø¨Ø·Ù„
            let topCap = "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
            let topCapCount = 0;
            for (const [cap, count] of Object.entries(captainsCount)) {
                if (count > topCapCount) { topCapCount = count; topCap = cap; }
            }

            // Ø¥ÙŠØ¬Ø§Ø¯ Ø£Ù†Ø´Ø· Ù…Ù†Ø´Ø£Ø©
            let topShop = "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
            let topShopCount = 0;
            for (const [shop, count] of Object.entries(shopsCount)) {
                if (count > topShopCount) { topShopCount = count; topShop = shop; }
            }

            analyticsContainer.innerHTML = `
                <div class="analytics-item" style="border-color: var(--success);">
                    <div class="analytics-label">ğŸ† Ø¨Ø·Ù„ Ø§Ù„ÙŠÙˆÙ… (Ø£ÙƒØ«Ø± ÙƒØ§Ø¨ØªÙ† Ø¥Ù†Ø¬Ø§Ø²Ø§Ù‹)</div>
                    <div class="analytics-value" style="color: var(--success);">ğŸ¦¸â€â™‚ï¸ ${topCap} <span style="font-size:14px; color:#888; font-weight:normal;">(${topCapCount} Ø·Ù„Ø¨Ø§Øª)</span></div>
                </div>
                <div class="analytics-item" style="border-color: #0288d1;">
                    <div class="analytics-label">ğŸª Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„Ø£Ù†Ø´Ø·</div>
                    <div class="analytics-value" style="color: #0288d1;">${topShop} <span style="font-size:14px; color:#888; font-weight:normal;">(${topShopCount} Ø·Ù„Ø¨Ø§Øª)</span></div>
                </div>
                <div class="analytics-item">
                    <div class="analytics-label">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ù„Ù„ÙŠÙˆÙ…</div>
                    <div class="analytics-value">${todayOrders.length} Ø·Ù„Ø¨</div>
                </div>
            `;

            hideLoader();
            document.getElementById('analytics-modal').style.display = 'flex';
        };

        window.closeModal = function(modalId) {
            document.getElementById(modalId).style.display = 'none';
        };

        // ============================================================================== //

        window.backupData = function() {
            if(!systemData || Object.keys(systemData).length === 0) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³Ø­Ø¨ â˜ºï¸");
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(systemData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "N_One_Full_Backup_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();

            const msg = document.getElementById('backup-msg');
            msg.innerText = "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ â˜ºï¸âœ…";
            msg.style.display = "block";
            setTimeout(() => msg.style.display = "none", 4000);
        }

        window.autoArchive = async function() {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø£Ø±Ø´ÙØ© Ø³ÙŠØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø³ÙŠØ±ÙØ± â˜ºï¸")) return;
            
            if(!systemData.orders || Object.keys(systemData.orders).length === 0) {
                alert("Ø§Ù„Ø³ÙŠØ±ÙØ± Ù†Ø¸ÙŠÙ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù„Ù„Ø£Ø±Ø´ÙØ© â˜ºï¸");
                return;
            }

            const ordersToArchive = systemData.orders;
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(ordersToArchive, null, 2));
            const dlNode = document.createElement('a');
            dlNode.setAttribute("href", dataStr);
            dlNode.setAttribute("download", "Archive_Orders_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(dlNode);
            dlNode.click();
            dlNode.remove();

            showLoader("Ø¬Ø§Ø±ÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤Ø±Ø´ÙØ© Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¹Ø¯Ù… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© â³");

            try {
                await remove(ref(db, 'orders'));
                
                const msg = document.getElementById('archive-msg');
                msg.innerText = "ØªÙ…Øª Ø§Ù„Ø£Ø±Ø´ÙØ© ÙˆØªÙØ±ÙŠØº Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ù†Ø¬Ø§Ø­ â˜ºï¸âœ…";
                msg.style.display = "block";
                setTimeout(() => msg.style.display = "none", 4000);
                
                await fetchHealthStatus(); 

            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙØ±ÙŠØº â˜ºï¸");
            } finally {
                hideLoader();
            }
        }

        window.cleanMemory = function() {
            const current = localStorage.getItem('currentUser');
            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ† ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ù…Ø¬Ù†ÙˆÙ†Ø©
            const completedOrders = localStorage.getItem('n1_completed_orders');
            const processedOrders = localStorage.getItem('n1_processed_app_orders');
            const captainMem = localStorage.getItem('n1_captains');
            const commissionRatio = localStorage.getItem('n1_commission_ratio');

            localStorage.clear();
            sessionStorage.clear();
            
            if(current) localStorage.setItem('currentUser', current);
            if(completedOrders) localStorage.setItem('n1_completed_orders', completedOrders);
            if(processedOrders) localStorage.setItem('n1_processed_app_orders', processedOrders);
            if(captainMem) localStorage.setItem('n1_captains', captainMem);
            if(commissionRatio) localStorage.setItem('n1_commission_ratio', commissionRatio);

            const msg = document.getElementById('clean-msg');
            msg.innerText = "ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´ÙˆØ§Ø¦Ø¨ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙŠØªØ© â˜ºï¸âœ…";
            msg.style.display = "block";
            setTimeout(() => msg.style.display = "none", 4000);
        }

        // =================== Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Smart Purge) =================== //
        window.runDiamondPurge = async function(isAuto = false) {
            if(!isAuto) showLoader("Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© Ù„ØªØ·Ù‡ÙŠØ± Ø§Ù„Ø³ÙŠØ±ÙØ± â³");
            try {
                const now = Date.now();
                const sixHoursAgo = now - (6 * 60 * 60 * 1000);

                // 1. ØªÙ†Ø¸ÙŠÙ Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ø¬Ø±Ø³ ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                const alertsRef = ref(db, 'alerts');
                const alertsSnap = await get(alertsRef);
                if (alertsSnap.exists()) {
                    const alertsData = alertsSnap.val();
                    if(alertsData.global && alertsData.global.timestamp && alertsData.global.timestamp < sixHoursAgo) {
                         await remove(ref(db, 'alerts/global'));
                    }
                }

                // 2. ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                const adsRef = ref(db, 'announcements');
                const adsSnap = await get(adsRef);
                if(adsSnap.exists()) {
                    const adsData = adsSnap.val();
                    if(adsData.global && adsData.global.expireAt && adsData.global.expireAt < now) {
                        await remove(ref(db, 'announcements/global'));
                    }
                    if(adsData.users) {
                        for(let u in adsData.users) {
                            if(adsData.users[u].expireAt && adsData.users[u].expireAt < now) {
                                await remove(ref(db, `announcements/users/${u}`));
                            }
                        }
                    }
                }

                // 3. ØªÙ†Ø¸ÙŠÙ Ø¶Ø¬ÙŠØ¬ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®Ø²Ù†
                if(systemData.radar_history) {
                    for(let key in systemData.radar_history) {
                        if(systemData.radar_history[key].timestamp && systemData.radar_history[key].timestamp < sixHoursAgo) {
                            await remove(ref(db, `radar_history/${key}`));
                        }
                    }
                }

                if(!isAuto) {
                    const msg = document.getElementById('purge-msg');
                    msg.innerText = "ØªÙ…Øª Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ â˜ºï¸âœ…";
                    msg.style.display = "block";
                    setTimeout(() => msg.style.display = "none", 4000);
                    await fetchHealthStatus();
                }
            } catch(e) {
                if(!isAuto) alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© â˜ºï¸");
            } finally {
                if(!isAuto) hideLoader();
            }
        }

        function showLoader(text) {
            document.getElementById('loader-msg').innerText = text;
            document.getElementById('loader-overlay').style.display = 'flex';
        }

        function hideLoader() {
            document.getElementById('loader-overlay').style.display = 'none';
        }
    </script>

</body>
</html>
