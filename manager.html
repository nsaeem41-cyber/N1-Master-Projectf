<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a237e; /* Ø®Ù„ÙÙŠØ© ÙƒØ­Ù„ÙŠØ© Ù…Ù„ÙƒÙŠØ© */
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #f4f6f8;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-height: 90vh;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .brand { font-size: 24px; font-weight: 900; color: #1a237e; }
        .gold { color: #d4af37; }

        .btn-logout {
            background: #c62828; color: white; border: none;
            padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        /* Ù‚Ø³Ù… Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
        .add-box {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        .add-title { margin-top: 0; color: #1a237e; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-row input {
            flex: 1; padding: 10px; border: 1px solid #ccc;
            border-radius: 5px; text-align: right; min-width: 120px;
        }
        
        .btn-add {
            background: #2e7d32; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            font-weight: bold; margin-top: 10px; width: 100%;
        }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ */
        .client-card {
            background: white; border-radius: 10px; padding: 15px;
            margin-bottom: 15px; border-right: 5px solid #ccc;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.3s;
        }
        
        .client-card.active { border-right-color: #2e7d32; } /* Ø£Ø®Ø¶Ø± Ù„Ù„Ù†Ø´Ø· */
        .client-card.stopped { border-right-color: #c62828; background: #ffebee; } /* Ø£Ø­Ù…Ø± Ù„Ù„Ù…ÙˆÙ‚ÙˆÙ */

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 16px;
        }

        .card-info { font-size: 13px; color: #666; display: flex; gap: 15px; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .actions {
            display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;
        }

        .btn-action {
            flex: 1; padding: 8px; border: none; border-radius: 5px;
            cursor: pointer; font-size: 12px; font-weight: bold; color: white;
            text-align: center;
        }

        .btn-stop { background: #c62828; } /* Ø£Ø­Ù…Ø± Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù */
        .btn-activate { background: #2e7d32; } /* Ø£Ø®Ø¶Ø± Ù„Ù„ØªÙØ¹ÙŠÙ„ */
        .btn-renew { background: #1976d2; } /* Ø£Ø²Ø±Ù‚ Ù„Ù„ØªØ¬Ø¯ÙŠØ¯ */
        .btn-del { background: #555; } /* Ø±Ù…Ø§Ø¯ÙŠ Ù„Ù„Ø­Ø°Ù */
        .btn-edit { background: #f9a825; color: #000; } /* Ø£ØµÙØ± Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ */

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loading { text-align: center; padding: 20px; font-weight: bold; color: #1a237e; }

    </style>
</head>
<body>

    <div class="container">
        
        <div class="header">
            <div class="brand">N <span class="gold">One</span> Admin</div>
            <button class="btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸ”’</button>
        </div>

        <div class="add-box">
            <h3 class="add-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="form-row">
                <input type="text" id="new_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©/Ø§Ù„Ø¹Ù…ÙŠÙ„">
                <input type="text" id="new_user" placeholder="User ID (Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„)">
                <input type="text" id="new_pass" placeholder="Password (ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)">
            </div>
            <button class="btn-add" onclick="addClient()">+ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <h3 style="color:#1a237e;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
        <div id="loading">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        <div id="clients-list"></div>

    </div>

    <script>
        const API_URL = "https://sheetdb.io/api/v1/zuo2qyjeryhxm";

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ù…Ø¯ÙŠØ±
        window.onload = function() {
            const admin = JSON.parse(localStorage.getItem('currentUser'));
            if (!admin || admin.role !== 'admin') {
                window.location.href = 'manager.html'; // ÙŠØ±Ø¬Ø¹ ÙŠØ³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ù„Ùˆ Ù…Ø´ Ù…Ø¯ÙŠØ±
            } else {
                loadClients();
            }
        };

        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
        async function loadClients() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                // ØªØµÙÙŠØ©: ÙÙ‚Ø· Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ (role = client)
                const clients = data.filter(u => u.role === 'client');
                
                renderClients(clients);
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            }
        }

        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„ÙƒØ±ÙˆØª)
        function renderClients(clients) {
            const container = document.getElementById('clients-list');
            container.innerHTML = '';

            if (clients.length === 0) {
                container.innerHTML = '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            // ØªØ±ØªÙŠØ¨: Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
            clients.reverse().forEach(client => {
                const isActive = client.status === 'active';
                const statusClass = isActive ? 'active' : 'stopped';
                const statusText = isActive ? 'Ù†Ø´Ø· âœ…' : 'Ù…ÙˆÙ‚ÙˆÙ ğŸ›‘';

                // ØªØµÙ…ÙŠÙ… Ø§Ù„ÙƒØ±Øª
                const card = document.createElement('div');
                card.className = `client-card ${statusClass}`;
                
                card.innerHTML = `
                    <div class="card-header">
                        <span>${client.name}</span>
                        <span style="font-size:12px; background:white; padding:3px 8px; border-radius:10px; border:1px solid #ddd;">${statusText}</span>
                    </div>
                    <div class="card-info">
                        <span>ğŸ‘¤ User: ${client.user}</span>
                        <span>ğŸ”‘ Pass: ${client.pass}</span>
                    </div>
                    <div class="card-info">
                        <span>ğŸ“… ÙŠÙ†ØªÙ‡ÙŠ: ${client.expiry || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    
                    <div class="actions">
                        ${isActive 
                            ? `<button class="btn-action btn-stop" onclick="updateStatus('${client.user}', 'stopped')">Ø¥ÙŠÙ‚Ø§Ù ğŸ›‘</button>` 
                            : `<button class="btn-action btn-activate" onclick="updateStatus('${client.user}', 'active')">ØªÙØ¹ÙŠÙ„ âœ…</button>`
                        }
                        <button class="btn-action btn-renew" onclick="renewClient('${client.user}')">ØªØ¬Ø¯ÙŠØ¯ Ø´Ù‡Ø± â™»ï¸</button>
                        <button class="btn-action btn-edit" onclick="editClient('${client.user}', '${client.pass}')">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button>
                        <button class="btn-action btn-del" onclick="deleteClient('${client.id}')">Ø­Ø°Ù âŒ</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ---

        // 1. Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„
        async function addClient() {
            const name = document.getElementById('new_name').value;
            const user = document.getElementById('new_user').value;
            const pass = document.getElementById('new_pass').value;

            if (!name || !user || !pass) { alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

            // ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ø¹Ø¯ 30 ÙŠÙˆÙ…
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            const expiryStr = expiryDate.toISOString().split('T')[0];

            const newClient = {
                id: "CL_" + Date.now(),
                user: user,
                pass: pass,
                name: name,
                role: "client",
                status: "active",
                expiry: expiryStr,
                type: "user" // ØªÙ…ÙŠÙŠØ² Ø¥Ù†Ù‡ Ù…Ø³ØªØ®Ø¯Ù…
            };

            const btn = document.querySelector('.btn-add');
            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
            btn.disabled = true;

            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [newClient] })
            });

            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰");
            location.reload(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
        }

        // 2. ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ø¥ÙŠÙ‚Ø§Ù / ØªÙØ¹ÙŠÙ„)
        async function updateStatus(username, newStatus) {
            if (!confirm(newStatus === 'stopped' ? "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥ÙŠÙ‚Ø§Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ Ø³ÙŠØªÙ… Ø·Ø±Ø¯Ù‡ ÙÙˆØ±Ø§Ù‹!" : "Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ")) return;

            // Ø§Ù„Ø¨Ø­Ø« ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ status
            // SheetDB ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø¨Ø± user/username
            await fetch(`${API_URL}/user/${username}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { status: newStatus } })
            });

            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
            loadClients();
        }

        // 3. ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        async function renewClient(username) {
            if (!confirm("ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ…ØŸ")) return;

            const newDate = new Date();
            newDate.setDate(newDate.getDate() + 30);
            const expiryStr = newDate.toISOString().split('T')[0];

            await fetch(`${API_URL}/user/${username}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { expiry: expiryStr, status: 'active' } })
            });

            alert("ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ!");
            loadClients();
        }

        // 4. Ø­Ø°Ù Ø¹Ù…ÙŠÙ„
        async function deleteClient(id) {
            if (!confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;

            await fetch(`${API_URL}/id/${id}`, { method: 'DELETE' });
            
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù.");
            loadClients();
        }

        // 5. ØªØ¹Ø¯ÙŠÙ„ (Ø¨Ø§Ø³ÙˆØ±Ø¯)
        async function editClient(username, oldPass) {
            const newPass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:", oldPass);
            if (newPass && newPass !== oldPass) {
                await fetch(`${API_URL}/user/${username}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { pass: newPass } })
                });
                alert("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.");
                loadClients();
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'manager.html'; // ÙŠØ±Ø¬Ø¹ Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
        }
    </script>

</body>
</html>
