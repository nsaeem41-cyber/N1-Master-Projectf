<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a237e;
            margin: 0;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #f4f6f8;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-height: 90vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .brand { font-size: 24px; font-weight: 900; color: #1a237e; }
        .gold { color: #d4af37; }

        .btn-logout {
            background: #c62828; color: white; border: none;
            padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        .add-box {
            background: white; padding: 20px; border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px;
        }
        .add-title { margin-top: 0; color: #1a237e; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        .form-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .form-row input {
            flex: 1; padding: 10px; border: 1px solid #ccc;
            border-radius: 5px; text-align: right; min-width: 120px;
        }
        
        .btn-add {
            background: #2e7d32; color: white; border: none;
            padding: 10px 20px; border-radius: 5px; cursor: pointer;
            font-weight: bold; margin-top: 10px; width: 100%;
        }

        .client-card {
            background: white; border-radius: 10px; padding: 15px;
            margin-bottom: 15px; border-right: 5px solid #ccc;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.3s;
        }
        
        .client-card.active { border-right-color: #2e7d32; }
        .client-card.stopped { border-right-color: #c62828; background: #ffebee; }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 16px;
        }

        .card-info { font-size: 13px; color: #666; display: flex; gap: 15px; }

        .actions {
            display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap;
        }

        .btn-action {
            flex: 1; padding: 8px; border: none; border-radius: 5px;
            cursor: pointer; font-size: 12px; font-weight: bold; color: white;
            text-align: center;
        }

        .btn-stop { background: #c62828; }
        .btn-activate { background: #2e7d32; }
        .btn-renew { background: #1976d2; }
        .btn-del { background: #555; }
        .btn-edit { background: #f9a825; color: #000; }

        #loading { text-align: center; padding: 20px; font-weight: bold; color: #1a237e; }
        .error-msg { color: #c62828; background: #ffebee; padding: 10px; border-radius: 5px; text-align: center; display: none; margin-bottom: 10px; }

    </style>
</head>
<body>

    <div class="container">
        
        <div class="header">
            <div class="brand">N <span class="gold">One</span> Admin</div>
            <button class="btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬ ğŸ”’</button>
        </div>

        <div id="status-error" class="error-msg"></div>

        <div class="add-box">
            <h3 class="add-title">Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ Ø¬Ø¯ÙŠØ¯</h3>
            <div class="form-row">
                <input type="text" id="new_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©/Ø§Ù„Ø¹Ù…ÙŠÙ„">
                <input type="text" id="new_user" placeholder="User ID (Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„)">
                <input type="text" id="new_pass" placeholder="Password (ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±)">
            </div>
            <button class="btn-add" onclick="addClient()">+ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</button>
        </div>

        <h3 style="color:#1a237e;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†</h3>
        <div id="loading">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©... â˜ï¸</div>
        <div id="clients-list"></div>

    </div>

    <script>
        const API_URL = "https://sheetdb.io/api/v1/zuo2qyjeryhxm";

        window.onload = function() {
            const admin = JSON.parse(localStorage.getItem('currentUser'));
            // Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ù…Ù†Ø¹ Ø§Ù„Ø¯ÙˆØ§Ù…Ø© Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            if (!admin || admin.role !== 'admin') {
                window.location.href = 'index.html'; 
            } else {
                loadClients();
            }
        };

        async function loadClients() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('status-error');
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                if (data.error || !Array.isArray(data)) {
                    throw new Error("ÙˆØµÙ„Ù†Ø§ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„ÙŠÙˆÙ…");
                }

                const clients = data.filter(u => u.role === 'client');
                renderClients(clients);
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'none';
            } catch (e) {
                loadingDiv.style.display = 'none';
                errorDiv.innerText = "âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: " + e.message;
                errorDiv.style.display = 'block';
            }
        }

        function renderClients(clients) {
            const container = document.getElementById('clients-list');
            container.innerHTML = '';

            if (clients.length === 0) {
                container.innerHTML = '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© N One ğŸ˜Š</p>';
                return;
            }

            clients.reverse().forEach(client => {
                const isActive = client.status === 'active';
                const statusClass = isActive ? 'active' : 'stopped';
                const statusText = isActive ? 'Ù†Ø´Ø· âœ…' : 'Ù…ÙˆÙ‚ÙˆÙ ğŸ›‘';

                const card = document.createElement('div');
                card.className = `client-card ${statusClass}`;
                
                card.innerHTML = `
                    <div class="card-header">
                        <span>${client.name}</span>
                        <span style="font-size:12px; background:white; padding:3px 8px; border-radius:10px; border:1px solid #ddd;">${statusText}</span>
                    </div>
                    <div class="card-info">
                        <span>ğŸ‘¤ User: ${client.user}</span>
                        <span>ğŸ”‘ Pass: ${client.pass}</span>
                    </div>
                    <div class="card-info">
                        <span>ğŸ“… ÙŠÙ†ØªÙ‡ÙŠ: ${client.expiry || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                    
                    <div class="actions">
                        ${isActive 
                            ? `<button class="btn-action btn-stop" onclick="updateStatus('${client.user}', 'stopped')">Ø¥ÙŠÙ‚Ø§Ù ğŸ›‘</button>` 
                            : `<button class="btn-action btn-activate" onclick="updateStatus('${client.user}', 'active')">ØªÙØ¹ÙŠÙ„ âœ…</button>`
                        }
                        <button class="btn-action btn-renew" onclick="renewClient('${client.user}')">ØªØ¬Ø¯ÙŠØ¯ Ø´Ù‡Ø± â™»ï¸</button>
                        <button class="btn-action btn-edit" onclick="editClient('${client.user}', '${client.pass}')">ØªØ¹Ø¯ÙŠÙ„ âœï¸</button>
                        <button class="btn-action btn-del" onclick="deleteClient('${client.id}')">Ø­Ø°Ù âŒ</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function addClient() {
            const name = document.getElementById('new_name').value;
            const user = document.getElementById('new_user').value;
            const pass = document.getElementById('new_pass').value;

            if (!name || !user || !pass) { alert("ÙŠØ§ Ø¨Ø·Ø© Ø¹Ø¨ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„Ù‡Ø§ ğŸ˜Š"); return; }

            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            const expiryStr = expiryDate.toISOString().split('T')[0];

            const newClient = {
                id: "CL_" + Date.now(),
                user: user,
                pass: pass,
                name: name,
                role: "client",
                status: "active",
                expiry: expiryStr,
                type: "user"
            };

            const btn = document.querySelector('.btn-add');
            const originalText = btn.innerHTML;
            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª... âœ¨";
            btn.disabled = true;

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: [newClient] })
                });
                alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ù†Ø¸Ø§Ù… N One ğŸ‰");
                location.reload();
            } catch (e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ ğŸ˜Š");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function updateStatus(username, newStatus) {
            const confirmMsg = newStatus === 'stopped' ? "Ø£ÙƒÙŠØ¯ Ø¨Ø¯Ùƒ ØªÙˆÙ‚ÙÙŠ Ù‡Ø§Ù„Ù…Ø´ØªØ±ÙƒØŸ ğŸ˜Š" : "ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø´ØªØ±ÙƒØŸ ğŸ˜Š";
            if (!confirm(confirmMsg)) return;

            await fetch(`${API_URL}/user/${username}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { status: newStatus } })
            });

            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
            loadClients();
        }

        async function renewClient(username) {
            if (!confirm("ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù„Ù…Ø¯Ø© 30 ÙŠÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ©ØŸ ğŸ˜Š")) return;

            const newDate = new Date();
            newDate.setDate(newDate.getDate() + 30);
            const expiryStr = newDate.toISOString().split('T')[0];

            await fetch(`${API_URL}/user/${username}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: { expiry: expiryStr, status: 'active' } })
            });

            alert("ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ ÙŠØ§ Ù…Ø¯ÙŠØ±Ø© ğŸ˜Šâ™»ï¸");
            loadClients();
        }

        async function deleteClient(id) {
            if (!confirm("âš ï¸ Ø§Ù†ØªØ¨Ù‡ÙŠ: Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ³ØªÙ…ØŸ")) return;

            await fetch(`${API_URL}/id/${id}`, { method: 'DELETE' });
            
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ ğŸ˜Š");
            loadClients();
        }

        async function editClient(username, oldPass) {
            const newPass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙŠØ§ Ø­Ø¨Ø© Ø§Ù„Ø³ÙƒØ± ğŸ˜Š:", oldPass);
            if (newPass && newPass !== oldPass) {
                await fetch(`${API_URL}/user/${username}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data: { pass: newPass } })
                });
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ¨");
                loadClients();
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }
    </script>

</body>
</html>
