<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | ØºØ±ÙØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Fleet Command)</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ============================================================
           ØªØµÙ…ÙŠÙ… N ONE CLASSIC OPS (The Royal Dark Theme)
           Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£ØµÙ„ ÙˆØ§Ù„ÙØ®Ø§Ù…Ø© - ÙƒØ­Ù„ÙŠ ÙˆØ°Ù‡Ø¨ÙŠ
           ============================================================ */
        :root {
            --primary: #0f172a;      /* ÙƒØ­Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØºØ§Ù…Ù‚ */
            --primary-light: #1e293b; /* ÙƒØ­Ù„ÙŠ ÙØ§ØªØ­ Ù„Ù„ÙƒØ±ÙˆØª */
            --gold: #d4af37;         /* Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ø§Ù„Ù…Ù„ÙƒÙŠ */
            --text-main: #e2e8f0;    /* Ù†Øµ ÙØ§ØªØ­ */
            --text-muted: #94a3b8;   /* Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ */
            --bg: #020617;           /* Ø®Ù„ÙÙŠØ© Ø³ÙˆØ¯Ø§Ø¡/ÙƒØ­Ù„ÙŠØ© */
            --success: #10b981;      /* Ø£Ø®Ø¶Ø± */
            --danger: #ef4444;       /* Ø£Ø­Ù…Ø± */
            --input-bg: #334155;     /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ */
            --border: #475569;       /* Ù„ÙˆÙ† Ø§Ù„Ø­Ø¯ÙˆØ¯ */
        }

        * { box-sizing: border-box; outline: none; }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text-main); font-size: 13px; 
            min-height: 100vh;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„ÙØ®Ù… --- */
        .navbar { 
            background: var(--primary); height: 60px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 25px; border-bottom: 2px solid var(--gold); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.4); 
            position: sticky; top: 0; z-index: 1000;
        }
        .brand { font-size: 22px; font-weight: 900; color: white; letter-spacing: 1px; display: flex; align-items: center; gap: 10px; }
        .gold-text { color: var(--gold); }

        /* Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠØ© */
        .live-stat { 
            background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 4px; 
            color: #e2e8f0; font-size: 12px; border: 1px solid var(--border);
            display: flex; gap: 8px; align-items: center;
        }
        .live-stat b { color: var(--gold); font-size: 14px; }

        .btn-header {
            background: var(--primary-light); color: white; border: 1px solid var(--border);
            padding: 6px 15px; border-radius: 4px; font-size: 12px; cursor: pointer;
            transition: 0.3s; display: flex; align-items: center; gap: 5px; font-weight: bold;
        }
        .btn-header:hover { background: var(--gold); color: var(--primary); border-color: var(--gold); }
        .btn-wipe { background: #450a0a; border-color: #7f1d1d; color: #fca5a5; }
        .btn-wipe:hover { background: var(--danger); color: white; }

        /* --- Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„ØªØ®Ø·ÙŠØ· --- */
        .container { 
            max-width: 1800px; margin: 20px auto; padding: 0 20px; 
            display: grid; grid-template-columns: 350px 1fr; gap: 20px; 
        }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .card { 
            background: var(--primary-light); border-radius: 8px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); border: 1px solid var(--border); 
            padding: 15px; margin-bottom: 20px; position: relative;
        }
        .card-header { 
            font-size: 14px; font-weight: 800; color: var(--gold); 
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border); 
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; font-weight: 700; color: var(--text-muted); font-size: 11px; }
        input, select { 
            width: 100%; padding: 8px 10px; border: 1px solid var(--border); border-radius: 4px; 
            background: var(--input-bg); color: white; font-size: 12px; transition: 0.3s;
        }
        input:focus { border-color: var(--gold); box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { width: 100%; padding: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; font-size: 12px; }
        .btn-blue { background: #3b82f6; } .btn-blue:hover { background: #2563eb; }
        .btn-green { background: var(--success); } .btn-green:hover { background: #059669; }
        .btn-red { background: var(--danger); } .btn-red:hover { background: #b91c1c; }
        .btn-gold { background: var(--gold); color: var(--primary); } .btn-gold:hover { background: #b4932a; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { 
            background: #0f172a; color: var(--text-muted); padding: 10px; text-align: right; 
            font-size: 11px; border-bottom: 2px solid var(--border); 
        }
        td { padding: 8px 10px; border-bottom: 1px solid #334155; vertical-align: middle; font-size: 12px; }
        tr:hover { background: rgba(255,255,255,0.05); }

        /* Badges */
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .bg-active { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid #059669; }
        .bg-emergency { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #b91c1c; }

        /* Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø­ÙØ¸Ø© */
        #wallet-result { 
            display: none; background: rgba(0,0,0,0.2); padding: 15px; 
            border: 1px solid var(--gold); border-radius: 6px; margin-bottom: 15px; 
            text-align: center;
        }
        #wallet-result h2 { margin: 5px 0; color: var(--gold); }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loader-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(2, 6, 23, 0.95); z-index: 3000; 
            justify-content: center; align-items: center; flex-direction: column; 
            color: var(--gold); 
        }

        /* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            .navbar, .controls, .form-container, .btn, input, select { display: none !important; }
            body, .container, .card { background: white !important; color: black !important; margin: 0; padding: 0; display: block; }
            .card { border: none; box-shadow: none; }
            table { border: 1px solid #000; width: 100%; }
            th, td { border: 1px solid #000; color: black; }
            .no-print { display: none; }
        }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div style="font-size:40px; margin-bottom:15px;">ğŸ’</div>
        <div style="font-family:monospace; font-size:14px;">N ONE SYSTEM SECURE LINK...</div>
    </div>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Fleet</div>
        
        <div style="display:flex; gap:15px;">
            <div class="live-stat">ğŸ‘®â€â™‚ï¸ ÙƒØ¨Ø§ØªÙ† Ù†Ø´Ø·ÙŠÙ†: <b id="stat-caps">0</b></div>
            <div class="live-stat">ğŸª Ù…Ù†Ø´Ø¢Øª Ù…Ø±Ø¨ÙˆØ·Ø©: <b id="stat-shops">0</b></div>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn-header" onclick="refreshData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button class="btn-header btn-wipe" onclick="secureWipe()">â˜¢ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
        </div>
    </nav>

    <div class="container">
        
        <div class="form-container">
            
            <div class="card">
                <div class="card-header">ğŸ“ ØªØ¹ÙŠÙŠÙ† ÙƒØ§Ø¨ØªÙ† (Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)</div>
                
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="reg_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
                </div>
                
                <div class="form-group">
                    <label style="color:var(--gold);">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)</label>
                    <input type="tel" id="reg_phone" placeholder="07xxxxxxxx" maxlength="10">
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>ğŸš— ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Coding)</label>
                        <input type="text" id="reg_coding" placeholder="K-50">
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                        <input type="text" id="reg_type" placeholder="Kia Sephia">
                    </div>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</label>
                    <input type="number" id="reg_model" placeholder="2020">
                </div>

                <button class="btn btn-gold" onclick="registerCaptain()">+ Ø¥ØµØ¯Ø§Ø± ØªØµØ±ÙŠØ­ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯</button>
            </div>

            <div class="card">
                <div class="card-header">ğŸ’¸ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Smart Fund)</div>
                
                <div class="form-group">
                    <label>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙƒØ§Ø¨ØªÙ† / Ù…Ù†Ø´Ø£Ø©)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="tel" id="wallet_phone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
                        <button class="btn btn-blue" style="width:auto;" onclick="searchWallet()">ğŸ”</button>
                    </div>
                </div>

                <div id="wallet-result">
                    <small id="wr_type" style="color:var(--text-muted); text-transform:uppercase;">--</small>
                    <h2 id="wr_name">---</h2>
                    <div style="font-size:24px; color:var(--success); font-weight:bold; margin:10px 0;">
                        <span id="wr_balance">0.00</span> <span style="font-size:12px;">Ø¯.Ø£</span>
                    </div>
                    <small id="wr_detail" style="color:var(--gold);">--</small>
                </div>

                <div class="form-group">
                    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                    <input type="number" id="wallet_amount" placeholder="0.00">
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-green" onclick="updateBalance('add')">Ø¥ÙŠØ¯Ø§Ø¹ (+)</button>
                    <button class="btn btn-red" onclick="updateBalance('deduct')">Ø®ØµÙ… (-)</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</div>
                <div style="height:200px;">
                    <canvas id="fleetChart"></canvas>
                </div>
            </div>
        </div>

        <div style="display:flex; flex-direction:column;">
            
            <div class="card">
                <div class="card-header">
                    <span>â³ ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø·Ù„Ø¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ©)</span>
                    <span style="font-size:10px; color:var(--text-muted);">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</span>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                        </thead>
                        <tbody id="req-body">
                            <tr><td colspan="4" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="flex-grow:1;">
                <div class="card-header">
                    <span>ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø· (Active Fleet)</span>
                    <button class="btn btn-gold" style="width:auto; padding:5px 15px;" onclick="printReport()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                <th>Ø§Ù„Ø±ØµÙŠØ¯ (Ø¯.Ø£)</th>
                                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</th>
                                <th>Ø§Ù„Ø±Ø­Ù„Ø§Øª</th>
                                <th class="no-print">ØªØ­ÙƒÙ…</th>
                            </tr>
                        </thead>
                        <tbody id="fleet-body">
                            <tr><td colspan="8" style="text-align:center; padding:30px; color:var(--text-muted);">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <div id="print-area" style="display:none;"></div>

    <script>
        // ========================================================
        // Ù†Ø¸Ø§Ù… N ONE - Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„Ù…Ø§Ø³ÙŠØ© v9.0
        // "Ø§Ù„Ø±Ù‚ÙŠØŒ Ø§Ù„Ø¯Ù‚Ø©ØŒ ÙˆØ¹Ø¯Ù… Ø§Ù„Ù†Ø³ÙŠØ§Ù†"
        // ========================================================

        if (typeof N_ONE_CORE !== 'undefined') {
            N_ONE_CORE.API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        }

        let allData = [];
        let captains = [];
        let shops = [];
        let requests = [];
        let currentWalletUser = null;

        // --- Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ---
        window.onload = async function() {
            if (typeof N_ONE_CORE === 'undefined') { alert("Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ ØºÙŠØ± Ù…ØªØµÙ„!"); return; }
            initChart();
            await refreshData();
        };

        async function refreshData() {
            document.getElementById('loader-overlay').style.display = 'flex';
            try {
                allData = await N_ONE_CORE.fetchData('read');
                processData();
            } catch (e) { console.error(e); }
            document.getElementById('loader-overlay').style.display = 'none';
        }

        function processData() {
            // ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            // Ø§Ù„ÙƒØ¨Ø§ØªÙ†: ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù„Ù‚ÙŠÙ†
            captains = allData.filter(i => i.type === 'captain' && i.status !== 'pending').reverse();
            // Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
            requests = allData.filter(i => i.type === 'captain' && i.status === 'pending');
            // Ø§Ù„Ù…Ù†Ø´Ø¢Øª: Ø³Ø­Ø¨ Ø§Ù„Ø®ÙŠÙˆØ· Ù…Ù† client.html
            shops = allData.filter(i => (i.type === 'shop' || i.role === 'shop'));

            // 5. Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠØ©
            document.getElementById('stat-caps').innerText = captains.length;
            document.getElementById('stat-shops').innerText = shops.length;

            renderTables();
            updateChart();
        }

        // --- 1. Ù†Ø¸Ø§Ù… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
        async function registerCaptain() {
            const name = document.getElementById('reg_name').value;
            const phone = document.getElementById('reg_phone').value; // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            const coding = document.getElementById('reg_coding').value; // Ø§Ù„ØªØ±Ù…ÙŠØ²
            const type = document.getElementById('reg_type').value;
            const model = document.getElementById('reg_model').value;

            if(!name || !phone || !coding) { alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„ØªØ±Ù…ÙŠØ²)"); return; }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… (Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ)
            if(captains.some(c => c.cap_phone === phone) || shops.some(s => s.cap_phone === phone)) {
                alert("â›” Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…!"); return;
            }

            document.getElementById('loader-overlay').style.display = 'flex';
            
            const newCap = {
                id: "CAP_" + Date.now(),
                user: coding,          // Ø­ÙØ¸ Ø§Ù„ØªØ±Ù…ÙŠØ² ÙÙŠ Ø®Ø§Ù†Ø© user
                name: name,
                cap_phone: phone,      // Ø§Ù„Ù…ÙØªØ§Ø­
                pass: "123456",
                role: "captain", type: "captain", status: "active",
                pickup: `${type} - ${model}`, // Ø¯Ù…Ø¬ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„
                balance: 0,
                emergency_used: "false",
                orders_count: 0
            };

            await N_ONE_CORE.postData('add', [newCap]);
            alert("ØªÙ… Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯ âœ…");
            
            // ØªÙ†Ø¸ÙŠÙ
            document.getElementById('reg_name').value = '';
            document.getElementById('reg_phone').value = '';
            document.getElementById('reg_coding').value = '';
            
            await refreshData();
        }

        // --- 2. Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© (Ø±Ø¨Ø· Ø§Ù„Ø®ÙŠÙˆØ·) ---
        function searchWallet() {
            const phone = document.getElementById('wallet_phone').value.trim();
            if(!phone) return;

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ: Ù‡Ù„ Ù‡Ùˆ ÙƒØ§Ø¨ØªÙ†ØŸ Ø£Ù… Ù…Ù†Ø´Ø£Ø©ØŸ
            let found = captains.find(c => c.cap_phone === phone);
            let entityType = "ÙƒØ§Ø¨ØªÙ† ğŸ‘®â€â™‚ï¸";
            let detail = "";

            if(!found) {
                // ØªÙØ¹ÙŠÙ„ Ø®ÙŠØ· Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ù…Ù†Ø´Ø¢Øª
                found = shops.find(s => s.cap_phone === phone);
                entityType = "Ù…Ù†Ø´Ø£Ø© ØªØ¬Ø§Ø±ÙŠØ© ğŸª";
            }

            const resBox = document.getElementById('wallet-result');
            
            if(found) {
                currentWalletUser = found;
                resBox.style.display = 'block';
                document.getElementById('wr_type').innerText = entityType;
                document.getElementById('wr_name').innerText = found.name;
                document.getElementById('wr_balance').innerText = parseFloat(found.balance || 0).toFixed(2);
                
                if(entityType.includes("ÙƒØ§Ø¨ØªÙ†")) {
                    document.getElementById('wr_detail').innerText = `Ø§Ù„ØªØ±Ù…ÙŠØ²: ${found.user} | Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${found.pickup}`;
                } else {
                    document.getElementById('wr_detail').innerText = `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${found.pickup || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                }
            } else {
                alert("âŒ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠ Ù‚Ø³Ù… Ù…Ù† Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©");
                resBox.style.display = 'none';
                currentWalletUser = null;
            }
        }

        async function updateBalance(mode) {
            if(!currentWalletUser) return alert("Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£ÙˆÙ„Ø§Ù‹");
            const amt = parseFloat(document.getElementById('wallet_amount').value);
            if(!amt || amt <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹");

            const current = parseFloat(currentWalletUser.balance || 0);
            const newVal = mode === 'add' ? current + amt : current - amt;

            if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ©ØŸ\nØ§Ù„Ø­Ø³Ø§Ø¨: ${currentWalletUser.name}\nØ§Ù„Ù…Ø¨Ù„Øº: ${amt}\nØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newVal}`)) return;

            document.getElementById('loader-overlay').style.display = 'flex';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±ÙØ±
            await N_ONE_CORE.postData('update', { user: currentWalletUser.user, data: { balance: newVal } });
            
            alert("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ğŸ’°");
            document.getElementById('wallet_amount').value = '';
            document.getElementById('wallet-result').style.display = 'none';
            currentWalletUser = null;
            
            await refreshData();
        }

        // --- 3. Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
        function renderTables() {
            // Ø§Ù„ÙƒØ¨Ø§ØªÙ†
            const fleetBody = document.getElementById('fleet-body');
            fleetBody.innerHTML = '';
            if(captains.length === 0) fleetBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ†</td></tr>';
            
            captains.forEach(c => {
                const emg = c.emergency_used === 'true' 
                    ? '<span class="badge bg-emergency">Ø·ÙˆØ§Ø±Ø¦ âš ï¸</span>' 
                    : '<span class="badge bg-active">Ù…Ø³ØªØ¹Ø¯</span>';

                fleetBody.innerHTML += `
                    <tr>
                        <td style="color:var(--gold); font-weight:bold;">${c.user}</td>
                        <td>${c.name}</td>
                        <td style="font-family:monospace;">${c.cap_phone}</td>
                        <td>${c.pickup || '-'}</td>
                        <td style="color:var(--success); font-weight:bold;">${parseFloat(c.balance||0).toFixed(2)}</td>
                        <td>${emg}</td>
                        <td>${c.orders_count || 0}</td>
                        <td class="no-print">
                            <button class="btn btn-red" style="width:auto; padding:5px;" onclick="deleteUser('${c.user}')">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            });

            // Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            const reqBody = document.getElementById('req-body');
            reqBody.innerHTML = '';
            if(requests.length === 0) reqBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#666;">Ù„Ø§ Ø·Ù„Ø¨Ø§Øª</td></tr>';
            requests.forEach(r => {
                reqBody.innerHTML += `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.cap_phone}</td>
                        <td>${r.pickup}</td>
                        <td><button class="btn btn-green" onclick="acceptRequest('${r.user}')">âœ”</button></td>
                    </tr>
                `;
            });
        }

        async function acceptRequest(u) {
            const newCode = prompt("Ø£Ø¯Ø®Ù„ ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯:");
            if(!newCode) return;
            document.getElementById('loader-overlay').style.display = 'flex';
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© + ØªØºÙŠÙŠØ± Ø§Ù„ user Ù„ÙŠÙƒÙˆÙ† Ù‡Ùˆ Ø§Ù„ØªØ±Ù…ÙŠØ²
            await N_ONE_CORE.postData('update', { user: u, data: { status: 'active', user: newCode } });
            await refreshData();
        }

        async function deleteUser(u) {
            if(confirm("Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØŸ")) {
                document.getElementById('loader-overlay').style.display = 'flex';
                await N_ONE_CORE.fetchData('delete', { user: u });
                await refreshData();
            }
        }

        // --- 4. ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø­ ---
        async function secureWipe() {
            const pwd = prompt("ğŸ”’ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø´ÙØ±Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ù„Ù„Ù…Ø³Ø­:");
            if(pwd === "N1-2026-Security") {
                if(confirm("ØªØ­Ø°ÙŠØ±!! Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØªØµÙÙŠØ± Ø§Ù„Ø³ÙŠÙˆÙ„Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø£Ù…Ø± Ø§Ù„Ù…Ø³Ø­ Ù„Ù„Ù†ÙˆØ§Ø© (Ù…Ø­Ø§ÙƒØ§Ø©). Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù†Ø¸ÙŠÙØ©.");
                }
            } else {
                alert("â›” Ø´ÙØ±Ø© Ø®Ø§Ø·Ø¦Ø©!");
            }
        }

        // --- Ø·Ø¨Ø§Ø¹Ø© ---
        function printReport() {
            window.print();
        }

        // --- Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ ---
        let myChart = null;
        function initChart() {
            const ctx = document.getElementById('fleetChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù†Ø´Ø·', 'Ø·ÙˆØ§Ø±Ø¦', 'Ø§Ù†ØªØ¸Ø§Ø±'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: 'white' } } } }
            });
        }
        function updateChart() {
            if(!myChart) return;
            const active = captains.filter(c => c.emergency_used !== 'true').length;
            const emergency = captains.filter(c => c.emergency_used === 'true').length;
            myChart.data.datasets[0].data = [active, emergency, requests.length];
            myChart.update();
        }
    </script>
</body>
</html>
