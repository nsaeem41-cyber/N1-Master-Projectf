<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ (Ultimate Command)</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Ops Royal (Navy & Gold) - Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØ­Ø¯Ø© ================= */
        :root {
            --primary: #0f172a;      /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ Ø¹Ù…ÙŠÙ‚ */
            --accent: #1e293b;       /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ ÙØ§ØªØ­ Ù„Ù„ÙƒØ±ÙˆØª */
            --gold: #d4af37;         /* Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ */
            --bg: #0b1120;           /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ø¬Ø¯Ø§Ù‹ */
            --text: #e2e8f0;         /* Ù†Øµ ÙØ§ØªØ­ */
            --text-muted: #94a3b8;   /* Ù†Øµ Ø±Ù…Ø§Ø¯ÙŠ */
            --success: #10b981;      /* Ø£Ø®Ø¶Ø± */
            --danger: #ef4444;       /* Ø£Ø­Ù…Ø± */
            --warning: #f59e0b;      /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
            --input-bg: #334155;     /* Ø®Ù„ÙÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text); user-select: none; 
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .navbar { 
            background: rgba(15, 23, 42, 0.95); height: 70px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; border-bottom: 2px solid var(--gold); 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .brand { font-size: 24px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        
        .btn-close { 
            background: rgba(239, 68, 68, 0.1); color: var(--danger); 
            border: 1px solid var(--danger); padding: 8px 15px; 
            border-radius: 8px; cursor: pointer; transition: 0.3s; 
        }
        .btn-close:hover { background: var(--danger); color: white; }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .card { 
            background: var(--accent); border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            border: 1px solid #334155; overflow: hidden; 
        }
        .card-full { grid-column: span 2; } /* ÙƒØ±Øª Ø¹Ø±ÙŠØ¶ */

        .card-header { 
            padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 18px; font-weight: 800; color: var(--gold); display: flex; align-items: center; gap: 10px; }
        
        .card-body { padding: 25px; }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± (Dark Mode) */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px; color: var(--text-muted); }
        
        input, select { 
            width: 100%; padding: 12px; border: 1px solid #475569; border-radius: 10px; 
            outline: none; background: var(--input-bg); color: white; 
            font-size: 14px; box-sizing: border-box; transition: 0.3s; 
        }
        input:focus { border-color: var(--gold); background: #1e293b; }

        .btn-main { 
            width: 100%; padding: 12px; border: none; border-radius: 10px; 
            font-weight: bold; cursor: pointer; color: white; font-size: 15px; 
            transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-blue { background: #3b82f6; } .btn-blue:hover { background: #2563eb; }
        .btn-gold { background: var(--gold); color: black; } .btn-gold:hover { background: #b4932a; }
        .btn-green { background: var(--success); } .btn-green:hover { background: #059669; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { padding: 15px; text-align: right; color: var(--text-muted); border-bottom: 2px solid #334155; background: rgba(0,0,0,0.2); }
        td { padding: 15px; border-bottom: 1px solid #334155; color: var(--text); }
        tr:hover { background: rgba(255,255,255,0.05); }

        .badge { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; }
        .bg-active { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .bg-pending { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid var(--warning); }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… */
        .action-btn { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; opacity: 0.8; transition: 0.2s; }
        .action-btn:hover { opacity: 1; transform: scale(1.2); }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù…Ø®ÙÙŠØ© */
        .hidden-panel { display: none; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ± */
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .report-paper { background: white; color: black; width: 210mm; height: 90vh; padding: 40px; overflow-y: auto; position: relative; }
        
        @media print {
            body * { visibility: hidden; }
            #report-modal, #report-modal * { visibility: visible; }
            #report-modal { position: absolute; left: 0; top: 0; background: white; }
            .report-paper { width: 100%; height: auto; box-shadow: none; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Fleet Command ğŸ‘®â€â™‚ï¸</div>
        <div>
            <button onclick="toggleMerchantSim()" style="background:none; border:none; color:#64748b; font-size:12px; cursor:pointer;">(Merchant Sim)</button>
            <button class="btn-close" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚ âŒ</button>
        </div>
    </nav>

    <div class="container">

        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ø¨ØªÙ† Ø¬Ø¯ÙŠØ¯ (ØªØ¹ÙŠÙŠÙ†)</div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="new_cap_name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø±Ø³Ù…ÙŠ">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨)</label>
                    <input type="tel" id="new_cap_phone" placeholder="07xxxxxxxx">
                </div>
                <div class="form-group">
                    <label>ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© (User ID / Code)</label>
                    <input type="text" id="new_cap_code" placeholder="Ù…Ø«Ù„Ø§Ù‹: C-101" style="border-color:var(--gold);">
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1;">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                        <input type="text" id="new_cap_car" placeholder="Ù…Ø«Ù„Ø§Ù‹: Kia">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Ù…ÙˆØ¯ÙŠÙ„</label>
                        <input type="number" id="new_cap_model" placeholder="2020">
                    </div>
                </div>
                <button class="btn-main btn-blue" onclick="registerCaptain()">+ Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ¹ÙŠÙŠÙ†</button>
            </div>
        </div>

        <div class="card" style="border-top: 4px solid var(--gold);">
            <div class="card-header">
                <div class="card-title">ğŸ’° Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Wallet)</div>
                <label style="display:flex; align-items:center; gap:5px; font-size:12px; cursor:pointer;">
                    <input type="checkbox" id="transfer-toggle" onchange="toggleTransfer()" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                </label>
            </div>
            <div class="card-body">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="wallet_search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ù€ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„ØªØ±Ù…ÙŠØ²">
                    <button class="btn-main btn-blue" style="width:auto;" onclick="searchWallet()">Ø¨Ø­Ø«</button>
                </div>

                <div id="wallet-info" style="display:none; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="w_name" style="font-weight:bold; color:var(--gold);">---</span>
                        <span id="w_balance" style="font-size:20px; font-weight:bold; color:var(--success);">0.00 Ø¯.Ø£</span>
                    </div>
                    <div style="font-size:12px; color:var(--text-muted); margin-top:5px;">Code: <span id="w_code">--</span> | Tel: <span id="w_phone">--</span></div>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)</label>
                    <input type="number" id="wallet_amount" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-main btn-green" onclick="updateBalance('add')">â• Ø´Ø­Ù†</button>
                    <button class="btn-main" style="background:var(--danger);" onclick="updateBalance('deduct')">â– Ø®ØµÙ…</button>
                </div>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header">
                <div class="card-title">ğŸŒ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (Web Requests)</div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="requests-body">
                        <tr><td colspan="5" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header">
                <div class="card-title">ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø· (Active Fleet)</div>
                <input type="text" id="search-active" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." oninput="renderFleet()" style="width:200px; padding:8px;">
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø§Ù„ØªÙ‚ÙŠÙŠÙ…)</th>
                            <th>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Code/Tel)</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                            <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ØªØ­ÙƒÙ…</th>
                        </tr>
                    </thead>
                    <tbody id="fleet-body">
                        <tr><td colspan="6" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="merchant-sim" style="display:none; position:fixed; bottom:20px; right:20px; background:white; padding:20px; border-radius:15px; box-shadow:0 0 30px rgba(0,0,0,0.5); z-index:1500; width:300px; border:3px solid var(--gold);">
        <h3 style="color:#333; margin-top:0;">ğŸª Ù†Ù‚Ø·Ø© Ø´Ø­Ù† (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
        <input type="text" id="merch-cap-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ†" style="background:#eee; color:black; margin-bottom:10px;">
        <input type="number" id="merch-amount-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="background:#eee; color:black; margin-bottom:10px;">
        <button onclick="merchantCharge()" style="width:100%; padding:10px; background:var(--gold); border:none; border-radius:5px; font-weight:bold; cursor:pointer;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† âœ…</button>
        <button onclick="toggleMerchantSim()" style="width:100%; padding:5px; margin-top:5px; background:none; border:none; color:red; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="report-modal">
        <div class="report-paper">
            <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:20px; margin-bottom:20px;">
                <h1 style="margin:0;">N One Global Systems</h1>
                <h3>ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙƒØ§Ø¨ØªÙ† (Captain Statement)</h3>
                <p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <span id="rep-date"></span></p>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; background:#f5f5f5; padding:15px; border-radius:5px;">
                <div>
                    <strong>Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</strong> <span id="rep-name">---</span><br>
                    <strong>Ø§Ù„ØªØ±Ù…ÙŠØ²:</strong> <span id="rep-code">---</span>
                </div>
                <div style="text-align:left;">
                    <strong>Ø§Ù„Ø±ØµÙŠØ¯:</strong> <span id="rep-balance">0.00</span> Ø¯.Ø£<br>
                    <strong>Ø§Ù„Ù†Ø¬ÙˆÙ…:</strong> <span id="rep-stars">â­â­â­â­â­</span>
                </div>
            </div>

            <table style="width:100%; border:1px solid #ddd; color:black;">
                <thead style="background:#eee;">
                    <tr>
                        <th style="color:black; border:1px solid #ccc;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="color:black; border:1px solid #ccc;">Ø§Ù„Ù†ÙˆØ¹</th>
                        <th style="color:black; border:1px solid #ccc;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    </tr>
                </thead>
                <tbody id="rep-body"></tbody>
            </table>

            <div style="margin-top:40px; border-top:1px solid #ccc; padding-top:10px;">
                <small>Generated by N One System | Admin Signature: _________________</small>
            </div>

            <button class="no-print" onclick="window.print()" style="position:absolute; top:20px; right:20px; background:black; color:white; padding:10px 20px; border:none; cursor:pointer;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="no-print" onclick="closeReport()" style="position:absolute; top:20px; right:120px; background:red; color:white; padding:10px 20px; border:none; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // ========================================================
        // Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø± Ù„Ù„ÙƒØ¨Ø§ØªÙ† v9.0 (Ultimate Edition) ğŸ§ 
        // ========================================================
        
        if (typeof N_ONE_CORE !== 'undefined') {
            N_ONE_CORE.API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        }

        let allData = [];
        let captains = [];
        let requests = [];
        let orders = [];
        let currentWalletCap = null;

        window.onload = async function() {
            await refreshData();
        };

        async function refreshData() {
            try {
                // Ø³Ø­Ø¨ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø±Ø¨Ø· Ù…Ø¹ ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆÙ‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
                allData = await N_ONE_CORE.fetchData('read');
                
                // ØªØµÙ†ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                captains = allData.filter(i => i.type === 'captain' && i.status !== 'pending');
                requests = allData.filter(i => i.type === 'captain' && i.status === 'pending'); // Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆÙŠØ¨
                orders = allData.filter(i => i.type === 'order'); // Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±

                renderRequests();
                renderFleet();
                
            } catch (e) { console.error(e); }
        }

        // 1. ØªØ³Ø¬ÙŠÙ„ ÙŠØ¯ÙˆÙŠ (Appointment)
        async function registerCaptain() {
            const name = document.getElementById('new_cap_name').value;
            const phone = document.getElementById('new_cap_phone').value;
            const code = document.getElementById('new_cap_code').value;
            const car = document.getElementById('new_cap_car').value;
            
            if(!name || !phone || !code) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©!");

            const newCap = {
                id: "CAP_" + Date.now(),
                user: code, // Ø§Ù„ØªØ±Ù…ÙŠØ² Ù‡Ùˆ Ø§Ù„ÙŠÙˆØ²Ø±
                pass: "123456",
                name: name,
                role: "captain",
                type: "captain", // Ù„ØªØ¸Ù‡Ø± ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
                cap_phone: phone,
                status: "active",
                pickup: car, // Ù†Ø®Ø²Ù† Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù‡Ù†Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹
                balance: "0",
                emergency_used: "false",
                expiry: "2030-01-01"
            };

            await N_ONE_CORE.postData('add', [newCap]);
            alert("ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙˆØ§Ø¹ØªÙ…Ø§Ø¯Ù‡ âœ…");
            await refreshData();
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('new_cap_name').value = '';
            document.getElementById('new_cap_code').value = '';
            document.getElementById('new_cap_phone').value = '';
        }

        // 2. Ø§Ù„Ù…Ø­ÙØ¸Ø© (Wallet)
        function searchWallet() {
            const q = document.getElementById('wallet_search').value.toLowerCase();
            const cap = captains.find(c => c.user.toLowerCase() === q || c.cap_phone.includes(q));
            
            if(cap) {
                currentWalletCap = cap;
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('w_name').innerText = cap.name;
                document.getElementById('w_balance').innerText = (cap.balance || "0.00") + " Ø¯.Ø£";
                document.getElementById('w_code').innerText = cap.user;
                document.getElementById('w_phone').innerText = cap.cap_phone;
            } else {
                alert("ÙƒØ§Ø¨ØªÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ âŒ");
                document.getElementById('wallet-info').style.display = 'none';
                currentWalletCap = null;
            }
        }

        async function updateBalance(action) {
            if(!currentWalletCap) return;
            const val = parseFloat(document.getElementById('wallet_amount').value);
            if(!val) return;

            const oldBal = parseFloat(currentWalletCap.balance || 0);
            const newBal = action === 'add' ? oldBal + val : oldBal - val;

            if(confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newBal.toFixed(2)} Ø¯.Ø£ ØŸ`)) {
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±ÙØ±
                await N_ONE_CORE.postData('update', { user: currentWalletCap.user, data: { balance: newBal } });
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ğŸ’°");
                // Ø¥Ø¹Ø§Ø¯Ø© Ø´Ø­Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                await refreshData();
                searchWallet(); // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ÙØ¸Ø©
            }
        }

        function toggleTransfer() {
            const status = document.getElementById('transfer-toggle').checked;
            alert(status ? "ØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨ÙŠÙ† Ø§Ù„ÙƒØ¨Ø§ØªÙ†" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„");
            // ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ localStorage Ø£Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ±
        }

        // 3. Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆÙŠØ¨ (Requests)
        function renderRequests() {
            const tbody = document.getElementById('requests-body');
            if(requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            requests.forEach(req => {
                tbody.innerHTML += `
                    <tr>
                        <td>${req.name}</td>
                        <td>${req.cap_phone}</td>
                        <td>${req.pickup || '-'}</td>
                        <td><span class="badge bg-pending">Ø§Ù†ØªØ¸Ø§Ø±</span></td>
                        <td>
                            <button class="action-btn" style="color:var(--success);" onclick="approveReq('${req.user}')">âœ…</button>
                            <button class="action-btn" style="color:var(--danger);" onclick="rejectReq('${req.user}')">âŒ</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function approveReq(user) {
            if(confirm("Ù‚Ø¨ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¨ØªÙ†ØŸ")) {
                await N_ONE_CORE.postData('update', { user: user, data: { status: 'active' } });
                refreshData();
            }
        }

        // 4. Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø· (Fleet)
        function renderFleet() {
            const tbody = document.getElementById('fleet-body');
            const q = document.getElementById('search-active').value.toLowerCase();
            tbody.innerHTML = '';

            captains.forEach(cap => {
                if(q && !cap.name.toLowerCase().includes(q) && !cap.user.toLowerCase().includes(q)) return;

                // Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø¬ÙˆÙ… (Ù…Ø­Ø§ÙƒØ§Ø©)
                let stars = 'â­â­â­';
                if(parseFloat(cap.balance) > 50) stars = 'â­â­â­â­â­';

                // Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
                const emergBadge = (cap.emergency_used === 'true') 
                    ? '<span style="color:var(--danger); font-size:10px;">Ù…Ø³ØªÙ†ÙØ° âš ï¸</span>' 
                    : '<span style="color:var(--success); font-size:10px;">Ù…ØªØ§Ø­ âœ…</span>';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-weight:bold; color:white;">${cap.name}</div>
                            <div style="font-size:10px; color:var(--warning);">${stars}</div>
                        </td>
                        <td style="color:var(--gold); font-family:monospace;">${cap.user}<br>${cap.cap_phone}</td>
                        <td style="font-weight:bold; font-size:15px; color:var(--success);">${cap.balance || 0}</td>
                        <td>${emergBadge}</td>
                        <td>${cap.status === 'active' ? '<span class="badge bg-active">Ù†Ø´Ø·</span>' : '<span class="badge" style="color:red;">Ù…Ø¬Ù…Ø¯</span>'}</td>
                        <td>
                            <button class="action-btn" onclick="openReport('${cap.user}')" title="ØªÙ‚Ø±ÙŠØ±">ğŸ–¨ï¸</button>
                            <button class="action-btn" onclick="freezeCap('${cap.user}')" style="color:var(--danger);">â„ï¸</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function freezeCap(user) {
            if(confirm("ØªØ¬Ù…ÙŠØ¯/ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ø¨ØªÙ†ØŸ")) {
                // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ ÙŠØ­ØªØ§Ø¬ Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©ØŒ Ù‡Ù†Ø§ Ø§Ø®ØªØµØ§Ø±Ø§Ù‹ Ø³Ù†Ø±Ø³Ù„ paused
                await N_ONE_CORE.postData('update', { user: user, data: { status: 'paused' } }); // Ù…Ø«Ø§Ù„
                refreshData();
            }
        }

        // 5. Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© (Report)
        function openReport(user) {
            const cap = captains.find(c => c.user === user);
            if(!cap) return;

            document.getElementById('rep-name').innerText = cap.name;
            document.getElementById('rep-code').innerText = cap.user;
            document.getElementById('rep-balance').innerText = cap.balance || "0.00";
            document.getElementById('rep-date').innerText = new Date().toLocaleDateString();

            const tbody = document.getElementById('rep-body');
            tbody.innerHTML = '';
            
            // Ø¬Ù„Ø¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (Ops Room Integration)
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØªØ­Ù…Ù„ Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø£Ùˆ Ø±Ù‚Ù…Ù‡
            const myOrders = orders.filter(o => o.cap_name === cap.name || o.cap_phone === cap.cap_phone);

            if(myOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª</td></tr>';
            } else {
                myOrders.forEach(o => {
                    tbody.innerHTML += `
                        <tr>
                            <td style="border:1px solid #ddd; padding:5px;">${o.date.split('T')[0]}</td>
                            <td style="border:1px solid #ddd; padding:5px;">ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨</td>
                            <td style="border:1px solid #ddd; padding:5px;">${o.fee} Ø¯.Ø£</td>
                        </tr>
                    `;
                });
            }

            document.getElementById('report-modal').style.display = 'flex';
        }

        function closeReport() { document.getElementById('report-modal').style.display = 'none'; }

        // 6. Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ§Ø¬Ø± (Merchant Sim)
        function toggleMerchantSim() {
            const el = document.getElementById('merchant-sim');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function merchantCharge() {
            const code = document.getElementById('merch-cap-input').value;
            const amt = parseFloat(document.getElementById('merch-amount-input').value);
            
            const cap = captains.find(c => c.user === code);
            if(cap && amt) {
                if(confirm(`Ø£Ù†Ø§ ÙƒÙ…Ù†Ø´Ø£Ø©ØŒ Ø£Ø´Ø­Ù† Ù„Ù„ÙƒØ§Ø¨ØªÙ† ${cap.name} Ù…Ø¨Ù„Øº ${amt} Ø¯.Ø£ØŸ`)) {
                    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ†
                    const newBal = parseFloat(cap.balance || 0) + amt;
                    await N_ONE_CORE.postData('update', { user: cap.user, data: { balance: newBal } });
                    alert("ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­ Ù…Ù† Ù†Ù‚Ø·Ø© Ø§Ù„ØªØ§Ø¬Ø± âœ…");
                    toggleMerchantSim();
                    refreshData();
                }
            } else {
                alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©");
            }
        }

    </script>
</body>
</html>
