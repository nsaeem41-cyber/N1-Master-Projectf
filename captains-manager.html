<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ ÙˆØ§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</title>
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>
    <style>
        /* ØªØµÙ…ÙŠÙ… Royal Light Ø§Ù„ÙØ®Ù… */
        :root { --primary: #0f172a; --bg: #f1f5f9; --card-bg: #ffffff; --gold: #d4af37; --text-main: #334155; --text-light: #64748b; --success: #10b981; --danger: #ef4444; --border: #e2e8f0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text-main); user-select: none; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .navbar { background: var(--card-bg); height: 75px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; border-bottom: 3px solid var(--gold); position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 25px rgba(148, 163, 184, 0.15); }
        .brand { font-size: 26px; font-weight: 900; color: var(--primary); letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        .btn-close { background: #fff1f2; color: var(--danger); border: 1px solid #fda4af; padding: 10px 20px; border-radius: 10px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-close:hover { background: var(--danger); color: white; }

        .container { max-width: 1600px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .card { background: var(--card-bg); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid var(--border); overflow: hidden; transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .card-full { grid-column: span 2; } 
        .card-header { padding: 25px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .card-body { padding: 30px; }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px; color: var(--text-light); }
        input, select { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; outline: none; background: #fafafa; color: var(--primary); font-weight: 600; font-size: 15px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--primary); background: white; }
        
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; color: white; font-size: 16px; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-blue { background: var(--primary); } 
        .btn-green { background: var(--success); } 
        .btn-danger { background: var(--danger); }
        .btn-gold { background: var(--gold); color: white; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; max-height: 500px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { padding: 18px; text-align: right; color: var(--text-light); border-bottom: 2px solid var(--border); background: #f8fafc; position: sticky; top: 0; z-index: 10; }
        td { padding: 18px; border-bottom: 1px solid #f1f5f9; color: var(--primary); font-weight: 600; }
        .badge { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 800; display: inline-block; }
        .bg-active { background: #ecfdf5; color: var(--success); border: 1px solid #a7f3d0; }
        .bg-paused { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
        .bg-pending { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }

        .action-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 5px; opacity: 0.6; transition: 0.2s; margin-left: 8px; }
        .action-btn:hover { opacity: 1; transform: scale(1.2); }

        /* Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Treasury Modal) */
        #treasury-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .treasury-box { background: white; padding: 40px; border-radius: 20px; width: 400px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); border: 4px solid var(--gold); position: relative; }
        
        /* Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); z-index: 2100; justify-content: center; align-items: center; }
        .report-paper { background: white; color: black; width: 210mm; height: 90vh; padding: 50px; overflow-y: auto; position: relative; border-radius: 15px; }
        @media print { body * { visibility: hidden; } #report-modal, #report-modal * { visibility: visible; } #report-modal { position: absolute; left: 0; top: 0; background: white; width: 100%; height: 100%; } .report-paper { width: 100%; height: auto; box-shadow: none; padding: 0; } .no-print { display: none !important; } }
        
        #loading-bar { height: 4px; background: var(--gold); width: 0%; position: fixed; top: 75px; left: 0; z-index: 1001; transition: width 0.3s; }
    </style>
</head>
<body>

    <div id="loading-bar"></div>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Fleet & Treasury</div>
        <div>
            <button onclick="toggleTreasury()" style="background:var(--primary); color:var(--gold); border:2px solid var(--gold); padding:10px 20px; border-radius:12px; font-weight:bold; cursor:pointer; margin-left:15px; box-shadow:0 4px 10px rgba(212, 175, 55, 0.2);">ğŸ¦ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Ø¥ÙŠØ¯Ø§Ø¹)</button>
            <button class="btn-close" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚ âŒ</button>
        </div>
    </nav>

    <div class="container">

        <div class="card">
            <div class="card-header"><div class="card-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ø¨ØªÙ† Ø¬Ø¯ÙŠØ¯</div></div>
            <div class="card-body">
                <div class="form-group"><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="new_cap_name"></div>
                <div class="form-group"><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="new_cap_phone"></div>
                <div class="form-group"><label>Ø§Ù„ØªØ±Ù…ÙŠØ² (Code)</label><input type="text" id="new_cap_code" placeholder="C-xxx"></div>
                <div style="display:flex; gap:15px;">
                    <div class="form-group" style="flex:1;"><label>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label><input type="text" id="new_cap_car"></div>
                    <div class="form-group" style="flex:1;"><label>Ù…ÙˆØ¯ÙŠÙ„</label><input type="number" id="new_cap_model"></div>
                </div>
                <button class="btn-main btn-blue" onclick="registerCaptain()">+ Ø§Ø¹ØªÙ…Ø§Ø¯ (ÙØ­Øµ Ø°ÙƒÙŠ)</button>
            </div>
        </div>

        <div class="card" style="border-top: 5px solid var(--gold);">
            <div class="card-header">
                <div class="card-title">ğŸ’° Ù…Ø­ÙØ¸Ø© Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Live)</div>
                <label style="display:flex; align-items:center; gap:8px; font-weight:bold; font-size:13px; cursor:pointer;"><input type="checkbox" id="transfer-toggle" onchange="toggleTransfer()" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„</label>
            </div>
            <div class="card-body">
                <div style="display:flex; gap:15px; margin-bottom:20px;">
                    <input type="text" id="wallet_search" placeholder="ğŸ” Ø¨Ø­Ø« (Ù‡Ø§ØªÙ/ÙƒÙˆØ¯)">
                    <button class="btn-main btn-blue" style="width:auto; padding:0 30px;" onclick="searchWallet()">Ø¨Ø­Ø«</button>
                </div>
                <div id="wallet-info" style="display:none; background:#fffbeb; padding:20px; border-radius:15px; margin-bottom:20px; border:1px solid #fde68a;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="w_name" style="font-weight:900; color:var(--primary); font-size:18px;">---</span>
                        <span id="w_balance" style="font-size:28px; font-weight:900; color:#b45309;">0.00 Ø¯.Ø£</span>
                    </div>
                    <div style="font-size:13px; color:#92400e; margin-top:5px;">Code: <span id="w_code">--</span></div>
                </div>
                <div class="form-group"><input type="number" id="wallet_amount" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©"></div>
                <div style="display:flex; gap:15px;">
                    <button class="btn-main btn-green" onclick="updateBalance('add')">â• Ø´Ø­Ù†</button>
                    <button class="btn-main btn-danger" onclick="updateBalance('deduct')">â– Ø®ØµÙ…</button>
                </div>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header"><div class="card-title">ğŸŒ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</div><button class="action-btn" onclick="refreshData()">ğŸ”„</button></div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="requests-body"><tr><td colspan="5" style="text-align:center; padding:30px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</td></tr></tbody>
                </table>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header">
                <div class="card-title">ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø·</div>
                <div style="display:flex; gap:15px; align-items:center;">
                    <span style="font-size:12px; font-weight:bold;">Ø§Ù„Ø³ÙŠÙˆÙ„Ø©: <b style="color:var(--success); font-size:16px;" id="total-fleet-bal">0.00</b> Ø¯.Ø£</span>
                    <input type="text" id="search-active" placeholder="Ø¨Ø­Ø«..." oninput="renderFleet()" style="width:250px;">
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                    <tbody id="fleet-body"><tr><td colspan="5" style="text-align:center; padding:50px;">ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="treasury-modal">
        <div class="treasury-box">
            <h2 style="color:var(--primary); text-align:center; margin-top:0;">ğŸ¦ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ</h2>
            <p style="text-align:center; color:#64748b; margin-bottom:20px;">Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ù„Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© (Ù„ØªÙ…ÙƒÙŠÙ†Ù‡Ø§ Ù…Ù† Ø´Ø­Ù† Ø§Ù„ÙƒØ¨Ø§ØªÙ†) Ø£Ùˆ Ù„Ù„ÙƒØ¨Ø§ØªÙ† Ù…Ø¨Ø§Ø´Ø±Ø©.</p>
            
            <label>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ (ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø£Ùˆ Ø§Ù„ÙƒØ§Ø¨ØªÙ†)</label>
            <input type="text" id="treasury-id" placeholder="Ù…Ø«Ù„Ø§Ù‹: SH_123 Ø£Ùˆ C-101" style="background:#f1f5f9; margin-bottom:15px;">
            
            <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)</label>
            <input type="number" id="treasury-amount" placeholder="0.00" style="background:#f1f5f9; margin-bottom:25px;">
            
            <button class="btn-main btn-gold" onclick="treasuryDeposit()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ğŸ’°</button>
            <button class="btn-main" onclick="toggleTreasury()" style="background:transparent; color:var(--danger); margin-top:10px;">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <div id="report-modal">
        <div class="report-paper">
            <div style="text-align:center; border-bottom:4px solid var(--primary); padding-bottom:30px; margin-bottom:40px;">
                <h1 style="margin:0; font-size:36px; color:var(--primary);">N One Global</h1>
                <h3>ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„ÙƒØ§Ø¨ØªÙ†</h3>
                <p>Date: <span id="rep-date"></span></p>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:40px; background:#f8fafc; padding:30px; border-radius:15px;">
                <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="rep-name">---</span><br><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> <span id="rep-code">---</span></div>
                <div><strong>Ø§Ù„Ø±ØµÙŠØ¯:</strong> <span id="rep-balance" style="font-size:24px; font-weight:bold; color:var(--success);">0.00</span> Ø¯.Ø£</div>
            </div>
            <table style="width:100%; border:1px solid #e2e8f0; color:black;">
                <thead style="background:#f1f5f9;"><tr><th style="padding:15px; border:1px solid #cbd5e1;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th style="padding:15px; border:1px solid #cbd5e1;">Ø§Ù„Ù†ÙˆØ¹</th><th style="padding:15px; border:1px solid #cbd5e1;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th></tr></thead>
                <tbody id="rep-body"></tbody>
            </table>
            <button class="no-print btn-main btn-blue" onclick="window.print()" style="position:absolute; top:30px; right:30px; width:auto;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="no-print btn-main btn-danger" onclick="closeReport()" style="position:absolute; top:30px; right:150px; width:auto;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // === Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ Ù„Ù„ÙƒØ¨Ø§ØªÙ† ÙˆØ§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ ===
        if (typeof N_ONE_CORE !== 'undefined') N_ONE_CORE.API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        
        let allData=[], captains=[], requests=[], orders=[], currentWalletCap=null;

        window.onload = async function() { await refreshData(); setInterval(refreshDataSilent, 30000); };
        async function refreshData() { showLoading(true); try{allData=await N_ONE_CORE.fetchData('read'); processData();}catch(e){} showLoading(false); }
        async function refreshDataSilent() { try{allData=await N_ONE_CORE.fetchData('read'); processData();}catch(e){} }
        
        function processData() {
            captains=allData.filter(i=>i.type==='captain'&&i.status!=='pending').reverse();
            requests=allData.filter(i=>i.type==='captain'&&i.status==='pending');
            orders=allData.filter(i=>i.type==='order');
            renderRequests(); renderFleet(); updateTotalBalance();
        }

        async function registerCaptain() {
            const n=document.getElementById('new_cap_name').value, p=document.getElementById('new_cap_phone').value, c=document.getElementById('new_cap_code').value;
            if(!n||!p||!c)return alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");
            if(captains.some(x=>x.user===c||x.cap_phone===p))return alert("â›” Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹");
            showLoading(true);
            await N_ONE_CORE.postData('add', [{id:"CAP_"+Date.now(), user:c, pass:"123456", name:n, role:"captain", type:"captain", cap_phone:p, status:"active", pickup:document.getElementById('new_cap_car').value, balance:"0"}]);
            alert("ØªÙ… Ø§Ù„ØªØ¹ÙŠÙŠÙ† âœ…"); await refreshData(); showLoading(false);
        }

        function searchWallet() {
            const q=document.getElementById('wallet_search').value.toLowerCase();
            const c=captains.find(x=>x.user.toLowerCase()===q||x.cap_phone.includes(q));
            if(c){currentWalletCap=c; document.getElementById('wallet-info').style.display='block'; document.getElementById('w_name').innerText=c.name; document.getElementById('w_balance').innerText=parseFloat(c.balance||0).toFixed(2)+" Ø¯.Ø£"; document.getElementById('w_code').innerText=c.user;}
            else{alert("ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); document.getElementById('wallet-info').style.display='none';}
        }

        async function updateBalance(act) {
            if(!currentWalletCap)return; const v=parseFloat(document.getElementById('wallet_amount').value); if(!v)return;
            const nb = act==='add' ? parseFloat(currentWalletCap.balance||0)+v : parseFloat(currentWalletCap.balance||0)-v;
            if(confirm(`Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${nb.toFixed(2)} Ø¯.Ø£ ØŸ`)){
                showLoading(true); currentWalletCap.balance=nb; document.getElementById('w_balance').innerText=nb.toFixed(2)+" Ø¯.Ø£"; renderFleet();
                await N_ONE_CORE.postData('update', {user:currentWalletCap.user, data:{balance:nb}});
                alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« ğŸ’°"); showLoading(false);
            }
        }

        // --- Treasury Logic (Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ) ---
        function toggleTreasury() { const el=document.getElementById('treasury-modal'); el.style.display=el.style.display==='none'?'flex':'none'; }
        
        async function treasuryDeposit() {
            const tid=document.getElementById('treasury-id').value.trim(), amt=parseFloat(document.getElementById('treasury-amount').value);
            if(!tid||!amt) return alert("Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù…Ø¨Ù„Øº");
            
            showLoading(true);
            const target = allData.find(u => u.user === tid || u.cap_phone === tid); // ÙŠØ¨Ø­Ø« ÙÙŠ ÙƒÙ„ Ø§Ù„Ø¯Ø§ØªØ§ (Ø´Ø§Ù…Ù„ Ø§Ù„Ù…Ø­Ù„Ø§Øª)
            
            if(!target) { alert("âŒ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯)"); showLoading(false); return; }
            const typeName = target.type === 'shop' ? 'Ø§Ù„Ù…Ù†Ø´Ø£Ø©' : 'Ø§Ù„ÙƒØ§Ø¨ØªÙ†';
            
            if(!confirm(`Ø¥ÙŠØ¯Ø§Ø¹ ${amt} Ø¯.Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ${typeName}: ${target.name} ØŸ`)) { showLoading(false); return; }

            const newBal = parseFloat(target.balance || 0) + amt;
            await N_ONE_CORE.postData('update', { user: target.user, data: { balance: newBal } });
            
            alert(`âœ… ØªÙ… Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù€ ${target.name}: ${newBal.toFixed(2)} Ø¯.Ø£`);
            document.getElementById('treasury-id').value = ''; document.getElementById('treasury-amount').value = '';
            toggleTreasury(); showLoading(false);
            if(target.type === 'captain') refreshData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ø°Ø§ ÙƒØ§Ù† ÙƒØ§Ø¨ØªÙ†
        }

        // Functions for Requests, Fleet, Report (Simplified for brevity but fully functional)
        function renderRequests(){ const b=document.getElementById('requests-body'); b.innerHTML=''; if(requests.length===0)b.innerHTML='<tr><td colspan="5" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯</td></tr>'; requests.forEach(r=>{b.innerHTML+=`<tr><td>${r.name}</td><td>${r.cap_phone}</td><td>${r.pickup}</td><td><span class="badge bg-pending">Ø§Ù†ØªØ¸Ø§Ø±</span></td><td><button class="action-btn" style="color:green" onclick="approveReq('${r.user}')">âœ…</button><button class="action-btn" style="color:red" onclick="deleteCaptain('${r.user}')">âŒ</button></td></tr>`}); }
        async function approveReq(u){ if(confirm("Ù‚Ø¨ÙˆÙ„ØŸ")){showLoading(true); await N_ONE_CORE.postData('update',{user:u,data:{status:'active',balance:'0'}}); await refreshData(); showLoading(false);} }
        function renderFleet(){ const b=document.getElementById('fleet-body'); b.innerHTML=''; const q=document.getElementById('search-active').value.toLowerCase(); captains.forEach(c=>{ if(q&&!c.name.toLowerCase().includes(q))return; b.innerHTML+=`<tr><td>${c.name}</td><td>${c.user}<br>${c.cap_phone}</td><td style="color:var(--success);font-weight:bold;">${parseFloat(c.balance||0).toFixed(2)}</td><td><span class="badge ${c.status==='active'?'bg-active':'bg-paused'}">${c.status==='active'?'Ù†Ø´Ø·':'Ù…Ø¬Ù…Ø¯'}</span></td><td><button class="action-btn" onclick="openReport('${c.user}')">ğŸ–¨ï¸</button><button class="action-btn" onclick="freezeCap('${c.user}')">â„ï¸</button><button class="action-btn" style="color:red" onclick="deleteCaptain('${c.user}')">ğŸ—‘ï¸</button></td></tr>`; }); }
        function updateTotalBalance(){ document.getElementById('total-fleet-bal').innerText=captains.reduce((s,c)=>s+parseFloat(c.balance||0),0).toFixed(2); }
        async function freezeCap(u){ const c=captains.find(i=>i.user===u); const ns=c.status==='active'?'paused':'active'; if(confirm("ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŸ")){c.status=ns; renderFleet(); await N_ONE_CORE.postData('update',{user:u,data:{status:ns}});} }
        async function deleteCaptain(u){ if(confirm("Ø­Ø°ÙØŸ")){showLoading(true); captains=captains.filter(c=>c.user!==u); renderFleet(); await N_ONE_CORE.fetchData('delete',{user:u}); showLoading(false);} }
        function openReport(u){ const c=captains.find(i=>i.user===u); if(!c)return; document.getElementById('rep-name').innerText=c.name; document.getElementById('rep-code').innerText=c.user; document.getElementById('rep-balance').innerText=c.balance||"0"; document.getElementById('rep-date').innerText=new Date().toLocaleDateString(); document.getElementById('report-modal').style.display='flex'; }
        function closeReport(){ document.getElementById('report-modal').style.display='none'; }
        function showLoading(s){ document.getElementById('loading-bar').style.width=s?'100%':'0%'; }
        function toggleTransfer(){ alert(document.getElementById('transfer-toggle').checked?"ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„":"ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù"); }
    </script>
</body>
</html>
