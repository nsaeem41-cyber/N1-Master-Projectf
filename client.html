<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</title>
    <style>
        /* ================= Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f6f8;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .main-container {
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            padding-bottom: 80px;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .brand-text span { font-weight: 800; font-size: 26px; }
        .n-char { color: #1a237e; }
        .one-word { color: #d4af37; }

        .settings-btn {
            font-size: 24px; color: #555; cursor: pointer;
            background: none; border: none; transition: 0.3s;
        }
        .settings-btn:hover { color: #1a237e; transform: rotate(90deg); }

        .comp-name {
            text-align: center; color: #1a237e; font-size: 18px;
            font-weight: bold; margin-bottom: 20px;
            background: #e8eaf6; padding: 10px; border-radius: 8px;
        }

        /* ================= Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) ================= */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #fff; z-index: 2000; overflow-y: auto;
            padding: 20px; box-sizing: border-box;
        }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;
        }

        .modal-title { font-size: 20px; font-weight: bold; color: #1a237e; }
        .close-btn { font-size: 24px; color: #c62828; cursor: pointer; font-weight: bold; border: none; background: none; }

        /* ================= Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø·Ù„Ø¨ ================= */
        .input-group { margin-bottom: 15px; position: relative; }
        
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #555; }

        input, select {
            width: 100%; padding: 14px;
            border: 1px solid #ddd; border-radius: 10px;
            font-size: 15px; box-sizing: border-box; outline: none;
            text-align: right; background-color: #fff;
            transition: 0.3s;
        }
        input:focus, select:focus { border-color: #1a237e; box-shadow: 0 0 0 3px rgba(26, 35, 126, 0.1); }

        /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
        .btn-send {
            width: 100%; padding: 18px;
            background: linear-gradient(135deg, #1a237e 0%, #0d47a1 100%);
            color: white; border: none; border-radius: 12px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            margin-top: 10px; box-shadow: 0 10px 20px rgba(26, 35, 126, 0.2);
        }
        .btn-send:hover { transform: translateY(-2px); }

        /* ================= Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ¨Ø§ØªÙ† ================= */
        .captain-select-wrapper { display: flex; gap: 10px; }
        .btn-add-cap {
            background: #d4af37; color: white; border: none; border-radius: 8px;
            width: 50px; font-size: 20px; cursor: pointer;
        }

        /* ================= Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ================= */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #1a237e; color: white; padding: 10px; font-size: 12px; }
        td { border-bottom: 1px solid #eee; padding: 10px; font-size: 13px; text-align: center; }
        
        .btn-action { padding: 5px 10px; border-radius: 5px; color: white; border: none; cursor: pointer; font-size: 11px; margin: 2px; }
        .btn-edit { background: #1976d2; }
        .btn-del { background: #d32f2f; }

        /* ================= Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ================= */
        .chart-bar { background: #eee; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .chart-fill { height: 100%; background: #d4af37; width: 0%; transition: 1s; }
        .chart-label { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; font-weight: bold; }

        /* ================= Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø³ÙÙ„ÙŠØ© ================= */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 15px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); border-top: 1px solid #eee;
        }
        .nav-item { text-align: center; color: #777; cursor: pointer; font-size: 12px; }
        .nav-item span { display: block; font-size: 20px; margin-bottom: 5px; }
        .nav-item.active { color: #1a237e; font-weight: bold; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <h2 style="color:#1a237e;">Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</h2>
    </div>

    <div class="main-container">
        
        <div class="header">
            <button class="settings-btn" onclick="openModal('settings-modal')">âš™ï¸</button>
            <div class="brand-text">
                <span class="n-char">N</span><span class="one-word">One</span>
            </div>
        </div>

        <div class="comp-name">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ <span id="display-name">...</span></div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <div style="flex:1; background:white; padding:15px; border-radius:10px; text-align:center; border-bottom:4px solid #d4af37; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="font-size:12px; color:#777;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                <div id="today-count" style="font-size:20px; font-weight:bold; color:#1a237e;">0</div>
            </div>
            <div style="flex:1; background:white; padding:15px; border-radius:10px; text-align:center; border-bottom:4px solid #1a237e; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="font-size:12px; color:#777;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
                <div id="today-total" style="font-size:20px; font-weight:bold; color:#1a237e;">0.00</div>
            </div>
        </div>

        <div style="background:white; padding:25px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
            <h3 style="margin-top:0; color:#1a237e; border-bottom:1px solid #eee; padding-bottom:10px;">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h3>

            <div class="input-group">
                <label>Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨)</label>
                <div class="captain-select-wrapper">
                    <select id="captain_select">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ø¨ØªÙ† --</option>
                    </select>
                    <button class="btn-add-cap" onclick="openModal('captains-modal')">+</button>
                </div>
            </div>

            <div class="input-group">
                <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨ (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                <input type="text" id="mandoob_name" readonly style="background:#f9f9f9;">
            </div>

            <div class="input-group">
                <label>Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ­Ù…ÙŠÙ„</label>
                <input type="text" id="pickup_loc" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… / Ø§Ù„Ù…ØªØ¬Ø±">
            </div>

            <div class="input-group">
                <label>Ø£Ø¬Ø±Ø© Ø§Ù„ØªÙˆØµÙŠÙ„</label>
                <input type="number" id="delivery_fee" placeholder="0.00">
            </div>

            <div class="input-group">
                <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø´Ø­Ù†Ø©</label>
                <input type="number" id="shipment_val" placeholder="0.00">
            </div>

            <button class="btn-send" onclick="processOrder()">Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
        </div>

    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="closeAllModals()">
            <span>ğŸ </span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </div>
        <div class="nav-item" onclick="openRecords()">
            <span>ğŸ“</span>Ø§Ù„Ø³Ø¬Ù„
        </div>
        <div class="nav-item" onclick="openReports()">
            <span>ğŸ“Š</span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
        </div>
        <div class="nav-item" onclick="openModal('captains-modal')">
            <span>ğŸ‘¨â€âœˆï¸</span>Ø§Ù„ÙƒØ¨Ø§ØªÙ†
        </div>
    </div>

    <div id="captains-modal" class="modal">
        <div class="modal-header">
            <button class="close-btn" onclick="closeModal('captains-modal')">âœ–</button>
            <div class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ¨Ø§ØªÙ†</div>
        </div>
        <div class="input-group">
            <input type="text" id="new_cap_name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†">
        </div>
        <div class="input-group">
            <input type="tel" id="new_cap_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 079...)">
        </div>
        <button class="btn-send" onclick="addNewCaptain()" style="background:#2e7d32;">Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø¨ØªÙ† Ø¬Ø¯ÙŠØ¯</button>
        
        <h4 style="margin-top:30px;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h4>
        <div id="captains-list-container"></div>
    </div>

    <div id="records-modal" class="modal">
        <div class="modal-header">
            <button class="close-btn" onclick="closeModal('records-modal')">âœ–</button>
            <div class="modal-title">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
        </div>
        <div style="overflow-x:auto;">
            <table id="records-table">
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>ØªØ­ÙƒÙ…</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="reports-modal" class="modal">
        <div class="modal-header">
            <button class="close-btn" onclick="closeModal('reports-modal')">âœ–</button>
            <div class="modal-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
        </div>
        <div style="background:#fafafa; padding:15px; border-radius:10px; margin-bottom:20px;">
            <h4>Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… (Ù…Ø³ØªÙ‡Ø¯Ù 50 Ø·Ù„Ø¨)</h4>
            <div class="chart-label"><span>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span><span id="chart-orders-val">0</span></div>
            <div class="chart-bar"><div id="chart-orders-fill" class="chart-fill" style="width:0%"></div></div>
            <div class="chart-label"><span>Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</span><span id="chart-money-val">0 Ø¯.Ø£</span></div>
            <div class="chart-bar"><div id="chart-money-fill" class="chart-fill" style="width:0%; background:#1a237e;"></div></div>
        </div>
        <table border="1" style="border-color:#eee;">
            <tr><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</td><td id="rep-delivery">0.00</td></tr>
            <tr><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù†Ø§Øª</td><td id="rep-shipment">0.00</td></tr>
            <tr style="background:#e8f5e9; font-weight:bold;"><td>Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„ÙƒÙ„ÙŠ</td><td id="rep-total">0.00</td></tr>
        </table>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-header">
            <button class="close-btn" onclick="closeModal('settings-modal')">âœ–</button>
            <div class="modal-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
        </div>
        <button class="btn-send" style="background:#c62828;" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <script>
        // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Google Apps Script) ğŸ˜ŠğŸ’
        const API_URL = "https://script.google.com/macros/s/AKfycbz1dRYK_ga6arLxYQQovYlLvdoC5R7fupAP02L5Fe4qV9TWKmLlfvG2zyyDMzu91UGv/exec";
        
        let allData = [];
        let captains = [];
        let orders = [];
        let currentUser = null;

        window.onload = async function() {
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) { window.location.href = 'index.html'; return; }
            document.getElementById('display-name').innerText = currentUser.name;
            
            await loadAllData();
            document.getElementById('loading-screen').style.display = 'none';

            // ØªØ´ØºÙŠÙ„ "Ø§Ù„Ø¬Ø§Ø³ÙˆØ³" Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠØ©
            startWatchdog(); 
        };

        // ================= ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø§Ø³ÙˆØ³ (Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙÙˆØ±ÙŠØ©) =================
        function startWatchdog() {
            // ÙƒÙ„ 15 Ø«Ø§Ù†ÙŠØ© ÙŠØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨
            setInterval(async function() {
                try {
                    // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„ÙØ­Øµ Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    const response = await fetch(API_URL + "?action=read");
                    const data = await response.json();
                    
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                    const freshUser = data.find(u => u.user === currentUser.user);

                    if (freshUser) {
                        
                        // 1. Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
                        if (freshUser.status !== 'active') {
                            alert("â›” ØªÙ†Ø¨ÙŠÙ‡:\nØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.\nÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø´Ø±ÙƒØ©.");
                            logout();
                        }
                        
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ù„Ùˆ ØªØºÙŠØ±
                        document.getElementById('display-name').innerText = freshUser.name;
                        
                    } else {
                        // 2. Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡)
                        alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ:\nØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù….\nØ³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙˆØ±Ø§Ù‹.");
                        logout();
                    }
                } catch (e) {
                    console.log("Network glitch, skipping check...");
                }
            }, 15000); // 15000 Ù…ÙŠÙ„ÙŠ Ø«Ø§Ù†ÙŠØ© = 15 Ø«Ø§Ù†ÙŠØ©
        }

        // ================= Ø¨Ø§Ù‚ÙŠ ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù†Ø¸Ø§Ù… =================
        async function loadAllData() {
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… action=read
                const res = await fetch(API_URL + "?action=read");
                allData = await res.json();
                
                captains = allData.filter(item => item.type === 'captain');
                orders = allData.filter(item => item.type === 'order' && item.client_user === currentUser.user);
                
                updateCaptainsDropdown();
                updateDashboard();
            } catch (e) { console.error(e); }
        }

        function updateCaptainsDropdown() {
            const select = document.getElementById('captain_select');
            select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ø¨ØªÙ† --</option>';
            const listContainer = document.getElementById('captains-list-container');
            let tableHTML = '<table><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø­Ø°Ù</th></tr>';

            captains.forEach(cap => {
                const opt = document.createElement('option');
                opt.value = cap.phone;
                opt.text = cap.name;
                opt.dataset.name = cap.name;
                select.appendChild(opt);

                tableHTML += `<tr><td>${cap.name}</td><td>${cap.phone}</td><td><button class="btn-action btn-del" onclick="deleteItem('${cap.id}')">âœ–</button></td></tr>`;
            });
            tableHTML += '</table>';
            listContainer.innerHTML = captains.length ? tableHTML : '<p style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ†</p>';

            select.onchange = function() {
                const selectedOpt = select.options[select.selectedIndex];
                document.getElementById('mandoob_name').value = selectedOpt.dataset.name || '';
            };
        }

        async function addNewCaptain() {
            const name = document.getElementById('new_cap_name').value;
            const phone = document.getElementById('new_cap_phone').value;
            if(!name || !phone) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

            const newCap = {
                id: "CAP_" + Date.now(),
                type: "captain",
                name: name,
                phone: phone,
                client_user: currentUser.user
            };

            await saveDataToApi(newCap);
            document.getElementById('new_cap_name').value = '';
            document.getElementById('new_cap_phone').value = '';
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØ§Ø¨ØªÙ†");
            await loadAllData();
        }

        async function processOrder() {
            const capPhone = document.getElementById('captain_select').value;
            const capName = document.getElementById('mandoob_name').value;
            const pickup = document.getElementById('pickup_loc').value;
            const fee = document.getElementById('delivery_fee').value;
            const val = document.getElementById('shipment_val').value;

            if(!capPhone || !pickup) return alert("Ø§Ø®ØªØ± Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹");

            const newOrder = {
                id: "ORD_" + Date.now(),
                type: "order",
                client_user: currentUser.user,
                date: new Date().toISOString(),
                cap_name: capName,
                cap_phone: capPhone,
                pickup: pickup,
                fee: fee,
                val: val
            };

            const btn = document.querySelector('.btn-send');
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
            btn.disabled = true;

            await saveDataToApi(newOrder);
            sendToWhatsApp(capPhone, capName, pickup, fee, val);

            btn.innerText = "Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸš€";
            btn.disabled = false;
            document.getElementById('pickup_loc').value = '';
            document.getElementById('delivery_fee').value = '';
            document.getElementById('shipment_val').value = '';
            await loadAllData();
        }

        function sendToWhatsApp(phone, name, pickup, fee, val) {
            let p = phone.replace(/\D/g, '');
            if (p.startsWith('0')) p = p.substring(1);
            if (!p.startsWith('962')) p = '962' + p;

            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(pickup)}`;
            const msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ N One* ğŸ“¦\nğŸ‘¤ Ø§Ù„ÙƒØ§Ø¨ØªÙ†: ${name}\nğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${pickup}\nğŸ—ºï¸ Ø§Ù„Ø±Ø§Ø¨Ø·: \n${mapLink}\nğŸ’µ ØªÙˆØµÙŠÙ„: ${fee}\nğŸ’° Ø´Ø­Ù†Ø©: ${val}\nğŸš€ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒÙŠØ¯`;
            
            window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function openRecords() {
            openModal('records-modal');
            const tbody = document.querySelector('#records-table tbody');
            tbody.innerHTML = '';
            const sorted = orders.sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(ord => {
                const date = new Date(ord.date).toLocaleDateString('ar-EG');
                tbody.innerHTML += `<tr><td>${date}</td><td>${ord.cap_name}</td><td>${ord.val}</td><td><button class="btn-action btn-del" onclick="deleteItem('${ord.id}')">Ø­Ø°Ù</button></td></tr>`;
            });
        }

        function openReports() {
            openModal('reports-modal');
            let totalFee = 0, totalVal = 0;
            orders.forEach(o => { totalFee += parseFloat(o.fee || 0); totalVal += parseFloat(o.val || 0); });

            document.getElementById('rep-delivery').innerText = totalFee.toFixed(2);
            document.getElementById('rep-shipment').innerText = totalVal.toFixed(2);
            document.getElementById('rep-total').innerText = (totalFee + totalVal).toFixed(2);

            const count = orders.length;
            const countPct = Math.min((count / 50) * 100, 100);
            document.getElementById('chart-orders-val').innerText = count;
            document.getElementById('chart-orders-fill').style.width = countPct + "%";

            const moneyPct = Math.min(((totalFee + totalVal) / 1000) * 100, 100);
            document.getElementById('chart-money-val').innerText = (totalFee + totalVal).toFixed(2);
            document.getElementById('chart-money-fill').style.width = moneyPct + "%";
        }

        function updateDashboard() {
            const today = new Date().toLocaleDateString('en-CA');
            const todayOrders = orders.filter(o => o.date.startsWith(today));
            document.getElementById('today-count').innerText = todayOrders.length;
            let total = 0;
            todayOrders.forEach(o => total += parseFloat(o.fee || 0) + parseFloat(o.val || 0));
            document.getElementById('today-total').innerText = total.toFixed(2);
        }

        async function saveDataToApi(obj) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… action=add
            await fetch(API_URL + "?action=add", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: [obj] })
            });
        }

        async function deleteItem(id) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… action=delete Ù…Ø¹ id
            await fetch(API_URL + "?action=delete&id=" + id, { method: 'POST' });
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù");
            await loadAllData();
            if(document.getElementById('records-modal').style.display === 'block') openRecords();
            if(document.getElementById('captains-modal').style.display === 'block') updateCaptainsDropdown();
        }

        function openModal(id) { closeAllModals(); document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function closeAllModals() { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function logout() { localStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
    </script>
</body>
</html>
