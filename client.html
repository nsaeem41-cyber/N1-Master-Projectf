<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Command Center (Split Screen) ================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #eef2f5; margin: 0; padding: 0;
            user-select: none; height: 100vh; overflow: hidden; /* Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„ØµÙØ­Ø© ÙƒØ§Ù…Ù„Ø© */
            display: flex; flex-direction: column;
        }

        /* 1. Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ (Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª) */
        .top-bar {
            background: #1a237e; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 1000;
        }
        .brand { font-size: 20px; font-weight: 900; }
        .gold { color: #d4af37; }
        
        /* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø³Ø¨Ø© */
        .finance-controls { display: flex; gap: 10px; align-items: center; }
        .finance-input {
            width: 60px; padding: 5px; border-radius: 5px; border: none;
            text-align: center; font-weight: bold; color: #1a237e;
        }
        .btn-reset {
            background: #c62828; color: white; border: none; padding: 5px 10px;
            border-radius: 5px; cursor: pointer; font-size: 12px;
        }

        /* 2. ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø´Ø§Ø´Ø© (Split Screen) */
        .main-layout {
            display: flex; flex: 1; height: calc(100vh - 60px);
        }

        /* Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠÙ…Ù†: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
        .right-panel {
            width: 40%; background: white; padding: 20px;
            overflow-y: auto; border-left: 2px solid #ddd;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
        }

        /* Ø§Ù„Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±: Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù„Ø­Ø¸ÙŠ */
        .left-panel {
            width: 60%; background: #f4f7f6; padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column;
        }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .card-title {
            font-size: 18px; font-weight: bold; color: #1a237e;
            border-bottom: 2px solid #d4af37; padding-bottom: 10px; margin-bottom: 15px;
        }
        .input-group { margin-bottom: 12px; }
        label { display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
            font-size: 14px; background: #fafafa; outline: none; box-sizing: border-box;
        }
        input:focus { border-color: #1a237e; background: white; }

        .btn-send {
            width: 100%; padding: 15px; background: #1a237e; color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        .btn-send:hover { background: #0d155a; transform: scale(1.02); }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø³Ø¬Ù„ (Ø§Ù„ÙŠØ³Ø§Ø±) */
        .log-card {
            background: white; padding: 15px; border-radius: 10px;
            margin-bottom: 10px; border-right: 4px solid #1a237e;
            display: flex; justify-content: space-between; align-items: center;
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .log-info { font-size: 13px; color: #333; }
        .log-finance { font-size: 12px; color: #2e7d32; font-weight: bold; }
        .log-time { font-size: 11px; color: #888; }

        /* Ù„ÙˆØ­Ø© Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Finance Dashboard) */
        .finance-dashboard {
            background: #fff3e0; padding: 15px; border-radius: 10px;
            margin-bottom: 20px; border: 1px solid #ffe0b2;
        }
        .finance-item {
            display: flex; justify-content: space-between; border-bottom: 1px solid #eee;
            padding: 5px 0; font-size: 13px;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ */
        .legacy-hidden { display: none; }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 5000; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="loader">
        <h2 style="color:#1a237e;">N <span style="color:#d4af37">One</span></h2>
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª... ğŸ˜ŠğŸš€</p>
    </div>

    <div class="top-bar">
        <div class="brand">N <span class="gold">One</span> Admin</div>
        <div class="finance-controls">
            <span style="font-size:12px;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© (%):</span>
            <input type="number" id="company_percentage" class="finance-input" value="10" onchange="saveSettings()">
            <button class="btn-reset" onclick="resetFinanceWeek()">ğŸ”„ ØªØµÙÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
            <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer; font-size:18px;">ğŸ”’</button>
        </div>
    </div>

    <div class="main-layout">
        
        <div class="left-panel">
            <div class="finance-dashboard">
                <h4 style="margin:0 0 10px 0; color:#e65100;">ğŸ’° Ù…Ø³ØªØ­Ù‚Ø§Øª Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©)</h4>
                <div id="finance-list">
                    <div style="text-align:center; color:#777;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø³Ø¬Ù„Ø© Ø¨Ø¹Ø¯</div>
                </div>
            </div>

            <h4 style="margin:0 0 10px 0; color:#555;">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª (Live Feed)</h4>
            <div id="live-feed">
                </div>
        </div>

        <div class="right-panel">
            <div class="card-title">ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸ“¦</div>

            <div class="input-group">
                <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†</label>
                <input type="text" id="manual_cap_name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø­Ù…Ø¯ Ø£Ø­Ù…Ø¯">
            </div>

            <div class="input-group">
                <label>ğŸ“± Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„ÙƒØ§Ø¨ØªÙ†</label>
                <input type="tel" id="manual_cap_phone" placeholder="079...">
            </div>

            <div class="input-group">
                <label>ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… / Ø§Ù„Ù…Ù†Ø´Ø£Ø© (Ø¨Ø­Ø« ØªÙ„Ù‚Ø§Ø¦ÙŠ)</label>
                <input type="text" id="pickup_name" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ø¨Ø­Ø« ÙÙŠ Ø®Ø±Ø§Ø¦Ø· Ø¬ÙˆØ¬Ù„">
            </div>

            <div class="input-group">
                <label>ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„ØªØ­ØµÙŠÙ„)</label>
                <input type="number" id="order_val" placeholder="0.00">
            </div>

            <div class="input-group">
                <label>ğŸ›µ Ù‚ÙŠÙ…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„ (Ù„Ù„Ø¹Ù…ÙŠÙ„)</label>
                <input type="number" id="delivery_fee" placeholder="0.00">
            </div>

            <button class="btn-send" onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ ÙˆØªÙˆØ«ÙŠÙ‚ ğŸš€</button>

            <div class="legacy-hidden">
                <select id="captain_select"></select>
                <input type="text" id="pickup_loc_link"> <input type="text" id="cust_name" value="General">
                <input type="text" id="cust_phone" value="000">
            </div>
        </div>
    </div>

    <audio id="alert-sound" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycby8Lvhri3wDGXFwXY2EPKy_sf6vrIEAyPVGreob8gDe_mx9EbpqWsqqR511LXdqjjU1/exec";
        
        let currentUser = null;
        let myData = []; 
        let orders = [];
        let captainsDues = {}; // Ø³Ø¬Ù„ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª

        window.onload = async function() {
            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©
            if(localStorage.getItem('nOne_percent')) {
                document.getElementById('company_percentage').value = localStorage.getItem('nOne_percent');
            }
            if(localStorage.getItem('nOne_dues')) {
                captainsDues = JSON.parse(localStorage.getItem('nOne_dues'));
                updateFinanceDisplay();
            }

            currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (!currentUser) { window.location.replace('index.html'); return; }

            await refreshData();
            document.getElementById('loader').style.display = 'none';
            setInterval(checkMyStatus, 10000); 
        };

        async function refreshData() {
            try {
                const res = await fetch(API_URL + "?action=read");
                const all = await res.json();
                myData = all.filter(item => (item.cl || item.client_user) === currentUser.user);
                orders = myData.filter(i => i.type === 'order');
                updateLiveFeed();
            } catch (e) { console.error(e); }
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù„Ø­Ø¸ÙŠ (Ø§Ù„ÙŠØ³Ø§Ø±)
        function updateLiveFeed() {
            const feed = document.getElementById('live-feed');
            feed.innerHTML = orders.slice().reverse().map(o => `
                <div class="log-card">
                    <div>
                        <div style="font-weight:bold; color:#1a237e;">${o.cap_name}</div>
                        <div class="log-info">${o.pickup.split('=')[1] || 'Ù…ÙˆÙ‚Ø¹'} | ${o.val} Ø¯.Ø£</div>
                    </div>
                    <div style="text-align:left;">
                        <div class="log-finance">Ø§Ù„ØªÙˆØµÙŠÙ„: ${o.fee}</div>
                        <div class="log-time">${o.date.split('T')[1].substring(0,5)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function sendOrder() {
            // 1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            const capName = document.getElementById('manual_cap_name').value;
            const capPhone = document.getElementById('manual_cap_phone').value;
            const shopName = document.getElementById('pickup_name').value;
            const val = document.getElementById('order_val').value;
            const fee = document.getElementById('delivery_fee').value;
            
            // 2. Ø§Ù„ØªØ­Ù‚Ù‚
            if(!capName || !shopName || !val || !fee) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© ÙŠØ§ Ø­Ø¨Ø© Ø§Ù„Ø³ÙƒØ± ğŸ˜Š");

            // 3. ØªÙˆÙ„ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Google Maps Search Link)
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(shopName)}`;
            document.getElementById('pickup_loc_link').value = mapLink; // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙŠÙƒÙ„

            // 4. Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©)
            const percent = document.getElementById('company_percentage').value;
            const companyShare = (fee * (percent / 100)).toFixed(2);
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø§Øª
            if(!captainsDues[capName]) captainsDues[capName] = 0;
            captainsDues[capName] += parseFloat(companyShare);
            localStorage.setItem('nOne_dues', JSON.stringify(captainsDues));
            updateFinanceDisplay();

            // 5. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
            const newOrder = {
                id: "ORD_" + Date.now(),
                type: "order",
                client_user: currentUser.user,
                cl_name: currentUser.name,
                
                cap_name: capName,
                cap_phone: capPhone,
                pickup: mapLink, // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ„Ø¯
                
                val: val,
                fee: fee,
                company_share: companyShare, // Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„ØªÙˆØ«ÙŠÙ‚
                
                cust_name: "General",
                cust_phone: "000",
                date: new Date().toISOString(),
                status: "new"
            };

            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Heartbeat)
            playAlert();

            await sendData(newOrder);

            // 6. ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø·ÙˆØ±
            let p = capPhone.replace(/\D/g, '');
            if (!p.startsWith('962')) p = '962' + p.replace(/^0+/, '');
            
            const msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - ${currentUser.name}* ğŸ“¦%0a%0ağŸ‘¤ *Ø§Ù„ÙƒØ§Ø¨ØªÙ†:* ${capName}%0ağŸ“ *Ø§Ù„Ù…ÙˆÙ‚Ø¹:* ${mapLink}%0ağŸ’° *Ø§Ù„ØªØ­ØµÙŠÙ„:* ${val} Ø¯.Ø£%0ağŸ›µ *Ø£Ø¬Ø±Ø© Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨:* ${fee} Ø¯.Ø£%0a%0aâš ï¸ *Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨ØªØ¹Ø§Ù„ÙŠÙ… Ø§Ù„Ø´Ø±ÙƒØ© ÙˆØªÙˆØµÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø£Ù…Ø§Ù†.*`;
            
            window.open(`https://wa.me/${p}?text=${msg}`, '_blank');
            
            alert("ØªÙ… Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");
            refreshData();
        }

        // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        function updateFinanceDisplay() {
            const list = document.getElementById('finance-list');
            let html = '';
            for (let [cap, amount] of Object.entries(captainsDues)) {
                html += `
                    <div class="finance-item">
                        <span>${cap}</span>
                        <span style="font-weight:bold; color:#d4af37;">${amount.toFixed(2)} Ø¯.Ø£</span>
                    </div>
                `;
            }
            if(html === '') html = '<div style="text-align:center; color:#777;">Ø³Ø¬Ù„ Ù†Ø¸ÙŠÙ</div>';
            list.innerHTML = html;
        }

        function saveSettings() {
            const p = document.getElementById('company_percentage').value;
            localStorage.setItem('nOne_percent', p);
        }

        function resetFinanceWeek() {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©ØŸ")) return;
            captainsDues = {};
            localStorage.removeItem('nOne_dues');
            updateFinanceDisplay();
            alert("ØªÙ… Ø¨Ø¯Ø¡ Ø¯ÙˆØ±Ø© Ù…Ø§Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© ğŸ”„");
        }

        function playAlert() {
            // Ù…Ø­Ø§ÙƒØ§Ø© ØµÙˆØª Ù†Ø¨Ø¶Ø© (ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù…Ù„Ù ØµÙˆØªÙŠ Ø­Ù‚ÙŠÙ‚ÙŠ)
            const audio = document.getElementById('alert-sound');
            if(audio) audio.play().catch(e => console.log("Audio requires interaction"));
        }

        // Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯)
        async function sendData(dataObj) {
            await fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'add', data: dataObj })
            });
            await new Promise(r => setTimeout(r, 1000));
        }

        async function checkMyStatus() {
            try {
                const res = await fetch(API_URL + "?action=read");
                const all = await res.json();
                const me = all.find(u => u.user === currentUser.user);
                if (!me || me.status !== 'active') { alert("Ù…ÙˆÙ‚ÙˆÙ"); logout(); }
            } catch(e) {}
        }

        function logout() {
            localStorage.removeItem('currentUser');
            sessionStorage.clear();
            window.location.replace('index.html');
        }
        
        // Ø¯ÙˆØ§Ù„ ÙˆÙ‡Ù…ÙŠØ© Ù„Ù„ØªÙˆØ§ÙÙ‚
        function getMyGPS() {}
        function fillCaptainData() {}
    </script>
</body>
</html>
