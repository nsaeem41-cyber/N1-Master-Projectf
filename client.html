<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ø±Ø§Ù‚ÙŠØ©</title>
    <style>
        /* ================= ØªØµÙ…ÙŠÙ… N One Merchant Portal ================= */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8; margin: 0; padding: 0;
            user-select: none; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
        }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠ */
        .achievement-bar {
            width: 100%; background: #1a237e; color: white;
            padding: 10px 20px; display: flex; justify-content: space-between;
            align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            position: sticky; top: 0; z-index: 1000; box-sizing: border-box;
        }
        .gold-text { color: #d4af37; font-weight: bold; }

        /* Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª */
        .container {
            width: 90%; max-width: 500px; background: white;
            padding: 30px; border-radius: 20px; margin-top: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px;
        }

        h2 { color: #1a237e; text-align: center; margin-bottom: 25px; border-bottom: 2px solid #d4af37; padding-bottom: 10px; }
        
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 13px; font-weight: bold; color: #555; margin-bottom: 5px; }
        input, select {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px;
            font-size: 14px; background: #fafafa; outline: none; box-sizing: border-box;
            transition: 0.3s;
        }
        input:focus { border-color: #1a237e; background: white; box-shadow: 0 0 5px rgba(26,35,126,0.2); }

        .btn-action {
            width: 100%; padding: 15px; background: #1a237e; color: white;
            border: none; border-radius: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; transition: 0.3s; margin-top: 10px;
        }
        .btn-action:hover { background: #0d155a; transform: translateY(-2px); }

        .btn-emergency {
            background: #c62828; margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-emergency:disabled { background: #ccc; cursor: not-allowed; transform: none; }

        /* Ù‚Ø³Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
        .feedback-box {
            margin-top: 20px; padding: 15px; background: #e8f5e9;
            border-radius: 12px; border: 1px solid #c8e6c9; text-align: center;
        }

        /* Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .hidden { display: none; }

        .quota-info { font-size: 11px; color: #888; text-align: center; margin-top: 5px; }
        
        #history-list { font-size: 12px; color: #1a237e; cursor: pointer; text-decoration: underline; margin-top: 5px; display: block; }
    </style>
</head>
<body>

    <div id="top-nav" class="achievement-bar hidden">
        <div>N <span class="gold-text">One</span> | <span id="display-merchant-name">...</span></div>
        <div>ğŸ† Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„ÙŠÙˆÙ…: <span id="daily-count" class="gold-text">0</span> Ø·Ù„Ø¨Ø§Øª</div>
        <button onclick="logout()" style="background:none; border:none; color:white; cursor:pointer; font-size: 12px;">ğŸ”’ Ø®Ø±ÙˆØ¬</button>
    </div>

    <div id="register-page" class="container">
        <h2>ØªØ£Ø³ÙŠØ³ Ø­Ø³Ø§Ø¨ Ù…Ù†Ø´Ø£Ø© Ø¬Ø¯ÙŠØ¯</h2>
        <div class="input-group">
            <label>ğŸ“ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
            <input type="text" id="reg-region" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¬Ø¨ÙŠÙ‡Ø©">
        </div>
        <div class="input-group">
            <label>ğŸ›£ï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ / Ø§Ù„Ø´Ø§Ø±Ø¹ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
            <input type="text" id="reg-street" placeholder="Ù…Ø«Ø§Ù„: Ø´Ø§Ø±Ø¹ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©">
        </div>
        <div class="input-group">
            <label>ğŸ  Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
            <input type="text" id="reg-shop-name" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø·Ø¹Ù… ÙˆØ±Ø¯">
        </div>
        <div class="input-group">
            <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" id="reg-user" placeholder="Ø§Ù„ÙŠÙˆØ²Ø± Ù†ÙŠÙ… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ">
        </div>
        <div class="input-group">
            <label>ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
            <input type="password" id="reg-pass" placeholder="********">
        </div>
        <button class="btn-action" onclick="registerMerchant()">ØªØ£Ø³ÙŠØ³ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ø¨Ø¯Ø¡ ğŸš€</button>
        <p style="text-align:center; font-size:12px; color:#666; margin-top:15px; cursor:pointer;" onclick="togglePages()">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</p>
    </div>

    <div id="login-page" class="container hidden">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©</h2>
        <div class="input-group">
            <label>ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
            <input type="text" id="login-user">
        </div>
        <div class="input-group">
            <label>ğŸ”‘ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</label>
            <input type="password" id="login-pass">
        </div>
        <button class="btn-action" onclick="loginMerchant()">Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ğŸ”“</button>
        <p style="text-align:center; font-size:12px; color:#666; margin-top:15px; cursor:pointer;" onclick="togglePages()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</p>
    </div>

    <div id="main-dashboard" class="container hidden">
        <h2>Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±ÙƒØ²</h2>
        <div class="input-group">
            <label>ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø± / Ø§Ù„Ø·Ù„Ø¨ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
            <input type="number" id="order-value" placeholder="0.00">
        </div>
        <div class="input-group">
            <label>ğŸš© ÙˆØ¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨ / Ø§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
            <input type="text" id="order-dest" placeholder="Ù„ÙˆÙŠÙ† Ø±Ø§ÙŠØ­ Ø§Ù„Ø·Ù„Ø¨ØŸ" list="history-dest">
            <datalist id="history-dest"></datalist>
            <span id="history-list" onclick="useLastHistory()">Ø¥Ø¯Ø±Ø§Ø¬ Ø¢Ø®Ø± ÙˆØ¬Ù‡Ø© Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡Ø§ âš¡</span>
        </div>
        
        <button class="btn-action" onclick="sendMerchantOrder(false)">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±ÙƒØ² ğŸš€</button>
        
        <button id="emergency-btn" class="btn-action btn-emergency" onclick="sendMerchantOrder(true)">
            ğŸš¨ Ø·Ù„Ø¨ Ø·ÙˆØ§Ø±Ø¦ (Ù…Ø³ØªØ¹Ø¬Ù„ Ø¬Ø¯Ø§Ù‹)
        </button>
        <div id="quota-text" class="quota-info">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† ÙƒÙˆØªØ§ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦: 0/0</div>

        <div class="feedback-box">
            <p style="font-size:12px; margin-bottom:5px;">â­ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ø¢Ø®Ø± Ø¹Ù…Ù„ÙŠØ© ØªÙˆØµÙŠÙ„</p>
            <button onclick="submitFeedback('Ù…Ù…ØªØ§Ø²')" style="border:none; background:none; font-size:20px; cursor:pointer;">ğŸ˜Š</button>
            <button onclick="submitFeedback('Ø¬ÙŠØ¯')" style="border:none; background:none; font-size:20px; cursor:pointer;">ğŸ˜</button>
            <button onclick="submitFeedback('Ø³ÙŠØ¡')" style="border:none; background:none; font-size:20px; cursor:pointer;">â˜¹ï¸</button>
        </div>
    </div>

    <audio id="heartbeat" src="https://www.soundjay.com/human/heartbeat-01.mp3"></audio>

    <script>
        // API Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ù…Ù†ØµØ©
        const API_URL = "https://script.google.com/macros/s/AKfycby8Lvhri3wDGXFwXY2EPKy_sf6vrIEAyPVGreob8gDe_mx9EbpqWsqqR511LXdqjjU1/exec";
        
        let merchantData = JSON.parse(localStorage.getItem('nOne_merchant')) || null;
        let lastDestinations = JSON.parse(localStorage.getItem('nOne_history')) || [];
        let dailyOrders = parseInt(localStorage.getItem('nOne_daily_count')) || 0;
        let emergencyUsed = parseInt(localStorage.getItem('nOne_emergency_used')) || 0;

        window.onload = function() {
            if(merchantData) {
                showDashboard();
            }
            updateUI();
        };

        function togglePages() {
            document.getElementById('register-page').classList.toggle('hidden');
            document.getElementById('login-page').classList.toggle('hidden');
        }

        function registerMerchant() {
            const region = document.getElementById('reg-region').value;
            const street = document.getElementById('reg-street').value;
            const shop = document.getElementById('reg-shop-name').value;
            const user = document.getElementById('reg-user').value;
            const pass = document.getElementById('reg-pass').value;

            if(!region || !street || !shop || !user || !pass) return alert("ÙŠØ§ Ø­Ø¨Ø© Ø§Ù„Ø³ÙƒØ± Ø¹Ø¨ÙŠ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø´Ø§Ù† Ù†Ø£Ø³Ø³ Ø§Ù„Ø­Ø³Ø§Ø¨ ØµØ­ ğŸ˜Š");

            merchantData = { user, pass, shop, region, street };
            localStorage.setItem('nOne_merchant', JSON.stringify(merchantData));
            alert("ØªÙ… ØªØ£Ø³ÙŠØ³ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø¹Ø§Ø¦Ù„Ø© N One ğŸ˜Š");
            showDashboard();
        }

        function loginMerchant() {
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const saved = JSON.parse(localStorage.getItem('nOne_merchant'));

            if(saved && saved.user === user && saved.pass === pass) {
                merchantData = saved;
                showDashboard();
            } else {
                alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© ÙŠØ§ ØºØ§Ù„ÙŠ ğŸ˜Š");
            }
        }

        function showDashboard() {
            document.getElementById('register-page').classList.add('hidden');
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-dashboard').classList.remove('hidden');
            document.getElementById('top-nav').classList.remove('hidden');
            document.getElementById('display-merchant-name').innerText = merchantData.shop;
            updateUI();
        }

        function updateUI() {
            document.getElementById('daily-count').innerText = dailyOrders;
            
            // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ÙƒÙˆØªØ§ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦: 5 Ù„ÙƒÙ„ 25 Ø·Ù„Ø¨
            let allowedEmergency = Math.max(5, Math.floor(dailyOrders / 25) * 5);
            let remaining = allowedEmergency - emergencyUsed;
            document.getElementById('quota-text').innerText = `Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† ÙƒÙˆØªØ§ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦: ${remaining} Ù…Ù† ${allowedEmergency}`;
            document.getElementById('emergency-btn').disabled = (remaining <= 0);

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ¬Ù‡Ø§Øª Ø§Ù„Ù…ØªÙƒØ±Ø±Ø©
            const datalist = document.getElementById('history-dest');
            datalist.innerHTML = lastDestinations.map(d => `<option value="${d}">`).join('');
        }

        async function sendMerchantOrder(isEmergency) {
            const val = document.getElementById('order-value').value;
            const dest = document.getElementById('order-dest').value;

            if(!val || !dest) return alert("Ù„Ø§Ø²Ù… ØªØ­Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙˆØ§Ù„ÙˆØ¬Ù‡Ø© Ø¹Ø´Ø§Ù† Ù†Ø¨Ø¹Ø« Ø§Ù„Ø·Ù„Ø¨ ÙŠØ§ Ø¨Ø·Ù„ ğŸ˜Š");

            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ù†Ø¨Ø¶Ø© Ø§Ù„Ù‚Ù„Ø¨
            document.getElementById('heartbeat').play().catch(() => {});

            // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ Ø³Ø­Ø¨ Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒÙŠØ§Ù‹ (Ø§Ù„Ù…ÙŠØ«Ø§Ù‚)
            const orderObj = {
                id: "MERC_" + Date.now(),
                type: "order",
                client_user: merchantData.user, // ÙŠØ±Ø¨Ø· Ø¨Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±ÙƒØ©
                cl_name: merchantData.shop,
                pickup: `${merchantData.shop} - ${merchantData.region} (${merchantData.street})`,
                val: val,
                fee: 0, // ÙŠØ­Ø¯Ø¯Ù‡ Ø§Ù„Ù…ÙˆØ¸Ù Ù„Ø§Ø­Ù‚Ø§Ù‹
                dest: dest,
                status: isEmergency ? "EMERGENCY" : "new",
                date: new Date().toISOString()
            };

            // ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹
            await fetch(API_URL, {
                method: 'POST', mode: 'no-cors',
                body: JSON.stringify({ action: 'add', data: orderObj })
            });

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
            dailyOrders++;
            if(isEmergency) emergencyUsed++;
            
            // Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ù‡Ø© ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®
            if(!lastDestinations.includes(dest)) {
                lastDestinations.unshift(dest);
                if(lastDestinations.length > 5) lastDestinations.pop();
            }

            localStorage.setItem('nOne_daily_count', dailyOrders);
            localStorage.setItem('nOne_emergency_used', emergencyUsed);
            localStorage.setItem('nOne_history', JSON.stringify(lastDestinations));

            alert(isEmergency ? "ğŸš¨ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø·ÙˆØ§Ø±Ø¦ Ù…Ø³ØªØ¹Ø¬Ù„ Ù„Ù„Ù…Ø±ÙƒØ²" : "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø±ÙƒØ² Ø¨Ù†Ø¬Ø§Ø­");
            
            document.getElementById('order-value').value = "";
            document.getElementById('order-dest').value = "";
            updateUI();
        }

        function useLastHistory() {
            if(lastDestinations.length > 0) {
                document.getElementById('order-dest').value = lastDestinations[0];
            }
        }

        function submitFeedback(status) {
            alert(`Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø§Ù„Ø±Ø§Ù‚ÙŠ ğŸ˜Š ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ù† Ø§Ù„ØªØ¬Ø±Ø¨Ø© ÙƒØ§Ù†Øª ${status}`);
        }

        function logout() {
            // ØªØ¯Ù…ÙŠØ± Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø¹ÙˆØ¯Ø© (Ø§Ù„Ù…ÙŠØ«Ø§Ù‚)
            localStorage.removeItem('nOne_merchant');
            sessionStorage.clear();
            location.reload();
            history.pushState(null, null, location.href);
            window.onpopstate = function() { history.go(1); };
        }
    </script>
</body>
</html>
