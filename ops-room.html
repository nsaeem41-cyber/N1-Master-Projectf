<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© (Live Ops)</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Ops Room Ultimate (Dark/Light Hybrid) ================= */
        :root {
            --primary: #00695c; --gold: #d4af37; --bg: #e0f2f1; --text: #333;
            --dark-panel: #263238; --light-panel: #ffffff;
            --success: #2e7d32; --danger: #c62828; --money: #1b5e20;
            --urgent: #ff5252; /* Ù„ÙˆÙ† Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); user-select: none; overflow-x: hidden; }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ù…Ø¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­ÙŠØ© */
        .navbar { background: var(--dark-panel); height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; border-bottom: 3px solid var(--gold); }
        .brand { font-size: 20px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .live-stats-bar { display: flex; gap: 15px; }
        .stat-box { background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 8px; color: white; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
        .stat-val { font-weight: bold; font-size: 14px; color: var(--gold); }
        .stat-lbl { font-size: 10px; color: #ccc; }

        /* ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ù†Ù‚Ø³Ù…Ø© */
        .ops-container { display: grid; grid-template-columns: 68% 32%; height: calc(100vh - 70px); }
        .live-section { padding: 15px; overflow-y: auto; border-left: 2px solid #b0bec5; background: #eceff1; }
        .manual-section { background: white; padding: 15px; overflow-y: auto; box-shadow: -5px 0 15px rgba(0,0,0,0.05); }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card { background: white; padding: 0; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; border-top: 4px solid var(--primary); }
        .card-header { padding: 15px; font-weight: bold; color: var(--primary); display: flex; justify-content: space-between; align-items: center; background: #fff; border-bottom: 1px solid #eee; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead { background: #546e7a; color: white; position: sticky; top: 0; }
        th, td { padding: 12px; text-align: right; border-bottom: 1px solid #eee; }
        tr { transition: 0.3s; background: white; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„ÙˆÙ…ÙŠØ¶ (Glowing Effect) */
        @keyframes glowing {
            0% { background-color: #e3f2fd; box-shadow: 0 0 5px #2196f3; }
            50% { background-color: #bbdefb; box-shadow: 0 0 20px #2196f3; }
            100% { background-color: #e3f2fd; box-shadow: 0 0 5px #2196f3; }
        }
        .new-order-glow { animation: glowing 1.5s infinite; border-left: 5px solid #2196f3; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ (ØªØ£Ø®ÙŠØ± Ø£ÙƒØ«Ø± Ù…Ù† Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†) */
        @keyframes urgent-glow {
            0% { background-color: #ffebee; } 50% { background-color: #ffcdd2; } 100% { background-color: #ffebee; }
        }
        .urgent-order { animation: urgent-glow 1s infinite; border-left: 5px solid var(--urgent); }

        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .bg-money { background: #e8f5e9; color: var(--money); font-family: 'Courier New', monospace; font-weight: bold; }
        .bg-time { background: #263238; color: var(--gold); font-family: monospace; }
        
        /* Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ (ØµØ­) */
        .btn-ack { background: var(--success); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transition: 0.2s; }
        .btn-ack:hover { transform: scale(1.1); background: #1b5e20; }

        /* Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ */
        .timer-badge { font-size: 10px; font-weight: bold; color: #555; display: inline-block; min-width: 40px; }

        /* ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ */
        .manual-form { display: flex; flex-direction: column; gap: 10px; padding: 15px; }
        input { padding: 10px; border: 1px solid #cfd8dc; border-radius: 6px; outline: none; background: #fafafa; width: 100%; box-sizing: border-box; }
        input:focus { border-color: var(--primary); background: white; }
        
        .btn-whatsapp { background: #25d366; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-whatsapp:hover { background: #128c7e; transform: translateY(-2px); }

        /* ØªÙ„Ù…ÙŠØ­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© */
        .memory-hint { font-size: 11px; color: var(--primary); background: #e0f2f1; padding: 5px; border-radius: 4px; display: none; margin-top: -5px; margin-bottom: 5px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµØºÙŠØ±Ø© ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ */
        .mini-btn { border: none; cursor: pointer; background: none; font-size: 14px; padding: 2px 5px; }
        
        @media (max-width: 900px) { .ops-container { grid-template-columns: 1fr; height: auto; } .live-section { border-left: none; } }
    </style>
</head>
<body onclick="enableSound()">

    <audio id="notif-sound" preload="auto" loop>
        <source src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" type="audio/mpeg">
    </audio>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Operations</div>
        
        <div class="live-stats-bar">
            <div class="stat-box">
                <div class="stat-val" id="stat-total">0</div>
                <div class="stat-lbl">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="stat-pending" style="color:#ff5252;">0</div>
                <div class="stat-lbl">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="stat-comm">0.00</div>
                <div class="stat-lbl">Ø¹Ù…ÙˆÙ„Ø§Øª (Ø¯.Ø£)</div>
            </div>
        </div>
    </nav>

    <div class="ops-container">
        
        <div class="live-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“¡ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Live Feed)</span>
                    <span style="font-size:12px; color:#777;">Ø§Ù„ØªØ­Ø¯ÙŠØ«: ØªÙ„Ù‚Ø§Ø¦ÙŠ âš¡</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ØªØ£ÙƒÙŠØ¯</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ù…Ù†Ø°</th>
                            <th>Ø§Ù„Ù…Ù†Ø´Ø£Ø©</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                            <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="live-table-body">
                        <tr><td colspan="6" style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="manual-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠ (Manual)</span>
                </div>
                
                <div class="manual-form">
                    <div>
                        <input type="tel" id="man_phone" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† (07xxxxxxxx)" oninput="checkCaptainMemory()">
                        <div id="mem_hint" class="memory-hint">âœ¨ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù: <span id="mem_name"></span></div>
                    </div>

                    <input type="text" id="man_cap_name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†">
                    <input type="text" id="man_rest_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø¹Ù… (Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ)">
                    
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="man_val" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ø¯Ø±">
                        <input type="number" id="man_fee" placeholder="Ø§Ù„ØªÙˆØµÙŠÙ„">
                    </div>

                    <div style="display:flex; gap:5px;">
                        <input type="number" id="man_ratio" placeholder="Ø§Ù„Ù†Ø³Ø¨Ø© %" style="border-color:var(--gold);">
                    </div>

                    <button class="btn-whatsapp" onclick="sendManualOrder()">
                        Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØªÙˆØ«ÙŠÙ‚ ğŸ“¤
                    </button>
                    
                    <input type="hidden" id="edit_mode_index" value="-1">
                    <button id="cancel_edit_btn" onclick="cancelEdit()" style="display:none; background:#90a4ae; border:none; padding:8px; border-radius:5px; color:white; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header" style="font-size:14px;">ğŸ—‚ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
                <div style="padding:10px;">
                    <table style="font-size:12px;">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th>
                                <th>Ø¹Ù…ÙˆÙ„Ø©</th>
                                <th>ØªØ­ÙƒÙ…</th>
                            </tr>
                        </thead>
                        <tbody id="archive-body">
                            <tr><td colspan="3" style="text-align:center;">ÙØ§Ø±Øº</td></tr>
                        </tbody>
                    </table>
                    <button onclick="clearDailyArchive()" style="width:100%; margin-top:10px; padding:5px; border:none; background:#eceff1; color:#555; cursor:pointer; border-radius:5px;">ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ ğŸ—‘ï¸</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ========================================================
        // ÙƒÙˆØ¯ ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª - Ultimate v7.2 (Ø§Ù„Ù…Ø­Ø±Ùƒ Ø§Ù„Ø®Ø§Ø±Ù‚)
        // ========================================================
        
        if (typeof N_ONE_CORE !== 'undefined') {
            N_ONE_CORE.API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        }

        let allData = [];
        let acknowledgedSet = new Set(); // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© Ù…Ø­Ù„ÙŠØ§Ù‹
        let soundEnabled = false;
        let isAlarmPlaying = false;
        
        let captainMemory = JSON.parse(localStorage.getItem('n1_captains') || '{}');
        let dailyArchive = JSON.parse(localStorage.getItem('n1_daily_archive') || '[]');

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
        window.onload = async function() {
            if (typeof N_ONE_CORE === 'undefined') { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†ÙˆØ§Ø©!"); return; }
            
            await fetchData();
            renderArchive();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
            setInterval(fetchDataSilent, 5000);
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø²Ù…Ù†ÙŠØ© ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
            setInterval(updateTimersAndColors, 1000);
        };

        function enableSound() {
            if (!soundEnabled) {
                const audio = document.getElementById('notif-sound');
                // ØªØ´ØºÙŠÙ„ ØµØ§Ù…Øª Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø°Ù†
                audio.play().then(() => { 
                    audio.pause(); 
                    audio.currentTime = 0; 
                    soundEnabled = true; 
                }).catch(() => {});
            }
        }

        function playAlarm() {
            const audio = document.getElementById('notif-sound');
            if (soundEnabled && !isAlarmPlaying) {
                audio.loop = true;
                audio.play().catch(()=>{});
                isAlarmPlaying = true;
            }
        }

        function stopAlarm() {
            const audio = document.getElementById('notif-sound');
            audio.pause();
            audio.currentTime = 0;
            isAlarmPlaying = false;
        }

        async function fetchData() {
            try { allData = await N_ONE_CORE.fetchData('read'); renderLiveTable(); } catch (e) {}
        }

        async function fetchDataSilent() {
            try {
                const newData = await N_ONE_CORE.fetchData('read');
                if (newData.length > 0) { allData = newData; renderLiveTable(); }
            } catch (e) {}
        }

        // ================= Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Live Feed) =================
        function renderLiveTable() {
            const tbody = document.getElementById('live-table-body');
            const orders = allData.filter(i => i.type === 'order').reverse();
            
            // 1. Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
            document.getElementById('stat-total').innerText = orders.length;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¤ÙƒØ¯Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
            const pendingCount = orders.filter(o => !acknowledgedSet.has(o.id)).length;
            document.getElementById('stat-pending').innerText = pendingCount;
            
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¬Ø±Ø³ Ø§Ù„Ù…Ø³ØªÙ…Ø± (Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ØºÙŠØ± Ù…Ø¤ÙƒØ¯)
            if (pendingCount > 0) playAlarm();
            else stopAlarm();

            if (orders.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ğŸ˜´</td></tr>'; return; }
            
            tbody.innerHTML = '';
            
            orders.forEach(ord => {
                const isAck = acknowledgedSet.has(ord.id);
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„Ø§Ø³ (ÙˆÙ…ÙŠØ¶ØŒ Ø£Ø­Ù…Ø±ØŒ Ø£Ùˆ Ø¹Ø§Ø¯ÙŠ)
                let rowClass = '';
                const orderTime = new Date(ord.date).getTime();
                const now = Date.now();
                const diffSec = Math.floor((now - orderTime) / 1000);
                
                if (!isAck) {
                    if (diffSec > 120) rowClass = 'urgent-order'; // Ø£Ø­Ù…Ø± Ø¨Ø¹Ø¯ Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ†
                    else rowClass = 'new-order-glow'; // ÙˆÙ…ÙŠØ¶ Ø£Ø²Ø±Ù‚
                }

                // Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯
                const ackBtn = isAck 
                    ? `<span style="color:var(--success); font-size:18px;">âœ…</span>` 
                    : `<button class="btn-ack" onclick="acknowledgeOrder('${ord.id}')">âœ“</button>`;

                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©
                const shopData = allData.find(u => String(u.user) === String(ord.client_user) && u.type === 'shop');
                let shopLocLink = shopData ? (shopData.pickup || '#') : '#';
                if (ord.pickup && ord.pickup.includes('http')) shopLocLink = ord.pickup;

                // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¯Ù‚ÙŠÙ‚
                const timeObj = new Date(ord.date);
                const exactTime = timeObj.toLocaleTimeString('en-US', {hour12:false}); // HH:MM:SS

                tbody.innerHTML += `
                    <tr class="${rowClass}" id="row-${ord.id}" data-time="${orderTime}" data-ack="${isAck}">
                        <td>${ackBtn}</td>
                        <td><span class="badge bg-time">${exactTime}</span></td>
                        <td><span class="timer-badge" id="timer-${ord.id}">0s</span></td>
                        <td><b>${ord.cl_name || 'Ù…Ø·Ø¹Ù…'}</b></td>
                        <td><a href="${shopLocLink}" target="_blank" class="badge" style="background:#e3f2fd; color:#1565c0; text-decoration:none;">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a></td>
                        <td><span class="badge bg-money">${ord.val}</span></td>
                    </tr>
                `;
            });
            updateTimersAndColors(); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ù„ÙˆØ§Ù†
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ø±Ø³ ÙˆØ§Ù„Ø¶ÙˆØ¡)
        function acknowledgeOrder(id) {
            acknowledgedSet.add(id);
            renderLiveTable(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù… Ù„Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙˆÙ…ÙŠØ¶
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† ÙƒÙ„ Ø«Ø§Ù†ÙŠØ©
        function updateTimersAndColors() {
            const rows = document.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const time = row.getAttribute('data-time');
                const isAck = row.getAttribute('data-ack') === 'true';
                const id = row.id.replace('row-', '');
                
                if (time) {
                    const diff = Math.floor((Date.now() - parseInt(time)) / 1000);
                    
                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
                    const timerEl = document.getElementById(`timer-${id}`);
                    if (timerEl) {
                        timerEl.innerText = diff + "s";
                        if (diff > 120 && !isAck) timerEl.style.color = "red";
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ù„Ù„Ø£ÙˆÙ„ÙˆÙŠØ§Øª (Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø¤ÙƒØ¯Ø§Ù‹)
                    if (!isAck && diff > 120 && !row.classList.contains('urgent-order')) {
                        row.classList.remove('new-order-glow');
                        row.classList.add('urgent-order');
                    }
                }
            });
        }

        // ================= Ø§Ù„Ù…Ø±Ø³Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (WhatsApp) =================
        
        function checkCaptainMemory() {
            const phone = document.getElementById('man_phone').value;
            const hint = document.getElementById('mem_hint');
            if (captainMemory[phone]) {
                hint.style.display = 'block';
                document.getElementById('mem_name').innerText = captainMemory[phone];
                document.getElementById('man_cap_name').value = captainMemory[phone];
            } else hint.style.display = 'none';
        }

        function sendManualOrder() {
            const phone = document.getElementById('man_phone').value;
            const capName = document.getElementById('man_cap_name').value;
            const restName = document.getElementById('man_rest_name').value;
            const val = document.getElementById('man_val').value;
            const fee = document.getElementById('man_fee').value;
            const ratio = document.getElementById('man_ratio').value || 0;
            const editIndex = document.getElementById('edit_mode_index').value;

            if (!phone || !restName) { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© â˜ºï¸"); return; }

            // Ø­ÙØ¸ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
            if (capName) {
                captainMemory[phone] = capName;
                localStorage.setItem('n1_captains', JSON.stringify(captainMemory));
            }

            // === 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ù„Ù„ÙƒØ§Ø¨ØªÙ† ===
            // Ù†Ø­Ø³Ø¨ Ù…Ù† Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù…Ø­Ù„ÙŠ ÙƒÙ… Ø·Ù„Ø¨ Ø¹Ù…Ù„ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„ÙŠÙˆÙ…
            const capOrders = dailyArchive.filter(o => o.cap === capName);
            const todayCount = capOrders.length + 1; // Ù†Ø¶ÙŠÙ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
            // Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø±Ø³ÙˆÙ… Ø§Ù„ØªÙˆØµÙŠÙ„)
            let todayEarnings = capOrders.reduce((sum, o) => sum + parseFloat(o.fee || 0), 0);
            todayEarnings += parseFloat(fee || 0);

            // === 2. Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø°ÙƒÙŠ (Ø­Ù„ Ù„ØºØ² Ø§Ù„Ø®Ø±Ø§Ø¦Ø·) ===
            const mapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(restName)}`;

            // === 3. ØµÙŠØºØ© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ù„ÙƒÙŠØ© ===
            let finalPhone = phone.startsWith('0') ? '962' + phone.substring(1) : phone;
            if (!finalPhone.startsWith('962')) finalPhone = '962' + phone;

            const msg = `ÙŠØ§ Ù‡Ù„Ø§ Ø¨Ù€ *${capName}* ğŸ‘‹%0a` +
                        `ÙŠØ³Ø¹Ø¯Ù†Ø§ Ù†Ø¨Ù„ØºÙƒ Ø¥Ù†Ù‡ ÙˆØµÙ„Ùƒ Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ ğŸš€%0a` +
                        `-----------------------------%0a` +
                        `ğŸª Ø§Ù„Ù…Ù†Ø´Ø£Ø©: *${restName}*%0a` +
                        `ğŸ“ Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù† Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ${mapLink}%0a` +
                        `ğŸ›µ ØªÙˆØµÙŠÙ„Ùƒ: *${fee} Ø¯.Ø£*%0a` +
                        `ğŸ’° Ø³Ø¹Ø± Ø§Ù„Ø£ÙˆØ±Ø¯Ø±: *${val} Ø¯.Ø£*%0a` +
                        `-----------------------------%0a` +
                        `ğŸ“Š Ø£ØªÙ…Ù…Øª Ø§Ù„ÙŠÙˆÙ…: *${todayCount}* Ø£ÙˆØ±Ø¯Ø±Ø§Øª%0a` +
                        `ğŸ’µ Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø±Ø¨Ø§Ø­Ùƒ: *${todayEarnings.toFixed(2)} Ø¯.Ø£*%0a` +
                        `ğŸ”— Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„ØªÙˆØ¬Ù‡ Ù„Ù„Ù…ÙˆÙ‚Ø¹`;

            // ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… Ù†ÙƒÙ† ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø£Ùˆ Ø¥Ø°Ø§ Ø±ØºØ¨Ù†Ø§ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„)
            if (confirm("Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¢Ù†ØŸ")) {
                window.open(`https://wa.me/${finalPhone}?text=${msg}`, '_blank');
            }

            // === 4. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ ===
            const commission = (parseFloat(fee || 0) * (parseFloat(ratio) / 100)).toFixed(2);
            const entry = {
                cap: capName, phone: phone, rest: restName, val: val, fee: fee, ratio: ratio, comm: commission
            };

            if (editIndex > -1) {
                // ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„ Ù…ÙˆØ¬ÙˆØ¯
                dailyArchive[editIndex] = entry;
                cancelEdit(); // Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            } else {
                // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯
                dailyArchive.unshift(entry);
                // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
                document.getElementById('man_rest_name').value = '';
                document.getElementById('man_val').value = '';
                document.getElementById('man_fee').value = '';
            }
            
            localStorage.setItem('n1_daily_archive', JSON.stringify(dailyArchive));
            renderArchive();
        }

        // ================= Ø§Ù„Ø£Ø±Ø´ÙŠÙ (ØªØ¹Ø¯ÙŠÙ„ + Ø­Ø°Ù) =================
        function renderArchive() {
            const tbody = document.getElementById('archive-body');
            let totalComm = 0;
            
            if (dailyArchive.length === 0) { tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">ÙØ§Ø±Øº</td></tr>'; } 
            else {
                tbody.innerHTML = '';
                dailyArchive.forEach((item, index) => {
                    totalComm += parseFloat(item.comm);
                    tbody.innerHTML += `
                        <tr>
                            <td>${item.cap}</td>
                            <td style="color:var(--money); font-weight:bold;">${item.comm}</td>
                            <td>
                                <button class="mini-btn" onclick="editItem(${index})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
                                <button class="mini-btn" onclick="deleteItem(${index})" title="Ø­Ø°Ù">âŒ</button>
                            </td>
                        </tr>
                    `;
                });
            }
            document.getElementById('stat-comm').innerText = totalComm.toFixed(2);
        }

        function deleteItem(index) {
            if(!confirm("Ø­Ø°ÙØŸ")) return;
            dailyArchive.splice(index, 1);
            saveAndRender();
        }

        function editItem(index) {
            const item = dailyArchive[index];
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙˆØ±Ù…
            document.getElementById('man_phone').value = item.phone;
            document.getElementById('man_cap_name').value = item.cap;
            document.getElementById('man_rest_name').value = item.rest;
            document.getElementById('man_val').value = item.val;
            document.getElementById('man_fee').value = item.fee;
            document.getElementById('man_ratio').value = item.ratio;
            
            // ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
            document.getElementById('edit_mode_index').value = index;
            document.getElementById('cancel_edit_btn').style.display = 'block';
            document.querySelector('.btn-whatsapp').innerText = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ğŸ’¾";
            document.querySelector('.btn-whatsapp').style.background = "#f57f17"; // Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡
        }

        function cancelEdit() {
            document.getElementById('edit_mode_index').value = "-1";
            document.getElementById('cancel_edit_btn').style.display = 'none';
            document.querySelector('.btn-whatsapp').innerText = "Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØªÙˆØ«ÙŠÙ‚ ğŸ“¤";
            document.querySelector('.btn-whatsapp').style.background = "#25d366";
            
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('man_rest_name').value = '';
            document.getElementById('man_val').value = '';
            document.getElementById('man_fee').value = '';
        }

        function clearDailyArchive() {
            if(!confirm("ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠØŸ")) return;
            dailyArchive = [];
            saveAndRender();
        }

        function saveAndRender() {
            localStorage.setItem('n1_daily_archive', JSON.stringify(dailyArchive));
            renderArchive();
        }
    </script>
</body>
</html>
