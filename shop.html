<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N One | Business & Charging Point</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… N One Royal Light (Unified) ================= */
        :root {
            --primary: #0f172a;      /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ Ø¹Ù…ÙŠÙ‚ */
            --gold: #d4af37;         /* Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ */
            --bg: #f8fafc;           /* Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© Ø«Ù„Ø¬ÙŠØ© */
            --card-bg: #ffffff;      /* Ø£Ø¨ÙŠØ¶ Ù†Ø§ØµØ¹ */
            --text: #334155;         /* Ù†Øµ Ø±Ù…Ø§Ø¯ÙŠ */
            --success: #10b981;      /* Ø£Ø®Ø¶Ø± */
            --danger: #ef4444;       /* Ø£Ø­Ù…Ø± */
            --input-border: #e2e8f0; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text); user-select: none; padding-bottom: 80px;
        }

        /* 1. Ø§Ù„Ù‡ÙŠØ¯Ø± */
        .header {
            background: var(--primary);
            padding: 20px 25px;
            border-bottom-left-radius: 30px;
            border-bottom-right-radius: 30px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2);
            position: relative; z-index: 10; text-align: center;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .brand { font-size: 22px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        
        .btn-logout {
            background: rgba(239, 68, 68, 0.2); color: #fecaca; 
            border: 1px solid rgba(239, 68, 68, 0.5);
            padding: 6px 15px; border-radius: 12px; 
            font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }

        .shop-info { color: var(--gold); font-size: 14px; font-weight: bold; margin-bottom: 10px; }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© (Ø§Ù„Ø·Ù„Ø¨Ø§Øª vs Ø§Ù„Ø´Ø­Ù†) */
        .nav-tabs {
            display: flex; justify-content: center; gap: 10px; margin-top: 15px;
            background: rgba(255,255,255,0.1); padding: 5px; border-radius: 20px;
        }
        .nav-tab {
            flex: 1; padding: 10px; border: none; border-radius: 15px;
            font-weight: bold; font-size: 13px; cursor: pointer; transition: 0.3s;
            background: transparent; color: #94a3b8;
        }
        .nav-tab.active { background: var(--gold); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        /* 2. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .container { max-width: 500px; margin: 20px auto; padding: 0 20px; }

        /* Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
        .section { display: none; animation: fadeIn 0.3s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .card {
            background: var(--card-bg); padding: 25px; border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid var(--input-border);
            margin-bottom: 20px;
        }

        /* Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-size: 12px; font-weight: bold; color: #64748b; }
        input {
            width: 100%; padding: 14px; border: 2px solid var(--input-border); border-radius: 14px;
            font-size: 15px; background: #f8fafc; outline: none; transition: 0.3s;
            color: var(--primary); font-weight: 600;
        }
        input:focus { border-color: var(--primary); background: white; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn-main {
            width: 100%; padding: 16px; border: none; border-radius: 14px;
            font-size: 16px; font-weight: 800; cursor: pointer; color: white;
            transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .btn-send { background: var(--primary); }
        .btn-charge { background: var(--success); }

        /* Ø§Ù„Ø³Ø¬Ù„ */
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid #f1f5f9;
        }
        .history-item:last-child { border-bottom: none; }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: white; padding: 12px 25px; border-radius: 30px;
            font-size: 13px; font-weight: bold; display: none; z-index: 100;
        }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loader { 
            position: fixed; top: 0; left: 0; width: 0%; height: 4px; 
            background: var(--gold); z-index: 2000; transition: width 0.3s; 
        }
    </style>
</head>
<body>

    <div id="loader"></div>

    <header class="header">
        <div class="header-top">
            <div class="brand">N <span class="gold-text">One</span></div>
            <button class="btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div class="shop-info" id="shop-name-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('orders')">ğŸ“¦ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>
            <button class="nav-tab" onclick="switchTab('charging')">âš¡ Ø´Ø­Ù† ÙƒØ§Ø¨ØªÙ†</button>
        </div>
    </header>

    <div class="container">
        
        <div id="orders" class="section active">
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div style="background:white; padding:15px; border-radius:15px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.03);">
                    <div style="font-size:11px; color:#94a3b8;">Ø§Ù„ÙŠÙˆÙ… ğŸ“…</div>
                    <div style="font-size:20px; font-weight:900; color:var(--gold);" id="orders-today">0</div>
                </div>
                <div style="background:white; padding:15px; border-radius:15px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.03);">
                    <div style="font-size:11px; color:#94a3b8;">Ø§Ù„ÙƒÙ„ÙŠ ğŸš€</div>
                    <div style="font-size:20px; font-weight:900; color:var(--primary);" id="orders-total">0</div>
                </div>
            </div>

            <div class="card">
                <div class="input-group">
                    <label>ÙˆØ¬Ù‡Ø© Ø§Ù„Ø·Ù„Ø¨</label>
                    <input type="text" id="destination" list="areas-list" placeholder="Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..." onchange="calculateFee()">
                    <datalist id="areas-list"></datalist>
                </div>

                <div class="input-group">
                    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„</label>
                    <input type="number" id="order_val" placeholder="0.00 Ø¯.Ø£">
                </div>

                <div class="input-group">
                    <label>Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„</label>
                    <input type="text" id="delivery_fee" placeholder="ØªÙ„Ù‚Ø§Ø¦ÙŠ" readonly style="background:#f1f5f9;">
                </div>

                <button class="btn-main btn-send" id="btn-send" onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
            </div>

            <div class="card" style="padding:15px;">
                <div style="font-size:13px; font-weight:bold; color:#64748b; margin-bottom:10px;">Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
                <div id="history-list"></div>
            </div>
        </div>

        <div id="charging" class="section">
            <div class="card" style="border-top: 4px solid var(--success);">
                <div style="text-align:center; margin-bottom:20px;">
                    <h3 style="margin:0; color:var(--primary);">Ù†Ù‚Ø·Ø© Ø´Ø­Ù† Ù…Ø¹ØªÙ…Ø¯Ø© âœ…</h3>
                    <p style="font-size:12px; color:#64748b; margin:5px;">Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ ÙˆØ¢Ù…Ù† Ù„Ù„ÙƒØ¨Ø§ØªÙ†</p>
                </div>

                <div class="input-group">
                    <label>ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ)</label>
                    <input type="text" id="cap_id" placeholder="Ù…Ø«Ù„Ø§Ù‹: C-101">
                </div>

                <div class="input-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø±Ø§Ø¯ Ø´Ø­Ù†Ù‡</label>
                    <input type="number" id="charge_amount" placeholder="0.00 Ø¯.Ø£">
                </div>

                <button class="btn-main btn-charge" id="btn-charge" onclick="chargeCaptainSafe()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† âš¡</button>
            </div>

            <div style="background:#ecfdf5; padding:15px; border-radius:15px; border:1px solid #a7f3d0; text-align:center;">
                <span style="font-size:12px; color:#065f46;">Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù„Ø´Ø­Ù†:</span><br>
                <b style="font-size:24px; color:#059669;">Ù…ÙØªÙˆØ­</b> <small style="color:#059669;">Ø¯.Ø£</small>
                <div style="font-size:10px; color:#065f46; margin-top:5px;">(ÙŠØªÙ… ØªØ³ÙˆÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¯ÙˆØ±ÙŠØ§Ù‹)</div>
            </div>
        </div>

    </div>

    <div id="toast" class="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!</div>

    <script>
        // ========================================================
        // ÙƒÙˆØ¯ Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø´Ø§Ù…Ù„ ÙˆØ§Ù„Ø¢Ù…Ù† (Shop Safe v10.0)
        // ========================================================

        const API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        
        let shopData = JSON.parse(localStorage.getItem('nOne_shop_data_v10')) || { 
            ordersToday: 0, ordersTotal: 0, lastActiveDate: new Date().toDateString(), history: [] 
        };
        let pricingMatrix = {}; 
        let currentUser = null;

        if (typeof N_ONE_CORE !== 'undefined') {
            currentUser = N_ONE_CORE.checkSession('shop');
        } else {
            currentUser = JSON.parse(localStorage.getItem('currentUser'));
        }

        window.onload = function() {
            if (!currentUser) { window.location.href = 'index.html'; return; }
            document.getElementById('shop-name-display').innerText = currentUser.name;
            loadMatrix();
            checkDailyReset();
            updateUI();
        };

        // --- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ---
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        // --- Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ ---
        function checkDailyReset() {
            const todayStr = new Date().toDateString();
            if (shopData.lastActiveDate !== todayStr) {
                shopData.ordersToday = 0;
                shopData.lastActiveDate = todayStr;
                localStorage.setItem('nOne_shop_data_v10', JSON.stringify(shopData));
            }
        }

        function loadMatrix() {
            const rawData = localStorage.getItem('nOne_global_prices');
            if (rawData) {
                const allData = JSON.parse(rawData);
                const datalist = document.getElementById('areas-list');
                datalist.innerHTML = '';
                Object.keys(allData).forEach(source => {
                    allData[source].forEach(item => {
                        pricingMatrix[item.area] = parseFloat(item.price);
                        const opt = document.createElement('option');
                        opt.value = item.area;
                        datalist.appendChild(opt);
                    });
                });
            }
        }

        function calculateFee() {
            const dest = document.getElementById('destination').value;
            if (pricingMatrix[dest]) {
                let price = pricingMatrix[dest];
                // Ø¥Ø²Ø§Ù„Ø© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø¥Ø°Ø§ Ø£Ø±Ø¯ØªÙØŒ Ø£Ùˆ Ø¥Ø¨Ù‚Ø§Ø¦Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø·Ù„Ø¨. Ù‡Ù†Ø§ Ø£Ø¨Ù‚ÙŠÙ†Ø§Ù‡ Ø¨Ø³ÙŠØ·Ø§Ù‹
                const hour = new Date().getHours();
                if ((hour >= 23 || hour < 6) && localStorage.getItem('nOne_night_toggle') === 'true') price += 0.50;
                document.getElementById('delivery_fee').value = price.toFixed(2);
            }
        }

        // --- Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ---
        async function sendOrder() {
            checkDailyReset();
            const dest = document.getElementById('destination').value;
            const val = document.getElementById('order_val').value;
            const fee = document.getElementById('delivery_fee').value;

            if (!dest || !val || !fee) { showToast("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }
            
            setLoading('btn-send', true);

            const orderData = {
                id: "ORD_" + Date.now(),
                type: "order",
                client_user: currentUser.user,
                cl_name: currentUser.name,
                pickup: dest,
                val: val,
                fee: fee,
                date: new Date().toISOString(),
                is_emergency: false,
                status: "new"
            };

            try {
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ action: 'add', data: orderData })
                });

                shopData.ordersToday++;
                shopData.ordersTotal++;
                shopData.history.unshift({ dest: dest, val: val, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
                if (shopData.history.length > 5) shopData.history.pop();
                
                localStorage.setItem('nOne_shop_data_v10', JSON.stringify(shopData));
                updateUI();
                showToast("âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");
                
                document.getElementById('destination').value = '';
                document.getElementById('order_val').value = '';
                document.getElementById('delivery_fee').value = '';

            } catch (e) { showToast("âŒ Ø®Ø·Ø£ Ø¨Ø§Ù„Ø§ØªØµØ§Ù„"); }
            finally { setLoading('btn-send', false, "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸš€"); }
        }

        // --- Ø´Ø­Ù† Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø§Ù„Ø¢Ù…Ù† 100%) ---
        async function chargeCaptainSafe() {
            const capId = document.getElementById('cap_id').value;
            const amount = parseFloat(document.getElementById('charge_amount').value);

            if (!capId || !amount) { showToast("âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ù…Ø¨Ù„Øº"); return; }
            if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø´Ø­Ù† ${amount} Ø¯.Ø£ Ù„Ù„ÙƒØ§Ø¨ØªÙ† ${capId}ØŸ`)) return;

            setLoading('btn-charge', true);

            try {
                // 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ (Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ¹Ø¯Ù… ØªØµÙÙŠØ± Ø§Ù„Ø±ØµÙŠØ¯)
                const response = await fetch(API_URL + "?action=read");
                const data = await response.json();
                
                // 2. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒØ§Ø¨ØªÙ†
                const cap = data.find(c => c.user === capId || c.cap_phone === capId);
                
                if (!cap) {
                    showToast("âŒ Ø§Ù„ÙƒØ§Ø¨ØªÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
                    setLoading('btn-charge', false, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† âš¡");
                    return;
                }

                // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const oldBalance = parseFloat(cap.balance || 0);
                const newBalance = oldBalance + amount;

                // 4. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¢Ù…Ù†
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        action: 'update',
                        user: cap.user, // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù€ User ID Ø§Ù„ØµØ­ÙŠØ­ Ø§Ù„Ø°ÙŠ ÙˆØ¬Ø¯Ù†Ø§Ù‡
                        data: { balance: newBalance }
                    })
                });

                showToast(`âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†! Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newBalance} Ø¯.Ø£`);
                document.getElementById('cap_id').value = '';
                document.getElementById('charge_amount').value = '';

            } catch (e) { 
                console.error(e);
                showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); 
            }
            finally { setLoading('btn-charge', false, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† âš¡"); }
        }

        function updateUI() {
            document.getElementById('orders-today').innerText = shopData.ordersToday;
            document.getElementById('orders-total').innerText = shopData.ordersTotal;

            const list = document.getElementById('history-list');
            list.innerHTML = '';
            shopData.history.forEach(item => {
                list.innerHTML += `
                    <div class="history-item">
                        <div>
                            <div style="font-weight:bold; color:var(--primary); font-size:14px;">${item.dest}</div>
                            <div style="font-size:11px; color:#94a3b8;">${item.time}</div>
                        </div>
                        <div style="font-weight:bold; color:var(--gold);">${item.val} Ø¯.Ø£</div>
                    </div>
                `;
            });
        }

        function logout() {
            if(confirm("Ø®Ø±ÙˆØ¬ØŸ")) { localStorage.removeItem('currentUser'); window.location.href = 'index.html'; }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function setLoading(id, isLoading, text) {
            const btn = document.getElementById(id);
            const loader = document.getElementById('loader');
            if (isLoading) {
                btn.dataset.text = btn.innerText;
                btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...";
                btn.style.opacity = 0.7;
                btn.disabled = true;
                loader.style.width = "100%";
            } else {
                btn.innerText = text || btn.dataset.text;
                btn.style.opacity = 1;
                btn.disabled = false;
                loader.style.width = "0%";
            }
        }

    </script>
</body>
</html>
