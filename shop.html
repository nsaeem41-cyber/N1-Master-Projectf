<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N One | Business Portal</title>
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>
    <style>
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø£Ù†ÙŠÙ‚ */
        :root { --primary: #0f172a; --gold: #d4af37; --bg: #f8fafc; --card-bg: #ffffff; --text: #334155; --success: #10b981; --danger: #ef4444; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); padding-bottom: 80px; }
        
        .header { background: var(--primary); padding: 20px 25px; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; box-shadow: 0 10px 30px rgba(15, 23, 42, 0.2); text-align: center; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .brand { font-size: 22px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        .btn-logout { background: rgba(239, 68, 68, 0.2); color: #fecaca; border: 1px solid rgba(239, 68, 68, 0.5); padding: 6px 15px; border-radius: 12px; font-size: 12px; font-weight: bold; cursor: pointer; }
        
        .shop-info { color: var(--gold); font-size: 14px; font-weight: bold; margin-bottom: 10px; }
        
        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-top: 15px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 20px; }
        .nav-tab { flex: 1; padding: 10px; border: none; border-radius: 15px; font-weight: bold; font-size: 13px; cursor: pointer; background: transparent; color: #94a3b8; transition: 0.3s; }
        .nav-tab.active { background: var(--gold); color: var(--primary); }
        
        .container { max-width: 500px; margin: 20px auto; padding: 0 20px; }
        .section { display: none; animation: fadeIn 0.3s ease-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card { background: var(--card-bg); padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input { width: 100%; padding: 14px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 15px; background: #f8fafc; outline: none; margin-bottom: 15px; font-weight: 600; color: var(--primary); }
        input:focus { border-color: var(--primary); background: white; }
        
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 14px; font-size: 16px; font-weight: 800; cursor: pointer; color: white; transition: 0.2s; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-send { background: var(--primary); } .btn-charge { background: var(--success); }
        
        .history-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 12px 25px; border-radius: 30px; font-size: 13px; font-weight: bold; display: none; z-index: 100; }
        #loader { position: fixed; top: 0; left: 0; width: 0%; height: 4px; background: var(--gold); z-index: 2000; transition: width 0.3s; }
    </style>
</head>
<body>
    <div id="loader"></div>
    <header class="header">
        <div class="header-top"><div class="brand">N <span class="gold-text">One</span></div><button class="btn-logout" onclick="logout()">Ø®Ø±ÙˆØ¬</button></div>
        <div class="shop-info" id="shop-name-display">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('orders')">ğŸ“¦ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨</button>
            <button class="nav-tab" onclick="switchTab('charging')">âš¡ Ø´Ø­Ù† ÙƒØ§Ø¨ØªÙ†</button>
        </div>
    </header>
    <div class="container">
        <div id="orders" class="section active">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                <div style="background:white; padding:15px; border-radius:15px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.03);"><div style="font-size:11px; color:#94a3b8;">Ø§Ù„ÙŠÙˆÙ…</div><div style="font-size:20px; font-weight:900; color:var(--gold);" id="orders-today">0</div></div>
                <div style="background:white; padding:15px; border-radius:15px; text-align:center; box-shadow:0 5px 15px rgba(0,0,0,0.03);"><div style="font-size:11px; color:#94a3b8;">Ø§Ù„ÙƒÙ„ÙŠ</div><div style="font-size:20px; font-weight:900; color:var(--primary);" id="orders-total">0</div></div>
            </div>
            <div class="card">
                <input type="text" id="destination" list="areas-list" placeholder="Ø§Ù„ÙˆØ¬Ù‡Ø©..." onchange="calculateFee()">
                <datalist id="areas-list"></datalist>
                <input type="number" id="order_val" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ­ØµÙŠÙ„ (Ø¯.Ø£)">
                <input type="text" id="delivery_fee" placeholder="Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„" readonly style="background:#f1f5f9;">
                <button class="btn-main btn-send" id="btn-send" onclick="sendOrder()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸš€</button>
            </div>
            <div class="card" style="padding:15px;"><div style="font-size:13px; font-weight:bold; color:#64748b; margin-bottom:10px;">Ø¢Ø®Ø± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div><div id="history-list"></div></div>
        </div>
        <div id="charging" class="section">
            <div class="card" style="border-top: 4px solid var(--success);">
                <div style="text-align:center; margin-bottom:20px;">
                    <h3 style="margin:0; color:var(--primary);">Ø´Ø­Ù† ÙƒØ§Ø¨ØªÙ† âš¡</h3>
                    <p style="font-size:12px; color:#64748b;">Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b style="color:var(--success); font-size:16px;" id="my-shop-balance">...</b> Ø¯.Ø£</p>
                </div>
                <input type="text" id="cap_id" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† (C-xxx)">
                <input type="number" id="charge_amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)">
                <button class="btn-main btn-charge" id="btn-charge" onclick="chargeCaptainClosedLoop()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† âœ…</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­</div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        let shopData = JSON.parse(localStorage.getItem('nOne_shop_data_v12')) || { ordersToday: 0, ordersTotal: 0, lastActiveDate: new Date().toDateString(), history: [] };
        let pricingMatrix = {}, currentUser = null, myBalance = 0;

        if (typeof N_ONE_CORE !== 'undefined') currentUser = N_ONE_CORE.checkSession('shop');
        else currentUser = JSON.parse(localStorage.getItem('currentUser'));

        window.onload = async function() {
            if (!currentUser) { window.location.href = 'index.html'; return; }
            document.getElementById('shop-name-display').innerText = currentUser.name;
            loadMatrix(); checkDailyReset(); updateUI();
            await fetchMyBalance(); 
        };

        // --- Ø¬Ù„Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± ---
        async function fetchMyBalance() {
            try {
                const response = await fetch(API_URL + "?action=read");
                const data = await response.json();
                const me = data.find(u => u.user === currentUser.user);
                if (me) {
                    myBalance = parseFloat(me.balance || 0);
                    document.getElementById('my-shop-balance').innerText = myBalance.toFixed(2);
                }
            } catch (e) { console.error("Balance Error"); }
        }

        // --- Ø´Ø­Ù† Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…ØºÙ„Ù‚Ø©) ---
        async function chargeCaptainClosedLoop() {
            const capId = document.getElementById('cap_id').value.trim();
            const amount = parseFloat(document.getElementById('charge_amount').value);

            if (!capId || !amount) { showToast("âš ï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"); return; }
            if (amount <= 0) { showToast("âš ï¸ Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ­ÙŠØ­"); return; }
            
            // 1. ÙØ­Øµ Ù…Ø­Ù„ÙŠ
            if (myBalance < amount) { alert("â›” Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± ÙƒØ§ÙÙ!"); return; }

            if (!confirm(`Ø®ØµÙ… ${amount} Ø¯.Ø£ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ ÙˆØ´Ø­Ù†Ù‡Ø§ Ù„Ù„ÙƒØ§Ø¨ØªÙ† ${capId}ØŸ`)) return;
            setLoading('btn-charge', true);

            try {
                // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                const response = await fetch(API_URL + "?action=read");
                const data = await response.json();
                
                const cap = data.find(c => c.user === capId || c.cap_phone === capId);
                if (!cap) { alert("âŒ Ø§Ù„ÙƒØ§Ø¨ØªÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); setLoading('btn-charge', false); return; }

                const me = data.find(u => u.user === currentUser.user);
                const currentShopBal = parseFloat(me.balance || 0);
                
                if (currentShopBal < amount) { alert("â›” Ø±ØµÙŠØ¯Ùƒ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± ÙƒØ§ÙÙ!"); setLoading('btn-charge', false); return; }

                // 3. Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
                const newCapBal = parseFloat(cap.balance || 0) + amount;
                const newShopBal = currentShopBal - amount;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø¨ØªÙ† (+Amount)
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'update', user: cap.user, data: { balance: newCapBal } }) });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø´Ø£Ø© (-Amount)
                await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ action: 'update', user: currentUser.user, data: { balance: newShopBal } }) });

                myBalance = newShopBal;
                document.getElementById('my-shop-balance').innerText = myBalance.toFixed(2);
                document.getElementById('cap_id').value = '';
                document.getElementById('charge_amount').value = '';
                
                alert(`âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­!\n- Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø²Ø§Ø¯: +${amount}\n- Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${newShopBal}`);

            } catch (e) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"); }
            finally { setLoading('btn-charge', false, "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† âœ…"); }
        }

        // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ---
        function switchTab(id) { document.querySelectorAll('.section').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active'); event.target.classList.add('active'); }
        function checkDailyReset() { const t = new Date().toDateString(); if(shopData.lastActiveDate!==t){shopData.ordersToday=0;shopData.lastActiveDate=t;localStorage.setItem('nOne_shop_data_v12', JSON.stringify(shopData));} }
        function loadMatrix() { const d = localStorage.getItem('nOne_global_prices'); if(d){ const j=JSON.parse(d); const l=document.getElementById('areas-list'); l.innerHTML=''; Object.keys(j).forEach(k=>j[k].forEach(i=>{pricingMatrix[i.area]=parseFloat(i.price);const o=document.createElement('option');o.value=i.area;l.appendChild(o);})); } }
        function calculateFee() { const d=document.getElementById('destination').value; if(pricingMatrix[d]) document.getElementById('delivery_fee').value=pricingMatrix[d].toFixed(2); }
        async function sendOrder() {
            checkDailyReset(); const d=document.getElementById('destination').value, v=document.getElementById('order_val').value, f=document.getElementById('delivery_fee').value;
            if(!d||!v||!f){showToast("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");return;}
            setLoading('btn-send', true);
            const ord={id:"ORD_"+Date.now(), type:"order", client_user:currentUser.user, cl_name:currentUser.name, pickup:d, val:v, fee:f, date:new Date().toISOString(), status:"new"};
            try{ await fetch(API_URL, {method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body:JSON.stringify({action:'add', data:ord})});
            shopData.ordersToday++; shopData.ordersTotal++; shopData.history.unshift({dest:d, val:v, time:new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}); if(shopData.history.length>5)shopData.history.pop();
            localStorage.setItem('nOne_shop_data_v12', JSON.stringify(shopData)); updateUI(); showToast("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");
            document.getElementById('destination').value=''; document.getElementById('order_val').value=''; document.getElementById('delivery_fee').value='';
            } catch(e){showToast("Ø®Ø·Ø£");} finally{setLoading('btn-send',false,"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ ğŸš€");}
        }
        function updateUI() {
            document.getElementById('orders-today').innerText=shopData.ordersToday; document.getElementById('orders-total').innerText=shopData.ordersTotal;
            const l=document.getElementById('history-list'); l.innerHTML='';
            shopData.history.forEach(i=>{l.innerHTML+=`<div class="history-item"><div><div style="font-weight:bold;color:var(--primary);">${i.dest}</div><div style="font-size:11px;color:#94a3b8;">${i.time}</div></div><div style="font-weight:bold;color:var(--gold);">${i.val} Ø¯.Ø£</div></div>`;});
        }
        function logout(){ if(confirm("Ø®Ø±ÙˆØ¬ØŸ")){localStorage.removeItem('currentUser'); window.location.href='index.html';} }
        function showToast(m){ const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
        function setLoading(id,s,txt){ const b=document.getElementById(id); const l=document.getElementById('loader'); if(s){b.dataset.txt=b.innerText;b.innerText="...";b.disabled=true;b.style.opacity=0.7;l.style.width="100%";}else{b.innerText=txt||b.dataset.txt;b.disabled=false;b.style.opacity=1;l.style.width="0%";} }
    </script>
</body>
</html>
