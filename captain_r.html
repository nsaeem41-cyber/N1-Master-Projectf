<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>N One | Smart Master Controller ğŸ’</title>
    <meta name="theme-color" content="#0f172a">
    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Master Diamond (Royal Navy & Gold Theme) Ø§Ù„Ù…Ø¯Ù…Ø¬ ÙˆØ§Ù„Ø±Ø´ÙŠÙ‚ ================= */
        :root {
            --primary: #0f172a;    
            --accent: #1e293b;     
            --gold: #d4af37;       
            --bg: #f8fafc;         
            --text: #334155;       
            --success: #10b981;    
            --danger: #ef4444;     
            --info: #0ea5e9;
            --diamond: #e0f2fe;
            --app-color: #6366f1;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text); user-select: none;
            display: flex; justify-content: center; min-height: 100vh;
        }

        .admin-container {
            width: 100%;
            max-width: 600px;
            background: white;
            min-height: 100vh;
            box-shadow: 0 0 40px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 30px 20px 20px;
            text-align: center;
            color: white;
            border-bottom: 5px solid var(--gold);
        }

        .admin-logo {
            font-size: 28px;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .admin-sub {
            color: var(--gold);
            font-size: 14px;
            font-weight: bold;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            padding: 15px 25px 0;
            background: #f1f5f9;
            border-bottom: 1px solid #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 15px 15px 0 0;
            font-weight: 900;
            font-size: 14px;
            cursor: pointer;
            background: #e2e8f0;
            color: #64748b;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
            border-top: 3px solid var(--gold);
        }

        .content-wrapper {
            flex: 1;
            overflow-y: auto;
            position: relative;
        }

        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.4s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .control-card {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            border-right: 4px solid var(--gold);
        }

        .card-title {
            font-size: 16px;
            font-weight: 900;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 13px;
            margin-bottom: 8px;
            color: #64748b;
            font-weight: bold;
        }

        .input-group input, .input-group textarea, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            color: var(--text);
            font-weight: bold;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
            transition: 0.3s;
            font-family: inherit;
        }

        .btn-action {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 900;
            font-size: 15px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        .btn-action:active { transform: scale(0.98); }

        .btn-danger { background: var(--danger); box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2); }
        .btn-success { background: var(--success); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2); }

        .search-details-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .sd-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .sd-row:last-child { margin-bottom: 0; padding-top: 10px; border-top: 1px dashed #cbd5e1; }
        .sd-label { color: #64748b; }
        .sd-val { color: var(--primary); font-weight: 900; }

        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 999999; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; width: 90%; max-width: 400px;
        }

        .diamond-toggle { display: flex; align-items: center; gap: 6px; background: white; padding: 6px 12px; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.02); font-size: 12px; font-weight: 800; color: var(--text); cursor: pointer; transition: 0.3s; }
        .toggle-dot { width: 10px; height: 10px; border-radius: 50%; background: #cbd5e1; transition: 0.3s; }
        .diamond-toggle input { display: none; }
        .diamond-toggle input:checked + .toggle-dot { background: var(--success); box-shadow: 0 0 8px var(--success); }

        .btn-back { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 8px 15px; border-radius: 10px; font-weight: bold; font-size: 13px; cursor: pointer; margin-top: 15px; display: inline-flex; align-items: center; gap: 5px; }

        @keyframes pulseRocket { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); } 50% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        .radar-active { background: var(--success) !important; animation: pulseRocket 1.5s infinite; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-logo">N One <span style="color:var(--gold)">Diamond Master</span></div>
            <div class="admin-sub">Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ© ğŸ‘‘</div>
            <button class="btn-back" onclick="goBackToHome()">ğŸ”™ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        </div>

        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchMainTab('captains-tab', this)">ğŸ¦¸â€â™‚ï¸ Ø§Ù„ÙƒØ¨Ø§ØªÙ† ÙˆØ§Ù„Ø±Ø§Ø¯Ø§Ø±</button>
            <button class="tab-btn" onclick="switchMainTab('shops-tab', this)">ğŸª Ø§Ù„Ù…Ù†Ø´Ø¢Øª</button>
        </div>

        <div class="content-wrapper">
            
            <div id="captains-tab" class="tab-content active">
                
                <div class="control-card" style="border-right-color: var(--info);">
                    <div class="card-title">ğŸ” Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ§Ø¨ØªÙ†</div>
                    <div class="input-group">
                        <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø£Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù</label>
                        <input type="text" id="cap_search_query" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨Ø­Ø«...">
                    </div>
                    <button class="btn-action" style="background: var(--info);" onclick="searchRemoteCaptain()">Ø¨Ø­Ø« ÙˆØªØ­ÙƒÙ… ğŸ”</button>

                    <div id="cap_details_area" class="search-details-box" style="margin-top: 15px;">
                        <div class="sd-row"><span class="sd-label">Ø§Ù„Ø§Ø³Ù…</span><span class="sd-val" id="rc_name">---</span></div>
                        <div class="sd-row"><span class="sd-label">Ø§Ù„Ø­Ø§Ù„Ø©</span><span class="sd-val" id="rc_status">---</span></div>
                        <div class="sd-row"><span class="sd-label">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</span><span class="sd-val" id="rc_app">---</span></div>
                        <div class="sd-row"><span class="sd-label">Ø§Ù„Ø±ØµÙŠØ¯</span><span class="sd-val" id="rc_balance">0.00 Ø¯.Ø£</span></div>
                        <div class="sd-row" style="border-top: 1px dashed #cbd5e1; padding-top:10px;">
                            <span class="sd-label">Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø±Ù‚Ù…</span>
                            <label class="diamond-toggle">
                                <input type="checkbox" id="rc_hide_phone" onchange="toggleCapPhonePrivacy(this.checked)">
                                <div class="toggle-dot"></div> Ø¥Ø®ÙØ§Ø¡ Ø±Ù‚Ù…Ù‡
                            </label>
                        </div>
                        <button id="btn_freeze_cap" class="btn-action btn-danger" onclick="toggleRemoteCapStatus('paused')">ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† â„ï¸</button>
                        <button id="btn_unfreeze_cap" class="btn-action btn-success" style="display:none;" onclick="toggleRemoteCapStatus('active')">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒØ§Ø¨ØªÙ† âœ…</button>
                    </div>
                </div>

                <div class="control-card" style="border-right-color: var(--app-color);">
                    <div class="card-title">ğŸš€ Ù…Ø­Ø±Ùƒ Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Radar)</div>
                    <button id="btn-auto-radar" class="btn-action" style="background:var(--app-color);" onclick="toggleAutoRadar()">ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±</button>
                </div>

                <div class="control-card" style="border-right-color: var(--success);">
                    <div class="card-title">â³ Ø¹Ø¯Ø§Ø¯ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                    <div class="input-group">
                        <label>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³Ù…ÙˆØ­ (Ø«Ø§Ù†ÙŠØ©)</label>
                        <input type="number" id="timer_val" value="10" min="5">
                    </div>
                    <button class="btn-action btn-success" onclick="updateTimer()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ â±ï¸</button>
                </div>

                <div class="control-card" style="border-right-color: var(--danger);">
                    <div class="card-title">ğŸ›¡ï¸ ÙƒØ§Ø´Ù Ø§Ù„Ù€ VPN Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ</div>
                    <button id="btn_vpn_on" class="btn-action btn-danger" onclick="toggleVPN(true)">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ù‚ØµÙˆÙ‰ ğŸ”’</button>
                    <button id="btn_vpn_off" class="btn-action" style="background: #cbd5e1; color: var(--text); margin-top: 10px;" onclick="toggleVPN(false)">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ù…Ø§ÙŠØ© ğŸ”“</button>
                </div>

                <div class="control-card" style="border-right-color: var(--gold);">
                    <div class="card-title">ğŸ“ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ</div>
                    <button class="btn-action" style="background: var(--gold); color: var(--primary);" onclick="toggleZoneLock(true)">ØªØ«Ø¨ÙŠØª Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ø¨Ù…Ù†Ø§Ø·Ù‚Ù‡Ù… âœ…</button>
                    <button class="btn-action" style="background: #cbd5e1; color: var(--text); margin-top: 10px;" onclick="toggleZoneLock(false)">ÙØªØ­ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© âŒ</button>
                </div>

            </div>

            <div id="shops-tab" class="tab-content">
                <div class="control-card" style="border-right-color: var(--info);">
                    <div class="card-title">ğŸ” Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…Ù†Ø´Ø¢Øª</div>
                    <div class="input-group"><input type="text" id="shop_search_query" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø£Ùˆ Ù‡Ø§ØªÙ Ø§Ù„Ù…Ù†Ø´Ø£Ø©..."></div>
                    <button class="btn-action" style="background: var(--info);" onclick="searchRemoteShop()">Ø¨Ø­Ø« ğŸ”</button>

                    <div id="shop_details_area" class="search-details-box" style="margin-top: 15px;">
                        <div class="sd-row"><span class="sd-label">Ø§Ù„Ø§Ø³Ù…</span><span class="sd-val" id="rs_name">---</span></div>
                        <div class="sd-row"><span class="sd-label">Ø§Ù„Ø±ØµÙŠØ¯</span><span class="sd-val" id="rs_balance">0.00 Ø¯.Ø£</span></div>
                        <div class="input-group" style="margin-top:15px;">
                            <label>Ø´Ø­Ù† / Ø®ØµÙ… Ø±ØµÙŠØ¯</label>
                            <input type="number" id="rs_charge_val" placeholder="0.00">
                        </div>
                        <button class="btn-action btn-success" onclick="chargeRemoteShop()">ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ğŸ’µ</button>
                        <button id="btn_freeze_shop" class="btn-action btn-danger" onclick="toggleRemoteShopStatus('paused')">ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ù…Ù†Ø´Ø£Ø© â„ï¸</button>
                        <button id="btn_unfreeze_shop" class="btn-action btn-success" style="display:none;" onclick="toggleRemoteShopStatus('active')">ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´Ø£Ø© âœ…</button>
                    </div>
                </div>

                <div class="control-card" style="border-right-color: var(--night);">
                    <div class="card-title">ğŸ›¡ï¸ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø¬Ù…ÙŠØ¹</div>
                    <label class="diamond-toggle" style="width: 100%; justify-content: space-between; padding: 15px;">
                        <span>Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø±Ø¤ÙŠØ© Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆØ§ØªÙ</span>
                        <input type="checkbox" id="global_phone_toggle" onchange="toggleGlobalPhones(this.checked)">
                        <div class="toggle-dot" style="width:20px; height:20px;"></div>
                    </label>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, update, set, remove, get, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2dqEdbq5cN49leWIcjsTAq6l6KavN_sQ",
            authDomain: "n-one-global.firebaseapp.com",
            databaseURL: "https://n-one-global-default-rtdb.firebaseio.com",
            projectId: "n-one-global",
            storageBucket: "n-one-global.firebasestorage.app",
            messagingSenderId: "627262885530",
            appId: "1:627262885530:web:bc0ae0d748c61ed91b5923"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentTargetShop = null; let currentShopKey = '';
        let currentTargetCap = null; let currentCapKey = '';
        let currentUser = null; let isAutoRadarActive = false;
        let globalUsers = []; let allOrders = []; let allAssignedOrders = {};

        window.showToast = function(msg, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.style.background = isError ? 'var(--danger)' : 'var(--success)';
            toast.style.color = 'white'; toast.style.padding = '15px 20px'; toast.style.borderRadius = '15px';
            toast.style.fontWeight = 'bold'; toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        };

        window.switchMainTab = function(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active'); btn.classList.add('active');
        };

        // ================== Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒØ¨Ø§ØªÙ† ==================

        window.searchRemoteCaptain = async function() {
            const query = document.getElementById('cap_search_query').value.trim();
            if(!query) return;
            const snap = await get(ref(db, 'captains'));
            if(snap.exists()) {
                const caps = snap.val();
                for(let key in caps) {
                    if(caps[key].Cap_Phone === query || key === query || caps[key].Cap_User === query) {
                        currentTargetCap = caps[key]; currentCapKey = key;
                        renderCapDetails(); return;
                    }
                }
            }
            window.showToast("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø¨ØªÙ†", true);
        };

        function renderCapDetails() {
            document.getElementById('cap_details_area').style.display = 'block';
            document.getElementById('rc_name').innerText = currentTargetCap.Cap_Name || currentTargetCap.name;
            document.getElementById('rc_balance').innerText = parseFloat(currentTargetCap.Cap_Balance || 0).toFixed(2) + " Ø¯.Ø£";
            document.getElementById('rc_app').innerText = currentTargetCap.app_status === 'online' ? "ğŸŸ¢ Ù…ØªØµÙ„" : "âšª ØºÙŠØ± Ù…ØªØµÙ„";
            
            const status = currentTargetCap.Cap_Status || currentTargetCap.status;
            document.getElementById('rc_status').innerText = status === 'paused' ? "â„ï¸ Ù…Ø¬Ù…Ø¯" : "âœ… Ù†Ø´Ø·";
            document.getElementById('btn_freeze_cap').style.display = status === 'paused' ? 'none' : 'block';
            document.getElementById('btn_unfreeze_cap').style.display = status === 'paused' ? 'block' : 'none';
            document.getElementById('rc_hide_phone').checked = currentTargetCap.hide_phone === true;
        }

        window.toggleRemoteCapStatus = async function(newStatus) {
            const updates = {};
            updates[`captains/${currentCapKey}/Cap_Status`] = newStatus;
            updates[`captains/${currentCapKey}/status`] = newStatus;
            updates[`captains/${currentCapKey}/app_access`] = newStatus === 'paused' ? 'denied' : 'granted';
            await update(ref(db), updates);
            currentTargetCap.Cap_Status = newStatus; renderCapDetails();
            window.showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø¨ØªÙ†");
        };

        window.toggleCapPhonePrivacy = async function(isHidden) {
            await update(ref(db, `captains/${currentCapKey}`), { hide_phone: isHidden });
            window.showToast(isHidden ? "ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø¹Ù† Ø§Ù„Ù…Ù†Ø´Ø¢Øª" : "Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†");
        };

        window.toggleAutoRadar = function() {
            const savedUser = JSON.parse(localStorage.getItem('current_company_user') || localStorage.getItem('currentUser') || '{}');
            const myMaster = savedUser.Client_User || savedUser.user;
            const newState = !isAutoRadarActive;
            set(ref(db, `settings/${myMaster}/autoRadar`), newState);
        };

        window.updateTimer = async function() {
            const val = document.getElementById('timer_val').value;
            await set(ref(db, 'settings/order_timer'), { seconds: parseInt(val), timestamp: Date.now() });
            window.showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ù†Ù‚Ø¶Ø§Ø¶ â±ï¸");
        };

        window.toggleVPN = async function(isActive) {
            await set(ref(db, 'settings/anti_vpn'), { active: isActive, timestamp: Date.now() });
            window.showToast(isActive ? "ÙƒØ§Ø´Ù VPN Ù†Ø´Ø· ğŸ›¡ï¸" : "Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ø¹Ø·Ù„Ø© ğŸ”“");
        };

        // ================== Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…Ù†Ø´Ø¢Øª ==================

        window.searchRemoteShop = async function() {
            const query = document.getElementById('shop_search_query').value.trim();
            const snap = await get(ref(db));
            if(snap.exists()) {
                const data = snap.val();
                let found = null; let node = 'shops'; let k = '';
                const search = (obj, n) => {
                    for(let key in obj) {
                        if(obj[key].Shop_User === query || obj[key].user === query || obj[key].phone === query) { found = obj[key]; node = n; k = key; }
                    }
                };
                search(data.shops, 'shops'); if(!found) search(data.users, 'users');
                if(found) { currentTargetShop = found; currentShopKey = k; currentShopNode = node; renderShopDetails(); }
                else window.showToast("Ø§Ù„Ù…Ù†Ø´Ø£Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©", true);
            }
        };

        function renderShopDetails() {
            document.getElementById('shop_details_area').style.display = 'block';
            document.getElementById('rs_name').innerText = currentTargetShop.Shop_Name || currentTargetShop.Client_Name;
            document.getElementById('rs_balance').innerText = parseFloat(currentTargetShop.Shop_Balance || currentTargetShop.balance || 0).toFixed(2) + " Ø¯.Ø£";
            const status = currentTargetShop.Client_Status || currentTargetShop.status;
            document.getElementById('btn_freeze_shop').style.display = status === 'paused' ? 'none' : 'block';
            document.getElementById('btn_unfreeze_shop').style.display = status === 'paused' ? 'block' : 'none';
        }

        window.chargeRemoteShop = async function() {
            const amount = parseFloat(document.getElementById('rs_charge_val').value);
            if(isNaN(amount)) return;
            const current = parseFloat(currentTargetShop.Shop_Balance || currentTargetShop.balance || 0);
            const next = current + amount;
            const updates = {};
            updates[`${currentShopNode}/${currentShopKey}/Shop_Balance`] = next;
            updates[`${currentShopNode}/${currentShopKey}/balance`] = next;
            await update(ref(db), updates);
            currentTargetShop.Shop_Balance = next; renderShopDetails();
            window.showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ù†Ø´Ø£Ø© ğŸ’°");
        };

        window.toggleGlobalPhones = async function(isShowing) {
            const savedUser = JSON.parse(localStorage.getItem('current_company_user') || localStorage.getItem('currentUser') || '{}');
            const myMaster = savedUser.Client_User || savedUser.user;
            await set(ref(db, `settings/${myMaster}/show_phone_numbers`), isShowing);
            window.showToast(isShowing ? "Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ØªØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¢Ù†" : "ØªÙ… Ø­Ø¬Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹");
        };

        // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ©
        window.addEventListener('load', () => {
            const savedUser = JSON.parse(localStorage.getItem('current_company_user') || localStorage.getItem('currentUser') || '{}');
            const myMaster = savedUser.Client_User || savedUser.user;
            if(myMaster) {
                onValue(ref(db, `settings/${myMaster}/autoRadar`), (snap) => {
                    isAutoRadarActive = snap.val();
                    const btn = document.getElementById('btn-auto-radar');
                    if(isAutoRadarActive) { btn.classList.add('radar-active'); btn.innerText = "Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙŠØ¹Ù…Ù„ ğŸš€"; }
                    else { btn.classList.remove('radar-active'); btn.innerText = "ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¯Ø§Ø±"; }
                });
            }
        });

        window.goBackToHome = () => window.location.replace('index.html');

    </script>
</body>
</html>
