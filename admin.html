<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | ØºØ±ÙØ© Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø´Ø±ÙƒØ§Øª (Secure Isolation)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>

    <style>
        /* ================= Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„ØªØµÙ…ÙŠÙ… (Pro Theme) ================= */
        :root {
            --primary: #1a237e; --gold: #d4af37; --bg: #f4f7f6; --text: #333;
            --success: #2e7d32; --danger: #c62828; --warning: #f57f17; --info: #0288d1;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); user-select: none; }

        .navbar { background: white; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); border-bottom: 3px solid var(--gold); position: sticky; top: 0; z-index: 1000; }
        .brand { font-size: 24px; font-weight: 900; color: var(--primary); letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        .btn-logout { background: none; border: none; font-size: 16px; cursor: pointer; padding: 8px 15px; border-radius: 8px; background-color: var(--danger); color: white; transition: 0.3s; }
        .btn-logout:hover { background-color: #b71c1c; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); text-align: center; border-top: 5px solid var(--primary); }
        .stat-number { font-size: 32px; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .stat-label { color: #777; font-size: 13px; }

        /* Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ© */
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); margin-bottom: 30px; position: relative; }
        .card-header { font-size: 20px; font-weight: bold; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; background: #fafafa; }
        input:focus { border-color: var(--primary); background: white; }
        .btn-add { background: var(--success); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; height: 100%; width: 100%; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 950px; }
        thead { background: #f8f9fa; color: #555; font-weight: bold; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #eee; font-size: 14px; }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .status-active { background: #e8f5e9; color: var(--success); }
        .status-paused { background: #fff3e0; color: var(--warning); }
        .status-expired { background: #ffebee; color: var(--danger); } 

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .action-group { display: flex; gap: 5px; }
        .action-btn { padding: 6px 10px; border-radius: 6px; border: none; color: white; cursor: pointer; font-size: 12px; transition: 0.2s; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .act-freeze { background: var(--warning); }
        .act-active { background: var(--success); }
        .act-delete { background: var(--danger); }
        .act-renew { background: var(--info); }
        .act-edit { background: var(--primary); }

        #Admin_LoaderOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; justify-content: center; align-items: center; font-size: 18px; font-weight: bold; color: var(--primary); flex-direction: column; }
    </style>
</head>
<body>

    <div id="Admin_LoaderOverlay">
        <div style="font-size:30px; margin-bottom:10px;">ğŸ“¡</div>
        <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</div>
    </div>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Admin</div>
        <button class="btn-logout" onclick="Admin_Logout()">Ø®Ø±ÙˆØ¬ ğŸ”’</button>
    </nav>

    <div class="container">
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù†Ù‚Ù„ (Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡)</div>
                <div class="stat-number" id="Admin_CountClients">0</div>
            </div>
            <div class="stat-card" style="border-top-color: var(--success);">
                <div class="stat-label">Ø´Ø±ÙƒØ§Øª Ù†Ø´Ø·Ø©</div>
                <div class="stat-number" id="Admin_CountActive" style="color: var(--success);">0</div>
            </div>
            <div class="stat-card" style="border-top-color: var(--gold);">
                <div class="stat-label">Ø§Ù„Ù…Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
                <div class="stat-number" id="Admin_RevCount" style="color: var(--gold);">0</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>âœ¨ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙƒØ© Ù†Ù‚Ù„ Ø¬Ø¯ÙŠØ¯Ø© (System Isolation)</span>
            </div>
            <div class="form-grid">
                <input type="text" id="Admin_NewName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ Ù„Ù„Ø´Ø±ÙƒØ©">
                <input type="text" id="Admin_NewUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (User ID) - ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§">
                <input type="password" id="Admin_NewPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <select id="Admin_SubDuration">
                    <option value="30">30 ÙŠÙˆÙ…</option>
                    <option value="90">3 Ø£Ø´Ù‡Ø±</option>
                    <option value="180">6 Ø£Ø´Ù‡Ø±</option>
                    <option value="365">Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©</option>
                </select>
                <input type="number" id="Admin_SubPrice" placeholder="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ (Ø¯.Ø£)">
                <button class="btn-add" id="Admin_BtnAddUser" onclick="Admin_AddUser()">+ Ø¥Ø¶Ø§ÙØ© Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø³ØªÙ‚Ù„Ø© ğŸš€</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span>ğŸ¢ Ø³Ø¬Ù„ Ø´Ø±ÙƒØ§Øª Ø§Ù„Ù†Ù‚Ù„ (Companies Log)</span>
                <span style="font-size:12px; color:#1a237e;">White Label Clients</span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø´Ø±ÙƒØ©</th>
                            <th>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (ID)</th>
                            <th>Ø§Ù„Ø®Ø·Ø© / Ø§Ù„Ø³Ø¹Ø±</th>
                            <th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„</th>
                        </tr>
                    </thead>
                    <tbody id="Admin_ClientsTable">
                        <tr><td colspan="6" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // Ø±Ø§Ø¨Ø· Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ø¯Ø«
        if (typeof Core_N_ONE_CORE !== 'undefined') {
            Core_N_ONE_CORE.Core_API_URL = "https://script.google.com/macros/s/AKfycbxFVz0QTi_7TgWQEMImtMGYRBzlD1CwM5X4DbprUvVJkURs_75aD5n5IcpbS87d8Q5j/exec";
        }

        let Admin_AllData = [];
        let Admin_GlobalServerTime = new Date(); 

        window.onload = async function() {
            if (typeof Core_N_ONE_CORE === 'undefined') { alert("Ø®Ø·Ø£ Ø§Ù„Ù…ØµÙ„Ø­ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ ØºÙŠØ± Ù…ØªØµÙ„"); return; }
            if (Core_N_ONE_CORE.Core_checkSession('admin')) {
                await Admin_FetchServerTime();
                await Admin_FetchData();
            }
        };

        async function Admin_FetchServerTime() {
            try {
                const Admin_Res = await fetch("http://worldtimeapi.org/api/timezone/Asia/Amman");
                const Admin_TimeData = await Admin_Res.json();
                Admin_GlobalServerTime = new Date(Admin_TimeData.datetime);
            } catch (e) { Admin_GlobalServerTime = new Date(); }
        }

        async function Admin_FetchData() {
            try {
                Admin_AllData = await Core_N_ONE_CORE.Core_fetchData('read');
                Admin_RenderTables();
            } catch (e) { console.error(e); }
        }

        function Admin_RenderTables() {
            const Admin_ClientTbody = document.getElementById('Admin_ClientsTable');
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙƒØ§Øª ÙÙ‚Ø·
            const Admin_Clients = Admin_AllData.filter(u => u.Auth_Role === 'client' || u.Auth_Type === 'client').reverse();

            document.getElementById('Admin_CountClients').innerText = Admin_Clients.length;
            document.getElementById('Admin_CountActive').innerText = Admin_Clients.filter(c => c.Auth_Status === 'active').length;
            
            let Admin_TotalRev = 0;
            Admin_Clients.forEach(c => Admin_TotalRev += Number(c.Admin_Price || 0));
            document.getElementById('Admin_RevCount').innerText = Admin_TotalRev.toFixed(0);

            Admin_RenderRows(Admin_ClientTbody, Admin_Clients);
        }

        function Admin_RenderRows(Admin_Tbody, Admin_Data) {
            if (Admin_Data.length === 0) { Admin_Tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>'; return; }
            Admin_Tbody.innerHTML = '';
            
            Admin_Data.forEach(Admin_Item => {
                const Admin_ExpiryDate = new Date(Admin_Item.Auth_Expiry);
                const Admin_DiffTime = Admin_ExpiryDate - Admin_GlobalServerTime;
                const Admin_DiffDays = Math.ceil(Admin_DiffTime / (1000 * 60 * 60 * 24));

                let Admin_StatusBadge = '';
                let Admin_DaysText = '';

                let Admin_CurrentStatus = String(Admin_Item.Auth_Status || 'active').trim().toLowerCase();

                if (Admin_CurrentStatus === 'paused') {
                    Admin_StatusBadge = `<span class="status-badge status-paused">Ù…Ø¬Ù…Ø¯ â„ï¸</span>`;
                    Admin_DaysText = `<span style="color:#f57f17;">Ù…ÙˆÙ‚Ù</span>`;
                } else if (Admin_DiffDays <= 0) {
                    Admin_StatusBadge = `<span class="status-badge status-expired">Ù…Ù†ØªÙ‡ÙŠ â›”</span>`;
                    Admin_DaysText = `<span style="color:#c62828; font-weight:bold;">Ø§Ù†ØªÙ‡Ù‰</span>`;
                    if(Admin_CurrentStatus === 'active') Admin_SetStatusSilent(Admin_Item.Auth_User, 'paused');
                } else {
                    Admin_StatusBadge = `<span class="status-badge status-active">Ù†Ø´Ø· âœ…</span>`;
                    Admin_DaysText = Admin_DiffDays <= 3 ? `<span style="color:#c62828;">${Admin_DiffDays} ÙŠÙˆÙ… âš ï¸</span>` : `<span style="color:#2e7d32;">${Admin_DiffDays} ÙŠÙˆÙ…</span>`;
                }
                
                const Admin_ToggleBtn = Admin_CurrentStatus === 'active'
                    ? `<button class="action-btn act-freeze" title="ØªØ¬Ù…ÙŠØ¯" onclick="Admin_SetStatus('${Admin_Item.Auth_User}', 'active')">â„ï¸</button>`
                    : `<button class="action-btn act-active" title="ØªÙØ¹ÙŠÙ„" onclick="Admin_SetStatus('${Admin_Item.Auth_User}', 'paused')">â–¶ï¸</button>`;

                const Admin_Row = `
                    <tr>
                        <td><b>${Admin_Item.Auth_Name}</b></td>
                        <td style="font-size:12px; color:#555;">${Admin_Item.Auth_User}<br>Pwd: ${Admin_Item.Auth_Pass}</td>
                        <td style="font-size:12px;">${Admin_Item.Admin_Price || 0} Ø¯.Ø£</td>
                        <td>${Admin_DaysText}</td>
                        <td>${Admin_StatusBadge}</td>
                        <td>
                            <div class="action-group">
                                <button class="action-btn act-edit" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" onclick="Admin_EditUser('${Admin_Item.Auth_User}', '${Admin_Item.Auth_Name}', '${Admin_Item.Auth_Pass}')">âœï¸</button>
                                ${Admin_ToggleBtn}
                                <button class="action-btn act-renew" title="ØªØ¬Ø¯ÙŠØ¯" onclick="Admin_RenewUser('${Admin_Item.Auth_User}')">ğŸ”„</button>
                                <button class="action-btn act-delete" title="Ø­Ø°Ù" onclick="Admin_DeleteUser('${Admin_Item.Auth_User}')">âŒ</button>
                            </div>
                        </td>
                    </tr>
                `;
                Admin_Tbody.innerHTML += Admin_Row;
            });
        }

        async function Admin_AddUser() {
            const Admin_Role = 'client';
            const Admin_Name = document.getElementById('Admin_NewName').value;
            const Admin_User = document.getElementById('Admin_NewUser').value.trim(); 
            const Admin_Pass = document.getElementById('Admin_NewPass').value;
            const Admin_Days = document.getElementById('Admin_SubDuration').value;
            const Admin_Price = document.getElementById('Admin_SubPrice').value;

            if (!Admin_Name || !Admin_User || !Admin_Pass || !Admin_Price) { alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒØ§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ â˜ºï¸"); return; }

            const Admin_Exists = Admin_AllData.some(u => String(u.Auth_User).toLowerCase() === Admin_User.toLowerCase());
            if (Admin_Exists) {
                alert("ØªÙ†Ø¨ÙŠÙ‡ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… Ø¢Ø®Ø± Ù„Ø¶Ù…Ø§Ù† Ø¹Ø²Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                return;
            }

            const Admin_ExpDate = new Date(Admin_GlobalServerTime);
            Admin_ExpDate.setDate(Admin_ExpDate.getDate() + parseInt(Admin_Days));
            
            document.getElementById('Admin_LoaderOverlay').style.display = 'flex';
            const Admin_NewItem = {
                Auth_ID: "CL_" + Date.now(),
                Auth_User: Admin_User, 
                Auth_Pass: Admin_Pass, 
                Auth_Name: Admin_Name, 
                Auth_Role: Admin_Role, 
                Auth_Type: Admin_Role, 
                Auth_Status: "active",
                Auth_Expiry: Admin_ExpDate.toISOString().split('T')[0], 
                Admin_Price: Admin_Price, 
                Admin_PlanDays: Admin_Days
            };

            await Core_N_ONE_CORE.Core_postData('add', [Admin_NewItem]);
            await Admin_FetchData();
            document.getElementById('Admin_LoaderOverlay').style.display = 'none';
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø²ÙˆÙ„Ø© â˜ºï¸âœ…");
            
            document.getElementById('Admin_NewName').value = '';
            document.getElementById('Admin_NewUser').value = '';
            document.getElementById('Admin_NewPass').value = '';
        }

        async function Admin_EditUser(Admin_Username, Admin_OldName, Admin_OldPass) {
            const Admin_NewName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ", Admin_OldName);
            if (Admin_NewName === null) return;
            const Admin_NewPass = prompt("ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", Admin_OldPass);
            if (Admin_NewPass === null) return;

            if (Admin_NewName === Admin_OldName && Admin_NewPass === Admin_OldPass) return;

            document.getElementById('Admin_LoaderOverlay').style.display = 'flex';
            await Core_N_ONE_CORE.Core_postData('update', { Auth_User: Admin_Username, data: { Auth_Name: Admin_NewName, Auth_Pass: Admin_NewPass } });
            await Admin_FetchData();
            document.getElementById('Admin_LoaderOverlay').style.display = 'none';
            alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â˜ºï¸");
        }

        async function Admin_SetStatus(Admin_Username, Admin_CurrentStatus) {
            const Admin_NextStatus = (Admin_CurrentStatus === 'active') ? 'paused' : 'active';
            if (!confirm(Admin_NextStatus === 'paused' ? "ØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨" : "Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„")) return;
            
            document.getElementById('Admin_LoaderOverlay').style.display = 'flex';
            await Core_N_ONE_CORE.Core_postData('update', { Auth_User: Admin_Username, data: { Auth_Status: Admin_NextStatus } });
            await Admin_FetchData();
            document.getElementById('Admin_LoaderOverlay').style.display = 'none';
        }

        async function Admin_SetStatusSilent(Admin_Username, Admin_NewStatus) {
            await Core_N_ONE_CORE.Core_postData('update', { Auth_User: Admin_Username, data: { Auth_Status: Admin_NewStatus } });
        }

        async function Admin_RenewUser(Admin_Username) {
            const Admin_Days = prompt("Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©", "30");
            if (!Admin_Days) return;
            const Admin_NewPrice = prompt("Ù‚ÙŠÙ…Ø© Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù„Ù„Ø¬Ø±Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ 0 Ø¥Ø°Ø§ Ù…Ø¬Ø§Ù†ÙŠ", "0");

            const Admin_NewDate = new Date(Admin_GlobalServerTime);
            Admin_NewDate.setDate(Admin_NewDate.getDate() + parseInt(Admin_Days));

            document.getElementById('Admin_LoaderOverlay').style.display = 'flex';
            await Core_N_ONE_CORE.Core_postData('update', { Auth_User: Admin_Username, data: { Auth_Expiry: Admin_NewDate.toISOString().split('T')[0], Auth_Status: 'active', Admin_Price: Admin_NewPrice } });
            await Admin_FetchData();
            document.getElementById('Admin_LoaderOverlay').style.display = 'none';
            alert("ØªÙ… ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ â˜ºï¸ğŸ“…");
        }

        async function Admin_DeleteUser(Admin_Username) {
            if (!confirm("ØªØ­Ø°ÙŠØ± Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯")) return;
            document.getElementById('Admin_LoaderOverlay').style.display = 'flex';
            await Core_N_ONE_CORE.Core_fetchData('delete', { Auth_User: Admin_Username });
            await Admin_FetchData();
            document.getElementById('Admin_LoaderOverlay').style.display = 'none';
            alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ğŸ—‘ï¸");
        }

        function Admin_Logout() { Core_N_ONE_CORE.Core_logout(); }
    </script>

</body>
</html>
