<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø§Ø³ÙŠØ© (Final Edition)</title>
    
    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Diamond Matrix (Royal Navy & Gold) ================= */
        :root {
            --primary: #0f172a;      /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ Ø¹Ù…ÙŠÙ‚ */
            --accent: #1e293b;       /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ ÙØ§ØªØ­ */
            --gold: #d4af37;         /* Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ */
            --bg: #f8fafc;           /* Ø®Ù„ÙÙŠØ© Ù‡Ø§Ø¯Ø¦Ø© */
            --panel: #ffffff;      
            --text: #334155;       
            --success: #10b981;    
            --danger: #ef4444;     
            --info: #0ea5e9;
            --diamond: #e0f2fe;
            --night: #311b92;        /* Ù„ÙˆÙ† Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø³Ø§Ø­Ø± */
            --app-color: #6366f1;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text); user-select: none; overflow-x: hidden; 
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠ */
        .navbar { 
            background: var(--primary); height: 75px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; 
            box-shadow: 0 4px 25px rgba(15, 23, 42, 0.2); 
            border-bottom: 4px solid var(--gold); 
            position: sticky; top: 0; z-index: 1000; transition: 0.5s;
        }
        /* ÙˆØ¶Ø¹ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .navbar.night-mode { background: linear-gradient(45deg, #0f172a, #311b92); border-bottom-color: #7c4dff; }

        .brand { font-size: 24px; font-weight: 900; color: white; letter-spacing: 1.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 15px; }
        .gold-text { color: var(--gold); }
        .company-name-badge { font-size: 13px; background: rgba(255,255,255,0.1); padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(212, 175, 55, 0.3); color: var(--gold); }
        
        .btn-back { background: var(--accent); color: white; border: 1px solid #475569; padding: 10px 20px; border-radius: 12px; cursor: pointer; text-decoration: none; font-size: 14px; font-weight: bold; transition: 0.3s; display: flex; align-items: center; gap: 5px; }
        .btn-back:hover { background: #334155; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        /* Ø¨Ù†Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .night-control-bar {
            background: white; padding: 15px 25px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); margin-bottom: 25px;
            display: flex; justify-content: space-between; align-items: center;
            border-left: 6px solid var(--night);
            border-right: 1px solid #e2e8f0; border-top: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
        }
        
        /* Ø²Ø± Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ (Switch) */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--night); }
        input:checked + .slider:before { transform: translateX(24px); }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .controls-panel { 
            background: white; padding: 25px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); margin-bottom: 30px;
            border-top: 5px solid var(--primary);
            border-left: 1px solid #e2e8f0; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;
        }
        
        .controls-row { display: flex; justify-content: space-between; align-items: center; gap: 20px; margin-bottom: 20px; }
        
        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…ØµØ¯Ø± */
        .source-group { display: flex; gap: 12px; align-items: center; flex: 1; }
        .source-select { padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 12px; font-weight: 800; color: var(--primary); outline: none; flex: 1; font-size: 15px; background: #f8fafc; transition: 0.3s; }
        .source-select:focus { border-color: var(--gold); background: white; box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1); }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ù„ÙƒÙŠØ© */
        .btn-royal {
            padding: 12px 20px; border: none; border-radius: 12px; font-weight: 800;
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
            background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.1); font-size: 14px;
        }
        .btn-royal:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(15, 23, 42, 0.15); }
        .btn-royal:active { transform: scale(0.98); }
        .btn-gold { background: var(--gold); color: var(--primary); }
        .btn-save { background: var(--success); }

        .action-btns { display: flex; gap: 8px; }
        .mini-circle-btn { 
            width: 40px; height: 40px; border-radius: 50%; border: none; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
            font-size: 16px; background: #f1f5f9; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .mini-circle-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); }
        
        /* Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± */
        .search-box { flex: 2; position: relative; }
        .search-input { width: 100%; padding: 14px 45px 14px 15px; border: 2px solid #e2e8f0; border-radius: 12px; outline: none; background: #f8fafc; font-size: 15px; font-weight: 700; color: var(--primary); box-sizing: border-box; transition: 0.3s; }
        .search-input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(15, 23, 42, 0.05); }
        .search-icon { position: absolute; right: 15px; top: 14px; font-size: 16px; color: #94a3b8; }

        /* Ø§Ù„Ù…ØµÙÙˆÙØ© (Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬) */
        .matrix-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(500px, 1fr)); gap: 20px; }

        .price-card {
            background: white; border-radius: 20px; padding: 18px 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid #e2e8f0;
            display: flex; align-items: center; gap: 15px; transition: 0.3s;
            position: relative; overflow: hidden;
        }
        .price-card:hover { transform: translateY(-3px); box-shadow: 0 15px 35px rgba(0,0,0,0.08); border-color: var(--gold); }

        /* Ø§Ù„ÙƒØ±Øª Ø§Ù„Ø°Ù‡Ø¨ÙŠ (Ø¹Ø±Ø¶ Ø®Ø§Øµ) */
        .price-card.gold-offer {
            background: linear-gradient(135deg, #fefce8, #fef9c3);
            border: 1px solid var(--gold);
            box-shadow: 0 10px 25px rgba(212, 175, 55, 0.2);
        }
        .price-card.gold-offer .area-name-input { color: #b45309; }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ±Ù†Ø¯ */
        .trend-icon { font-size: 11px; position: absolute; top: 8px; left: 15px; opacity: 0.8; font-weight: bold; color: var(--primary); }

        /* Ù…Ø¤Ø´Ø± Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .color-indicator { width: 6px; height: 100%; position: absolute; right: 0; top: 0; border-radius: 0 20px 20px 0; }
        .low-price { background: #10b981; } 
        .med-price { background: #f59e0b; } 
        .high-price { background: #ef4444; } 

        .area-name-input { border: none; font-weight: 900; font-size: 16px; color: var(--primary); flex: 1; outline: none; background: transparent; transition: 0.3s; padding: 8px; border-radius: 8px; }
        .area-name-input:focus { background: #f1f5f9; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }

        /* Ø®Ø§Ù†Ø© Ø§Ù„Ø³Ø¹Ø± */
        .price-wrapper { position: relative; display: flex; align-items: center; }
        .price-val-input { width: 80px; padding: 10px; border: 2px solid #e2e8f0; border-radius: 12px; text-align: center; font-weight: 900; color: var(--primary); outline: none; font-size: 16px; transition: 0.3s; background: #f8fafc; }
        .price-val-input:focus { border-color: var(--gold); background: white; box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1); }
        
        /* Ø´Ø§Ø±Ø© Ø§Ù„Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù„ÙŠÙ„ÙŠØ© */
        .night-badge { 
            font-size: 11px; font-weight: 800; background: var(--night); color: white; 
            padding: 4px 8px; border-radius: 8px; position: absolute; 
            top: -15px; right: -10px; white-space: nowrap; pointer-events: none;
            box-shadow: 0 2px 5px rgba(49, 27, 146, 0.3);
        }

        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙƒØ±Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        .card-tools { display: flex; gap: 8px; align-items: center; }
        .btn-map { color: var(--info); }
        .btn-offer { color: #94a3b8; } 
        .btn-offer.active { color: #f59e0b; text-shadow: 0 0 8px rgba(245, 158, 11, 0.5); background: #fefce8; border-color: #fde68a; }

        /* ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ø®ÙÙŠØ© */
        .print-header { display: none; text-align: center; border-bottom: 4px solid var(--gold); padding-bottom: 15px; margin-bottom: 25px; }

        /* ================= ØªØµÙ…ÙŠÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ================= */
        @media print {
            body { background: white; -webkit-print-color-adjust: exact; }
            .navbar, .controls-panel, .night-control-bar, .card-tools, .btn-royal, .night-badge { display: none !important; }
            .container { margin: 0; padding: 0; max-width: 100%; }
            .print-header { display: block; }
            .matrix-container { display: block; column-count: 2; column-gap: 25px; }
            .price-card { break-inside: avoid; border: 1px solid #cbd5e1; box-shadow: none; margin-bottom: 12px; padding: 10px 15px; border-radius: 10px; }
            .area-name-input, .price-val-input { border: none; background: transparent; font-size: 14px; }
            .price-val-input { text-align: left; }
        }
    </style>
</head>
<body>

    <nav class="navbar" id="main-nav">
        <div class="brand">
            N <span class="gold-text">One</span> Diamond Matrix ğŸ’
            <span id="header-company-name" class="company-name-badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
        <a href="client.html" class="btn-back">ğŸ”™ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
    </nav>

    <div class="container">
        
        <div class="night-control-bar">
            <div style="display:flex; align-items:center; gap:15px;">
                <span style="font-size:28px;">ğŸŒ™</span>
                <div>
                    <div style="font-weight:900; font-size:16px; color:var(--primary);">Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù„ÙŠÙ„ÙŠ (Ø§Ù„ØªØ³Ø¹ÙŠØ± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ø°ÙƒÙŠ)</div>
                    <div style="font-size:12px; font-weight:bold; color:#64748b; margin-top:3px;">ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø³ÙŠØ³ØªÙ… Ø¨Ø¥Ø¶Ø§ÙØ© 0.50 Ø¯.Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø© 11:00 Ù… ÙˆØªØ¹ÙˆØ¯ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù„Ø·Ø¨ÙŠØ¹ØªÙ‡Ø§ ØµØ¨Ø§Ø­Ø§Ù‹</div>
                </div>
            </div>
            <label class="switch">
                <input type="checkbox" id="night-toggle" onchange="toggleNightModeOverride()" checked>
                <span class="slider"></span>
            </label>
        </div>

        <div class="controls-panel">
            <div class="controls-row">
                <div class="source-group">
                    <label style="font-weight:900; font-size:14px; color:var(--primary);">Ø§Ù„Ù…ØµØ¯Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯:</label>
                    <select id="source-select" class="source-select" onchange="renderMatrix()">
                        </select>
                    <div class="action-btns">
                        <button class="mini-circle-btn" onclick="addSource()" title="Ø¥Ø¶Ø§ÙØ© Ù…ØµØ¯Ø± Ø¬Ø¯ÙŠØ¯">â•</button>
                        <button class="mini-circle-btn" onclick="duplicateSource()" title="Ù†Ø³Ø® Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (Quick Duplicate)" style="background:#f0f9ff; color:var(--info); border: 1px solid #bae6fd;">ğŸ“‘</button>
                        <button class="mini-circle-btn" onclick="deleteSource()" title="Ø­Ø°Ù Ø§Ù„Ù…ØµØ¯Ø±" style="background:#fef2f2; color:var(--danger); border: 1px solid #fecaca;">ğŸ—‘ï¸</button>
                    </div>
                </div>

                <div class="search-box">
                    <span class="search-icon">ğŸ”</span>
                    <input type="text" id="search-input" class="search-input" placeholder="Ø¨Ø­Ø« Ø°ÙƒÙŠ Ø¹Ù† Ù…Ù†Ø·Ù‚Ø©..." oninput="renderMatrix()">
                </div>
            </div>

            <div class="controls-row" style="justify-content: flex-end; margin-bottom:0; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                <div class="action-btns" style="gap: 15px;">
                    <button class="btn-royal" style="background:var(--accent);" onclick="addArea()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚Ø©</button>
                    <button class="btn-royal" style="background:#64748b;" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ÙƒØ´Ù</button>
                    <button class="btn-royal btn-save" id="save-btn" onclick="saveData()">ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</button>
                </div>
            </div>
        </div>

        <div class="print-header">
            <h1 style="color:var(--primary); margin:0; font-weight:900;">N <span style="color:var(--gold)">One</span> Delivery</h1>
            <p style="margin:8px 0; color:#475569; font-size:15px; font-weight:bold;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© - <span id="print-source-name" style="color:var(--primary);"></span></p>
        </div>

        <div id="matrix-grid" class="matrix-container">
            </div>

    </div>

    <script type="module">
        // ========================================================
        // ÙƒÙˆØ¯ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø§Ø³ÙŠØ© - v9.0 (Diamond Root Identity Edition)
        // ========================================================
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getDatabase, ref, set, get, child, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2dqEdbq5cN49leWIcjsTAq6l6KavN_sQ",
            authDomain: "n-one-global.firebaseapp.com",
            databaseURL: "https://n-one-global-default-rtdb.firebaseio.com",
            projectId: "n-one-global",
            storageBucket: "n-one-global.firebasestorage.app",
            messagingSenderId: "627262885530",
            appId: "1:627262885530:web:bc0ae0d748c61ed91b5923"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let pricingData = {};
        let isNightActive = false; 
        let currentUser = null;

        window.onload = async function() {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ÙˆØ³Ø­Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ù„Ù„Ø§Ù†Ø¯Ù…Ø§Ø¬ Ø§Ù„ÙƒÙ„ÙŠ
            const savedUser = localStorage.getItem('current_company_user') || localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('header-company-name').innerText = currentUser.Client_Name || currentUser.name || "Ø§Ù„Ø´Ø±ÙƒØ©";
            } else {
                alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ÙŠØ§ Ø¨Ø·Ø© ğŸ˜Š");
                window.location.replace('index.html');
                return;
            }

            const savedToggle = localStorage.getItem('nOne_night_toggle');
            if (savedToggle !== null) {
                document.getElementById('night-toggle').checked = (savedToggle === 'true');
            }
            
            setupRealtimeFreezeListener(); // Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ©
            checkNightMode(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù„ÙŠÙ„ÙŠ
            fetchPricesFromCloud();
            
            // ÙØ­Øµ Ø¯ÙˆØ±ÙŠ ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù„ÙŠÙ„ÙŠ ÙŠØ´ØªØºÙ„ Ù„Ø­Ø§Ù„Ù‡
            setInterval(checkNightMode, 60000);
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙƒÙ†Ø³Ø© Ø§Ù„Ø£Ù„Ù…Ø§Ø³ÙŠØ© Ù„Ù„Ø³ÙŠØ·Ø±Ø© Ø§Ù„Ù…Ø·Ù„Ù‚Ø©
        function setupRealtimeFreezeListener() {
            if(!currentUser || (!currentUser.Client_User && !currentUser.user)) return;
            const username = currentUser.Client_User || currentUser.user;
            const myRef = ref(db, `users/${username}`);
            
            onValue(myRef, (snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.Client_Status === 'paused' || data.status === 'paused') {
                        alert("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø­Ø³Ø§Ø¨ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ© ğŸ˜Š");
                        localStorage.removeItem('current_company_user');
                        localStorage.removeItem('currentUser');
                        window.location.replace('index.html');
                    }
                } else {
                    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ ÙÙˆØ±Ø§Ù‹ ğŸ˜Š");
                    localStorage.removeItem('current_company_user');
                    localStorage.removeItem('currentUser');
                    window.location.replace('index.html');
                }
            });
        }

        window.fetchPricesFromCloud = function() {
            const pricesRef = ref(db, 'prices');
            
            // Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù…Ø¹ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ø°ÙˆØ± Ø§Ù„ØªØ§Ø¨Ø¹Ø©
            onValue(pricesRef, (snapshot) => {
                pricingData = {};
                const myMaster = currentUser.Client_User || currentUser.user;

                if (snapshot.exists()) {
                    const data = Object.values(snapshot.val());
                    
                    data.forEach(r => {
                        // ØªØ·Ø¨ÙŠÙ‚ ØµØ§Ø±Ù… Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø°ÙˆØ± Ø§Ù„ØªØ§Ø¨Ø¹Ø©
                        if (r.Client_Master === myMaster) {
                            if (!pricingData[r.Price_Source]) pricingData[r.Price_Source] = [];
                            pricingData[r.Price_Source].push({
                                id: r.Price_ID,
                                area: r.Price_Area,
                                price: parseFloat(r.Price_Base || 0),
                                isOffer: r.Price_Offer === 'true',
                                lastMod: r.Price_Date ? new Date(r.Price_Date).getTime() : Date.now()
                            });
                        }
                    });
                } 
                
                // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø´Ø±ÙƒØ© ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµØ¯Ø± Ø§ÙØªØ±Ø§Ø¶ÙŠ
                if (Object.keys(pricingData).length === 0) {
                    pricingData["Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"] = [];
                }
                
                populateSources();
                renderMatrix();
            });
        }

        // Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø§Ù„Ø°ÙƒÙŠØ©
        window.checkNightMode = function() {
            const hour = new Date().getHours();
            // ØªÙØ¹ÙŠÙ„ Ù…Ù† 11:00 Ù… (23) Ø¥Ù„Ù‰ 5:59 Øµ (Ù‚Ø¨Ù„ 6)
            const isNightTime = (hour >= 23 || hour < 6);
            const isToggleOn = document.getElementById('night-toggle').checked;
            
            const shouldBeNight = isNightTime && isToggleOn;

            if (shouldBeNight !== isNightActive) {
                isNightActive = shouldBeNight;
                renderMatrix(); // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø£Ø³Ø¹Ø§Ø±
            }

            const nav = document.getElementById('main-nav');
            if (isNightActive) nav.classList.add('night-mode');
            else nav.classList.remove('night-mode');
        }

        window.toggleNightModeOverride = function() {
            const isChecked = document.getElementById('night-toggle').checked;
            localStorage.setItem('nOne_night_toggle', isChecked);
            checkNightMode();
        }

        window.populateSources = function() {
            const select = document.getElementById('source-select');
            const currentVal = select.value;
            select.innerHTML = '';
            Object.keys(pricingData).forEach(source => {
                const option = document.createElement('option');
                option.value = source;
                option.innerText = source;
                select.appendChild(option);
            });
            if (currentVal && pricingData[currentVal]) select.value = currentVal;
        }

        window.addSource = function() {
            const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…ØµØ¯Ø± Ø£Ùˆ Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ˜Š");
            if (name && !pricingData[name]) {
                pricingData[name] = [];
                populateSources();
                document.getElementById('source-select').value = name;
                renderMatrix();
            }
        }

        window.duplicateSource = function() {
            const current = document.getElementById('source-select').value;
            if(!current || !pricingData[current]) return;
            
            const newName = prompt(`Ù†Ø³Ø® Ù‚Ø§Ø¦Ù…Ø© ${current} Ø¥Ù„Ù‰ Ù…ØµØ¯Ø± Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ø³Ù… ğŸ˜Š`);
            if (newName && !pricingData[newName]) {
                pricingData[newName] = JSON.parse(JSON.stringify(pricingData[current]));
                pricingData[newName].forEach(item => { item.id = "PRC_" + Date.now() + Math.floor(Math.random()*1000); });
                populateSources();
                document.getElementById('source-select').value = newName;
                renderMatrix();
            }
        }

        window.deleteSource = function() {
            const current = document.getElementById('source-select').value;
            if(!current || !pricingData[current]) return;

            if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‚Ø§Ø¦Ù…Ø© ${current} Ù†Ù‡Ø§Ø¦ÙŠØ§ ğŸ˜Š`)) {
                const idsToDelete = pricingData[current].map(i => i.id);
                idsToDelete.forEach(async (id) => {
                    await remove(ref(db, `prices/${id}`));
                });

                delete pricingData[current];
                if (Object.keys(pricingData).length === 0) pricingData["Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"] = [];
                populateSources();
                renderMatrix();
            }
        }

        window.renderMatrix = function() {
            const source = document.getElementById('source-select').value;
            if(!source) return;
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const container = document.getElementById('matrix-grid');
            
            document.getElementById('print-source-name').innerText = source;
            container.innerHTML = '';

            const areas = pricingData[source] || [];

            areas.forEach((item, index) => {
                if (searchTerm && !item.area.toLowerCase().includes(searchTerm)) return;

                const basePrice = parseFloat(item.price);
                
                let displayPrice = basePrice;
                let nightBadgeHtml = '';
                
                // Ø¥Ø¶Ø§ÙØ© ØªØ³Ø¹ÙŠØ±Ø© Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù„ÙŠÙ„ÙŠ
                if (isNightActive) {
                    displayPrice += 0.50;
                    nightBadgeHtml = `<span class="night-badge">+0.50 Ù„ÙŠÙ„ÙŠ ğŸŒ™</span>`;
                }

                let colorClass = 'med-price';
                if (basePrice < 3) colorClass = 'low-price';
                if (basePrice >= 5) colorClass = 'high-price';

                const offerClass = item.isOffer ? 'gold-offer' : '';
                const starClass = item.isOffer ? 'active' : '';

                let trendHtml = '';
                const oneDay = 24 * 60 * 60 * 1000;
                if (item.lastMod && (Date.now() - item.lastMod < oneDay)) {
                    trendHtml = '<span class="trend-icon">ğŸ“ˆ Ù…Ø­Ø¯Ø«</span>';
                }

                container.innerHTML += `
                    <div class="price-card ${offerClass}">
                        <div class="color-indicator ${colorClass}"></div>
                        ${trendHtml}
                        
                        <input type="text" class="area-name-input" value="${item.area}" onchange="updateItem('${source}', ${index}, 'area', this.value)">
                        
                        <div class="price-wrapper">
                            ${nightBadgeHtml}
                            <input type="number" class="price-val-input" value="${displayPrice.toFixed(2)}" step="0.25" onchange="updateItem('${source}', ${index}, 'price', this.value)">
                        </div>
                        
                        <div class="card-tools">
                            <span style="font-size:12px; font-weight:bold; color:#64748b; margin-left:10px;">Ø¯.Ø£</span>
                            
                            <button class="mini-circle-btn btn-map" onclick="openMap('${item.area}', '${source}')" title="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">ğŸ“</button>
                            
                            <button class="mini-circle-btn btn-offer ${starClass}" onclick="toggleOffer('${source}', ${index})" title="ØªÙ…ÙŠÙŠØ² ÙƒØ¹Ø±Ø¶ Ø®Ø§Øµ">â­</button>
                            
                            <button class="mini-circle-btn" onclick="deleteItem('${source}', ${index})" style="color:var(--danger);" title="Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø·Ù‚Ø©">âœ•</button>
                        </div>
                    </div>
                `;
            });
        }

        window.updateItem = function(source, index, field, value) {
            if (field === 'price') {
                let newVal = parseFloat(value);
                // Ù„Ùˆ Ø§Ù„Ø­Ø§Ø±Ø³ Ø§Ù„Ù„ÙŠÙ„ÙŠ Ø´ØºØ§Ù„ ÙˆØ­Ø§ÙˆÙ„Øª ØªØ¹Ø¯Ù„ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³ÙŠØ³ØªÙ… Ø¨Ø®ØµÙ… 0.50 Ø¹Ø´Ø§Ù† ÙŠØ­ÙØ¸ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
                if (isNightActive) {
                    newVal -= 0.50; 
                }
                if (newVal < 0) newVal = 0;
                
                pricingData[source][index].price = newVal;
                pricingData[source][index].lastMod = Date.now();
            } else {
                pricingData[source][index][field] = value;
            }
            renderMatrix();
        }

        window.addArea = function() {
            const source = document.getElementById('source-select').value;
            if(!source) return;
            
            const name = prompt("Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ğŸ˜Š");
            if (name) {
                pricingData[source].push({ id: "PRC_" + Date.now() + Math.floor(Math.random()*1000), area: name, price: 0, isOffer: false, lastMod: Date.now() });
                renderMatrix();
            }
        }

        window.deleteItem = async function(source, index) {
            if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© ğŸ˜Š")) {
                const item = pricingData[source][index];
                if (item.id) {
                    await remove(ref(db, `prices/${item.id}`));
                }
                pricingData[source].splice(index, 1);
                renderMatrix();
            }
        }

        window.toggleOffer = function(source, index) {
            pricingData[source][index].isOffer = !pricingData[source][index].isOffer;
            renderMatrix();
        }

        window.openMap = function(area, source) {
            const query = encodeURIComponent(`${area} ${source} Jordan`);
            window.open(`http://googleusercontent.com/maps.google.com/search?q=${query}`, '_blank');
        }

        window.saveData = async function() {
            const btn = document.getElementById('save-btn');
            btn.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù„Ø­Ø§Ù… â³";
            btn.style.background = "#f59e0b";
            
            const myMaster = currentUser.Client_User || currentUser.user;
            
            try {
                // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ø´Ø±ÙƒØ© ÙÙ‚Ø·
                const snapshot = await get(ref(db, 'prices'));
                let dbPrices = [];
                if(snapshot.exists()) {
                    dbPrices = Object.values(snapshot.val()).filter(p => p.Client_Master === myMaster);
                }
                
                let currentIds = [];
                
                for (const source in pricingData) {
                    const promises = pricingData[source].map(item => {
                        if (!item.id) item.id = "PRC_" + Date.now() + Math.floor(Math.random()*1000);
                        currentIds.push(item.id);
                        
                        const payload = {
                            Price_ID: item.id,
                            Price_Source: source,
                            Price_Area: item.area,
                            Price_Base: item.price,
                            Price_Offer: item.isOffer ? 'true' : 'false',
                            Price_Date: new Date().toISOString(),
                            Client_Master: myMaster // Ø¯Ù…Ø¬ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø°ÙˆØ± Ø§Ù„ØªØ§Ø¨Ø¹Ø©
                        };

                        return set(ref(db, `prices/${item.id}`), payload);
                    });
                    
                    await Promise.all(promises);
                }
                
                const dbIds = dbPrices.map(p => p.Price_ID);
                const deletedIds = dbIds.filter(id => !currentIds.includes(id));
                
                const deletePromises = deletedIds.map(id => remove(ref(db, `prices/${id}`)));
                await Promise.all(deletePromises);
                
                btn.innerHTML = "ØªÙ… Ø§Ù„ØªØ¹Ù…ÙŠÙ… ğŸ“¡";
                btn.style.background = "#047857";
                setTimeout(() => {
                    btn.innerHTML = "ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±";
                    btn.style.background = "var(--success)";
                    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµÙÙˆÙØ© ÙˆØªØ«Ø¨ÙŠØªÙ‡Ø§ ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ø­Ø¯ÙŠØ¯ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ğŸ˜Š");
                }, 1500);
            } catch(e) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸ ÙŠØ§ Ø¨Ø·Ø© ğŸ˜Š");
                console.error(e);
                btn.innerHTML = "ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±";
                btn.style.background = "var(--success)";
            }
        }

    </script>
</body>
</html>
